__NUXT_JSONP__("/blog", (function(a){return {data:[{pages:{value:[{slug:"about-the-if-material-node-in-hlsl",description:"UEのマテリアルのIfノードは、HLSLにおいてはどのような形で実現されているのかのメモ",title:"マテリアルのIfノードはHLSLでどう展開されるのか",tags:["Unreal Engine","UE Material","UE Tips"],assets:"\u002Farticle-assets\u002Funrealengine\u002Fabout-the-if-material-node-in-hlsl",toc:[{id:"サンプルマテリアル",depth:2,text:"サンプルマテリアル"},{id:"生成された-hlsl-コードを見てみる",depth:2,text:"生成された HLSL コードを見てみる"},{id:"該当部の-hlsl-コード",depth:2,text:"該当部の HLSL コード"}],body:{type:"root",children:[{type:"element",tag:"h1",props:{id:"前提シェーダープログラムは分岐に弱いらしい"},children:[{type:"element",tag:"a",props:{href:"#%E5%89%8D%E6%8F%90%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AF%E5%88%86%E5%B2%90%E3%81%AB%E5%BC%B1%E3%81%84%E3%82%89%E3%81%97%E3%81%84",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"前提:シェーダープログラムは分岐に弱いらしい"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"シェーダープログラムは GPU で実行されます。GPU は CPU と比較すると、if などの命令パイプラインに分岐が入る命令が苦手なのは有名な話です。\n分岐が入ったプログラムでは、分岐の前後においてすべての実行コアが同じ命令を同じ時間実行していることが保証できなくなってしまい、SIMD のメリットを享受しにくくなってしまうためだと思います。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"マテリアルの-if-ノードが気になる"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB%E3%81%AE-if-%E3%83%8E%E3%83%BC%E3%83%89%E3%81%8C%E6%B0%97%E3%81%AB%E3%81%AA%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"マテリアルの If ノードが気になる"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UE のマテリアルノードはシェーダーコンパイルの過程でノード → usf (unreal shader file) → HLSL → ... と変換されていき、最終的に各プラットフォームで利用可能な形式になります。\nところで、UE のマテリアルには If ノードがあります。前述の通り、If はシェーダープログラムにおいてボトルネックになりやすいポイントらしいのですが、マテリアルノードで配置した If はシェーダーコード上ではどういった形式になるのでしょうか"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"サンプルマテリアル"},children:[{type:"element",tag:"a",props:{href:"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"サンプルマテリアル"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"今回は以下のようなマテリアルを対象として考えます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"sample material",src:"\u002Farticle-assets\u002Funrealengine\u002Fabout-the-if-material-node-in-hlsl\u002F\u002Fsample-material.jpg"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"極めて単純なマテリアルです。Base Color に If ノードを使った特に意味のない処理を接続しています。それ以外の値はデフォルト値のままです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"生成された-hlsl-コードを見てみる"},children:[{type:"element",tag:"a",props:{href:"#%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%81%9F-hlsl-%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E8%A6%8B%E3%81%A6%E3%81%BF%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"生成された HLSL コードを見てみる"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"マテリアルノードから生成された HLSL コードは、エディタの以下の位置から閲覧することができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"show hlsl",src:"\u002Farticle-assets\u002Funrealengine\u002Fabout-the-if-material-node-in-hlsl\u002F\u002Fshow-hlsl.jpg"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"code",src:"\u002Farticle-assets\u002Funrealengine\u002Fabout-the-if-material-node-in-hlsl\u002F\u002Fhlsl-code.jpg"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ただ、このウィンドウはコードを読むには表示上も機能上も全く適していないので、Copy ボタンからコードをコピーし、お好きなエディタ上で閲覧することをおすすめします。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"該当部の-hlsl-コード"},children:[{type:"element",tag:"a",props:{href:"#%E8%A9%B2%E5%BD%93%E9%83%A8%E3%81%AE-hlsl-%E3%82%B3%E3%83%BC%E3%83%89",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"該当部の HLSL コード"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"hoge"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-hlsl"]},children:[{type:"text",value:"void CalcPixelMaterialInputs(in out FMaterialPixelParameters Parameters, in out FPixelMaterialInputs PixelMaterialInputs)\n{\n    \u002F\u002F 略\n    MaterialFloat3 Local1 = ((abs(0.00000000 - 5.00000000) \u003E 0.00001000) ? (0.00000000 \u003E= 5.00000000 ? MaterialFloat3(1.00000000,0.00000000,0.00000000) : MaterialFloat3(0.00000000,0.00000000,1.00000000)) : MaterialFloat3(0.00000000,1.00000000,0.00000000));\n    \u002F\u002F 略\n    PixelMaterialInputs.BaseColor = Local1;\n    \u002F\u002F 略\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"省略しまくっていますが、今回の If ノードに対応する箇所は上記のコードのように実現されていました。見ると、素朴な条件演算子によって実現されていることがわかります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"一般的に、シェーダープログラムにおいては条件演算子のほうが通常の If 文よりも高速であると言われます。\nIf 文は命令の流れ自体を切り替えてしまう(真の分岐)のに対して、条件演算子は条件式と、値として返すために引数として取った式のすべてを先に評価し、条件式の値に基づいて返す値を選択するという処理になる(ことが多い)ためです。\nこれであれば、実際には命令パイプライン上での分岐は発生していないため、値を得るための演算コストが分岐処理のコストを上回らない限りにおいては条件演算子が高速に動作します。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"非常に曖昧な書き方をしましたが、これはコンパイラの最適化なども考慮に入れれば、GPU 上での処理とコードの記述が常にこのように対応するとは限らないためです。\n少なくとも、単純な式を扱う条件演算子は前述のような挙動をすると考えて良いと思います。逆に、コンパイラの賢さにもよりますが、内部が非常に単純な If 文であれば、真の分岐は行わずに両方の分岐先を実行した上で値を選択する可能性もあります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この辺りについては、OpenGL Wiki によい記述がありましたのでよければご参照ください。(英語)"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"a",props:{href:"https:\u002F\u002Fwww.khronos.org\u002Fopengl\u002Fwiki\u002FShader#Execution_model_and_divergence",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"ShaderExecution model and divergence - OpenGL Wiki"}]}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"まとめのようななにか"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%BE%E3%81%A8%E3%82%81%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E3%81%AA%E3%81%AB%E3%81%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"まとめのようななにか"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"処理速度の話はプラットフォームごとのアーキテクチャやコンパイラの賢さによって複雑な場合分けが発生するためなんとも言えませんが、マテリアルの If ノードは条件演算子に展開されるということだけはわかりました。"}]}]},dir:"\u002Farticles\u002Funrealengine",path:"\u002Farticles\u002Funrealengine\u002Fabout-the-if-material-node-in-hlsl",extension:".md",createdAt:"2022-02-13T13:41:25.000Z",updatedAt:"2022-02-13T13:41:25.000Z",gitCreatedAt:"2022-02-13T13:41:25.000Z",gitUpdatedAt:"2022-02-13T13:41:25.000Z"},{slug:"raytracing-on-a-material",description:"UEのマテリアルを使って、基本的な球のレイトレーシングを実装してみた記事",title:"UEのマテリアル上でレイトレーシングしてみた",tags:["Unreal Engine","UE Material"],assets:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material",toc:[{id:"レイトレーシングに使う座標系",depth:2,text:"レイトレーシングに使う座標系"},{id:"座標変換",depth:3,text:"座標変換"},{id:"レイを飛ばす始点と方向",depth:2,text:"レイを飛ばす始点と方向"},{id:"描画に必要な環境のパラメータを得る方法",depth:2,text:"描画に必要な環境のパラメータを得る方法"},{id:"球とレイの衝突判定",depth:2,text:"球とレイの衝突判定"},{id:"レイ",depth:2,text:"レイ"},{id:"球の衝突判定-custom-ノード",depth:2,text:"球の衝突判定 Custom ノード"},{id:"入力",depth:3,text:"入力"},{id:"出力",depth:3,text:"出力"},{id:"コード",depth:3,text:"コード"},{id:"衝突位置の関連値を計算",depth:2,text:"衝突位置の関連値を計算"},{id:"hit",depth:3,text:"Hit"},{id:"position",depth:3,text:"Position"},{id:"normal",depth:3,text:"Normal"},{id:"t-1",depth:3,text:"T"},{id:"簡易シェーディングマテリアルマテリアル関数",depth:2,text:"簡易シェーディングマテリアルマテリアル関数"},{id:"color",depth:3,text:"Color"},{id:"複数オブジェクトの描画",depth:2,text:"複数オブジェクトの描画"},{id:"実際に外部の環境情報を入力するマテリアル",depth:2,text:"実際に外部の環境情報を入力するマテリアル"}],body:{type:"root",children:[{type:"element",tag:"h1",props:{id:"はじめに"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"はじめに"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"次の画像を御覧ください。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"intro lit",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fintro-lit.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"4 つの球がワールド上に配置されている用に見えます。しかし、これを Unlit 表示にすると次のようになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"intro unlit",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fintro-unlit.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"何か不自然ですね。ではワイヤフレーム表示にしてみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"intro wireframe",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fintro-wireframe.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"なんと、色がついた 3 つの球はポリゴンによるものではなく、板ポリに適用されたマテリアルによって描画されたものでした。本物のポリゴンによる球は白だけだったのです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"趣旨"},children:[{type:"element",tag:"a",props:{href:"#%E8%B6%A3%E6%97%A8",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"趣旨"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UE のマテリアルだけを使って、簡易的な球のレイトレーシングを実装するサンプルを作ってみました。\nまた、UE のマテリアルで利用可能な機能を活用して、以下のようなことが実現されています。"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"マテリアル上に描画された空間が連続して見えるように、使用中の CameraActor 位置に基づいた描画を行う"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"SkyLight の位置に基づいた、周囲のオブジェクトから浮かない簡易的な陰影づけ"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"実際に動かしてみると、こんな感じです。"}]},{type:"text",value:"\n"},{type:"element",tag:"video",props:{controls:true,src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fmove.mp4"},children:[{type:"text",value:"move"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"完全にやってみたくてやった遊びなので実用性はあまりないですが、マテリアルのいろんな機能を使うサンプルとしては楽しいと思います。そんなに難しいことも出てきません。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"環境"},children:[{type:"element",tag:"a",props:{href:"#%E7%92%B0%E5%A2%83",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"環境"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"Engine Version: 5.0.0 Early Access 2"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"作成に用いる考えと準備"},children:[{type:"element",tag:"a",props:{href:"#%E4%BD%9C%E6%88%90%E3%81%AB%E7%94%A8%E3%81%84%E3%82%8B%E8%80%83%E3%81%88%E3%81%A8%E6%BA%96%E5%82%99",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"作成に用いる考えと準備"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"レイトレーシングに使う座標系"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%AC%E3%82%A4%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%AB%E4%BD%BF%E3%81%86%E5%BA%A7%E6%A8%99%E7%B3%BB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"レイトレーシングに使う座標系"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"レイトレーシングを行うには座標空間が必要です。今回は、マテリアルが適用されたオブジェクトの中心位置を、レイトレーシングで描画する内部座標系の原点"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"("}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]},{type:"element",tag:"mo",props:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]},{type:"element",tag:"mo",props:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:")"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"(0, 0, 0)"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tag:"span",props:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tag:"span",props:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:")"}]}]}]}]}]},{type:"text",value:"と決めました。\n(今後、レイトレーシングに使うマテリアル内部の空間の座標系のことは内部座標系と呼びます。)\nこれにより、マテリアルを適用したオブジェクトごとに異なる座標系上でレイトレーシングが行われることになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"座標変換"},children:[{type:"element",tag:"a",props:{href:"#%E5%BA%A7%E6%A8%99%E5%A4%89%E6%8F%9B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"座標変換"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"今回の実装では、内部座標系から見たら外側の、CameraActor の位置情報などをレイの生成に利用します。当然ですが、CameraActor などから取得できるのはワールド座標系での位置情報が原則です。この情報を内部座標系での処理に利用するには、ワールド座標系 → 内部座標系の座標変換が必要となります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここで対象とするの 2 つの座標系は、どちらも同じ大きさ(?)の直交座標系であるため、線形代数で登場するような座標変換の手法は必要ありません。原点位置をオフセットするような演算を行うだけでよく、これは減算で実現できます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"変換のために、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ToRTSpace"}]},{type:"text",value:"というマテリアル関数を作成しました。ここで、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"TargetPosition"}]},{type:"text",value:"はワールド座標系上の変換元の点、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ObjectOrigin"}]},{type:"text",value:"は今回の内部座標系の基準とする、ワールド座標系上でのオブジェクトの原点です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"to rtspace",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fto-rt-space.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"今後、ワールド座標系 → 内部座標系の値の受け渡しで変換が必要なときに利用します。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"レイを飛ばす始点と方向"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%AC%E3%82%A4%E3%82%92%E9%A3%9B%E3%81%B0%E3%81%99%E5%A7%8B%E7%82%B9%E3%81%A8%E6%96%B9%E5%90%91",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"レイを飛ばす始点と方向"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"レイトレーシングを行うためには、レイを飛ばさなければなりません。今回は image-order なレイトレーシングを考えるため、カメラ位置から、描画されるピクセル一つ一つに向かうようなレイを生成します。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"すると、レイの始点はカメラ位置（ワールド座標系から内部座標系に変換されたもの）となり、レイの方向は「カメラ位置 → マテリアルが適用されたオブジェクト表面上の点位置」とできます。\nこの方向ベクトルはまたしても減算で手に入れることができます。得られた方向ベクトルは後々のために正規化しておきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"レイの方向を得る処理は、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"CreateRayDirection"}]},{type:"text",value:"というマテリアル関数に記述しました。ここで、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"AbsoluteWorldPosition"}]},{type:"text",value:"はマテリアルが適用されたオブジェクトの表面上の点、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"CameraPosition"}]},{type:"text",value:"はカメラ位置です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"create ray direction",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fcreate-ray-direction.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"レイの始点を得る処理は、カメラ位置がそのまま始点と対応するため記述の必要がありません。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"描画に必要な環境のパラメータを得る方法"},children:[{type:"element",tag:"a",props:{href:"#%E6%8F%8F%E7%94%BB%E3%81%AB%E5%BF%85%E8%A6%81%E3%81%AA%E7%92%B0%E5%A2%83%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E5%BE%97%E3%82%8B%E6%96%B9%E6%B3%95",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"描画に必要な環境のパラメータを得る方法"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"カメラ位置やライト情報に基づいた描画をするには、それらの位置を取得せねばなりません。また、座標系構築のためにはマテリアルを適用したオブジェクトの中心位置が必要ですし、レイの射出方向を決めるにはそのオブジェクトの描画された表面上の任意の点の位置も必要です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これらはすべて、UE の Material に標準で用意されているノードから取得することができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"bulitin nodes",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fbuiltin-nodes.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"詳細は検索すれば出てくるので割愛するとして、概要を示します。"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"camera-position"},children:[{type:"element",tag:"a",props:{href:"#camera-position",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Camera Position"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"現在の Viewport の視点となっているカメラのワールド座標系における位置を取得できるノード。"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"skyatmospherelightdirection"},children:[{type:"element",tag:"a",props:{href:"#skyatmospherelightdirection",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"SkyAtmosphereLightDirection"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"レベル上の DirectionalLight の方向ベクトルを取得できるノード。DirectionalLight は無限遠からの平行光線を想定した光源なので、位置に意味がなく、方向のみが取得できる。\n今回の描画はこのライト情報に基づく。取得ライトのインデックスは、DirectionalLight の Atmosphere Sun Light Index プロパティと対応する。"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"object-position"},children:[{type:"element",tag:"a",props:{href:"#object-position",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Object Position"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"レベルに配置されたオブジェクトのバウンディングボックスから、その中心位置をワールド座標系に基づいて取得できるノード。"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"absolute-world-position-world-position"},children:[{type:"element",tag:"a",props:{href:"#absolute-world-position-world-position",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Absolute World Position (World Position)"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"オブジェクトの表面上の任意の点の、ワールド座標系での位置を取得できるノード。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"球とレイの衝突判定"},children:[{type:"element",tag:"a",props:{href:"#%E7%90%83%E3%81%A8%E3%83%AC%E3%82%A4%E3%81%AE%E8%A1%9D%E7%AA%81%E5%88%A4%E5%AE%9A",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"球とレイの衝突判定"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"球とレイの衝突判定について詳説するには数学的な解説が必要となりますが、すでに先行する多くの有用な資料がありますので、ここでは詳説せず、経過のみを述べます。参考になりそうな資料のリンクを貼っておきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"element",tag:"a",props:{href:"https:\u002F\u002Fweb.wakayama-u.ac.jp\u002F~tokoi\u002Flecture\u002Fcg\u002Fcgnote14.pdf",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"和歌山大学 コンピュータグラフィックス講義資料"}]}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"element",tag:"a",props:{href:"https:\u002F\u002Fknzw.tech\u002Fraytracing\u002F?page_id=78",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"東京電機大学 工学部第二部情報通信工学実験　グラフィックス応用テキスト"}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"球は、その中心点と半径の 2 つのパラメータによって位置と形状を決定できます。これは、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]}]},{type:"text",value:"を球面上の任意の点、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{c}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.714em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:"を球の中心点、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"r"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.43056em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"r"}]}]}]}]}]},{type:"text",value:"を半径としたとき、以下の式で記述できることを示します。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{mathvariant:"normal"},children:[{type:"text",value:"∥"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mi",props:{mathvariant:"normal"},children:[{type:"text",value:"∥"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\|\\vec{p} - \\vec{c}\\| = r"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"∥"}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"∥"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.43056em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"r"}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]}]},{type:"text",value:"は球面上の任意の点なので、この点がレイの線上のどこかの点と共有できるならば、球とレイが衝突したことになります。\n共有する点が存在するかどうかは、単純に球のベクトル方程式にレイの方程式を代入して、レイの方程式に登場した"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"について解けば良いです。すると二次方程式になるので、二次方程式の解の公式に従って変形すると、以下のようになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{style:"display: flex; inline-size: 100%; justify-content: center; flex-wrap: wrap"},children:[{type:"text",value:"\n"},{type:"element",tag:"div",props:{style:"margin: 0 25px"},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"A"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"d"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⋅"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"d"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"A = \\vec{d} \\cdot \\vec{d}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"A"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9774399999999999em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"d"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.06882999999999997em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"⋅"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9774399999999999em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"d"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.06882999999999997em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:" "},{type:"element",tag:"br",props:{},children:[]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"B"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"d"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⋅"}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"("}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:")"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"B = \\vec{d} \\cdot (\\vec{s} - \\vec{c})"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9774399999999999em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"d"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.06882999999999997em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"⋅"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"s"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:")"}]}]}]}]}]},{type:"text",value:" "},{type:"element",tag:"br",props:{},children:[]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"C"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"("}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:")"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⋅"}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"("}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:")"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"msup",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"2"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"C = (\\vec{s} - \\vec{c}) \\cdot (\\vec{s} - \\vec{c}) - r^2"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.07153em;"},children:[{type:"text",value:"C"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"s"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"⋅"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"s"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.8141079999999999em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"r"}]},{type:"element",tag:"span",props:{className:["msupsub"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.8141079999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3.063em;margin-right:0.05em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:2.7em;"},children:[]},{type:"element",tag:"span",props:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mtight"]},children:[{type:"text",value:"2"}]}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{style:"margin: 0 25px"},children:[{type:"text",value:"\n"},{type:"element",tag:"br",props:{},children:[]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mfrac",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"B"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"±"}]},{type:"element",tag:"msqrt",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"msup",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"B"}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"2"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"A"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"C"}]}]}]}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"A"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t = \\frac{-B \\pm \\sqrt{B^2 - AC}}{A}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:2.276389em;vertical-align:-0.686em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mopen","nulldelimiter"]},children:[]},{type:"element",tag:"span",props:{className:["mfrac"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:1.590389em;"},children:[{type:"element",tag:"span",props:{style:"top:-2.314em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"A"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.23em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["frac-line"],style:"border-bottom-width:0.04em;"},children:[]}]},{type:"element",tag:"span",props:{style:"top:-3.677em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"±"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","sqrt"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.913389em;"},children:[{type:"element",tag:"span",props:{className:["svg-align"],style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"],style:"padding-left:0.833em;"},children:[{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]},{type:"element",tag:"span",props:{className:["msupsub"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.740108em;"},children:[{type:"element",tag:"span",props:{style:"top:-2.9890000000000003em;margin-right:0.05em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:2.7em;"},children:[]},{type:"element",tag:"span",props:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mtight"]},children:[{type:"text",value:"2"}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"A"}]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.07153em;"},children:[{type:"text",value:"C"}]}]}]},{type:"element",tag:"span",props:{style:"top:-2.873389em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["hide-tail"],style:"min-width:0.853em;height:1.08em;"},children:[{type:"element",tag:"svg",props:{width:"400em",height:"1.08em",viewBox:"0 0 400000 1080",preserveAspectRatio:"xMinYMin slice"},children:[{type:"element",tag:"path",props:{d:"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z"},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.12661100000000003em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.686em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mclose","nulldelimiter"]},children:[]}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"br",props:{},children:[]},{type:"text",value:"\n"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここで、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"について解いたの式の、ルートの内部に注目します。この式はルートの中に入っているため、値が負になってしまうと実数に解を持たなくなります。複素数の位置など登場しませんので、レイ上と球面上に共有する点はないとみなしてよいことになります。よって、ルート内の式の値を見て、それが"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"0"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]}]}]}]}]},{type:"text",value:"以上であるかを確認するだでレイが球と衝突したかどうかを判別できることになります。これを判別式"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"D"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"D"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"D"}]}]}]}]}]},{type:"text",value:"とします。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"D"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"msup",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"B"}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"2"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"A"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"C"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"D = B^2 - AC"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"D"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9474379999999999em;vertical-align:-0.08333em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]},{type:"element",tag:"span",props:{className:["msupsub"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.8641079999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3.113em;margin-right:0.05em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:2.7em;"},children:[]},{type:"element",tag:"span",props:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mtight"]},children:[{type:"text",value:"2"}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.68333em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"A"}]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.07153em;"},children:[{type:"text",value:"C"}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この判別式が"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"0"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]}]}]}]}]},{type:"text",value:"以上であった場合のみ、衝突位置の計算などを行います。衝突位置は、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"について解いた式に衝突時のパラメータを代入し、求まった"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"を元にレイのベクトル方程式から"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]}]},{type:"text",value:"を求めればよいです。このとき、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"を求めるのに使う式の"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mo",props:{},children:[{type:"text",value:"±"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\pm"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"±"}]}]}]}]}]},{type:"text",value:"を"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"-"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.66666em;vertical-align:-0.08333em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"−"}]}]}]}]}]},{type:"text",value:"に変更していますが、これはレイの始点から見て近いほうの共有点さえわかれば良いためです。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"+"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"d"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"+"}]},{type:"element",tag:"mfrac",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"B"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"msqrt",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"D"}]}]}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"A"}]}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"d"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"("}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"D"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"≥"}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:")"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p} = \\vec{s} + t\\vec{d} = \\vec{s} + \\frac{-B-\\sqrt{D}}{A} \\vec{d} \\;\\;\\; (D \\geq 0)"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.79733em;vertical-align:-0.08333em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"s"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"+"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9774399999999999em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"d"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.06882999999999997em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.79733em;vertical-align:-0.08333em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"s"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"+"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:2.2896650000000003em;vertical-align:-0.686em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mopen","nulldelimiter"]},children:[]},{type:"element",tag:"span",props:{className:["mfrac"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:1.6036650000000001em;"},children:[{type:"element",tag:"span",props:{style:"top:-2.314em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"A"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.23em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["frac-line"],style:"border-bottom-width:0.04em;"},children:[]}]},{type:"element",tag:"span",props:{style:"top:-3.6770000000000005em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.05017em;"},children:[{type:"text",value:"B"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","sqrt"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9266650000000001em;"},children:[{type:"element",tag:"span",props:{className:["svg-align"],style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"],style:"padding-left:0.833em;"},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"D"}]}]}]},{type:"element",tag:"span",props:{style:"top:-2.886665em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["hide-tail"],style:"min-width:0.853em;height:1.08em;"},children:[{type:"element",tag:"svg",props:{width:"400em",height:"1.08em",viewBox:"0 0 400000 1080",preserveAspectRatio:"xMinYMin slice"},children:[{type:"element",tag:"path",props:{d:"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z"},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.11333499999999996em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.686em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mclose","nulldelimiter"]},children:[]}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"d"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.06882999999999997em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"D"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"≥"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:")"}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"実際に作成する"},children:[{type:"element",tag:"a",props:{href:"#%E5%AE%9F%E9%9A%9B%E3%81%AB%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"実際に作成する"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"レイ"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%AC%E3%82%A4",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"レイ"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"レイを作成します。準備していおいたものを組み合わせて、以下のように記述できます。\n"},{type:"element",tag:"img",props:{alt:"make ray",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fmake-ray.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"ToRTSpace"}]},{type:"text",value:"で"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Camera Position"}]},{type:"text",value:"から取得したカメラのグローバル座標系上の位置を内部座標系の位置に変換し、Ray の始点の位置ベクトルを作成します。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"CreateRayDirection"}]},{type:"text",value:"で、カメラ位置とオブジェクトの表面上の点の位置から、Ray の方向ベクトルを作成します。この方向ベクトルはカメラとオブジェクト上の点の相対的な位置に基づいており、グローバル座標系と内部座標系は基底が同じスケールの直交座標系であることから、座標変換を行わなくても適切な方向ベクトルを作成できます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これで、レイを記述する以下の式が利用できます。\n"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]}]},{type:"text",value:"がレイの線上で取り得る任意の点、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{s}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.714em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"s"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:"がレイの始点、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"d"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{d}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9774399999999999em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"d"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.06882999999999997em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:"がレイの方向です。\n"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"がパラメータとして変化することで、レイの線上の任意の点を指し示すことができるということです。\nまた、レイは視線と逆方向に飛ばしても意味がないので、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"\u003E"}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t \u003E 0"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.65418em;vertical-align:-0.0391em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"\u003E"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.64444em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]}]}]}]}]},{type:"text",value:"とします。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"+"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"d"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"("}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"\u003E"}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:")"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p} = \\vec{s} + t\\vec{d} \\;\\;\\; (t \u003E 0)"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.79733em;vertical-align:-0.08333em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"s"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"+"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1.2274399999999999em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"d"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.06882999999999997em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"\u003E"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:")"}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"球の衝突判定-custom-ノード"},children:[{type:"element",tag:"a",props:{href:"#%E7%90%83%E3%81%AE%E8%A1%9D%E7%AA%81%E5%88%A4%E5%AE%9A-custom-%E3%83%8E%E3%83%BC%E3%83%89",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"球の衝突判定 Custom ノード"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"衝突判定くらいの複雑度をもつ処理になってくると、ノードで書いた際の可読性の低下が著しくなってきます。ここでは Custom ノードを用いて HLSL コードとして記述していくことにします。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"Custom ノードは以下のようなインターフェイスとしました。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"hit sphere custom",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fhit-sphere-custom.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"入力"},children:[{type:"element",tag:"a",props:{href:"#%E5%85%A5%E5%8A%9B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"入力"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"rayorigin"},children:[{type:"element",tag:"a",props:{href:"#rayorigin",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"RayOrigin"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"判定を行うレイの始点を示す位置ベクトル"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"raydirection"},children:[{type:"element",tag:"a",props:{href:"#raydirection",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"RayDirection"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"判定を行うレイの方向ベクトル"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"tmax"},children:[{type:"element",tag:"a",props:{href:"#tmax",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"TMax"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"レイのベクトル方程式に登場した変数"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"が取り得る最大の値。\n"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"が大きくなると、レイの式はより遠くの点を示すようになります。逆に、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"TMax"}]},{type:"text",value:"で"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"の最大値を制限すると、それよりも遠方にある衝突点には衝突しないようにすることができます。これは、一直線上に複数のオブジェクトが存在している際の、重なり処理を行うために導入しています。"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"center"},children:[{type:"element",tag:"a",props:{href:"#center",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Center"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"球の中心点"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"radius"},children:[{type:"element",tag:"a",props:{href:"#radius",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Radius"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"球の半径"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"出力"},children:[{type:"element",tag:"a",props:{href:"#%E5%87%BA%E5%8A%9B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"出力"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"return"},children:[{type:"element",tag:"a",props:{href:"#return",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"return"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"衝突判定を 0\u002F1 で表す\nCustom ノードはデフォルト戻り値の名称を変更できないためわかりにくくなっています。"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"t"},children:[{type:"element",tag:"a",props:{href:"#t",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"T"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"衝突した場合、衝突したポイントでのレイの方程式の"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"の値を返す。衝突しなかった場合、入力の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"TMax"}]},{type:"text",value:"の値をそのまま出力する。\nこの出力を次回以降の同一レイの衝突判定では"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"TMax"}]},{type:"text",value:"として使うことで、同一レイの線上に異なる物体が発見されたとしても、より近い場所になければ判定を無視することが可能になります。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"コード"},children:[{type:"element",tag:"a",props:{href:"#%E3%82%B3%E3%83%BC%E3%83%89",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"コード"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"HLSL によるコードはとても短いです。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"HitSphere"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-hlsl"]},children:[{type:"text",value:"float3 OC = RayOrigin - Center;\n\nfloat A = dot(RayDirection, RayDirection);\nfloat B = dot(RayDirection, OC);\nfloat C = dot(OC, OC) - pow(Radius, 2);\nfloat D = pow(B, 2) - A*C;\n\nif (D \u003E= 0) {\n  float curT = (-B - sqrt(D)) \u002F A;\n  if (curT \u003E 0 && curT \u003C TMax) {\n    T = curT;\n    return 1;\n  }\n}\n\nT = TMax;\nreturn  0;"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"衝突位置の関連値を計算"},children:[{type:"element",tag:"a",props:{href:"#%E8%A1%9D%E7%AA%81%E4%BD%8D%E7%BD%AE%E3%81%AE%E9%96%A2%E9%80%A3%E5%80%A4%E3%82%92%E8%A8%88%E7%AE%97",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"衝突位置の関連値を計算"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ひとつ上で作成した衝突判定を包む形で、関連する値を計算します。ここでは、内部座標系における衝突位置、衝突位置での球面の法線などを求めます。簡単な計算ですので、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Sphere"}]},{type:"text",value:"というマテリアル関数にノードで実装しています。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"sphere mat func",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fsphere-mat-func.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"以下で各値の求め方を記載します。ノードはこれに対応しているだけです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"hit"},children:[{type:"element",tag:"a",props:{href:"#hit",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Hit"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"衝突判定関数の戻り値をそのまま使っているだけです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"position"},children:[{type:"element",tag:"a",props:{href:"#position",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Position"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"衝突判定関数から得られた、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"T"}]},{type:"text",value:"のパラメータをレイの方程式に代入することで、衝突位置を得ることができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"+"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"d"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mtext",props:{},children:[{type:"text",value:"  "}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"("}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"\u003E"}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:")"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p} = \\vec{s} + t\\vec{d} \\;\\;\\; (t \u003E 0)"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.79733em;vertical-align:-0.08333em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"s"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"+"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1.2274399999999999em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"d"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.06882999999999997em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"\u003E"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:")"}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"normal"},children:[{type:"element",tag:"a",props:{href:"#normal",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Normal"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"球面上のレイ衝突点の法線ベクトルです。\n法線は面に対して垂直な直線ですから、球の場合には球の中心から球面上の点に向かうベクトルはすべて、その点での法線と同じ方向のベクトルとなります。\n正規化もしておきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"n"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mfrac",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{mathvariant:"normal"},children:[{type:"text",value:"∥"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mi",props:{mathvariant:"normal"},children:[{type:"text",value:"∥"}]}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{n} = \\frac{\\vec{p} - \\vec{c}}{\\|\\vec{p} - \\vec{c}\\|}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.714em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"n"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.2355em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:2.327em;vertical-align:-0.936em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mopen","nulldelimiter"]},children:[]},{type:"element",tag:"span",props:{className:["mfrac"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:1.391em;"},children:[{type:"element",tag:"span",props:{style:"top:-2.314em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"∥"}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"∥"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.23em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["frac-line"],style:"border-bottom-width:0.04em;"},children:[]}]},{type:"element",tag:"span",props:{style:"top:-3.677em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.936em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mclose","nulldelimiter"]},children:[]}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"t-1"},children:[{type:"element",tag:"a",props:{href:"#t-1",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"T"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これも衝突判定関数の戻り値をそのまま使っているだけです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"簡易シェーディングマテリアルマテリアル関数"},children:[{type:"element",tag:"a",props:{href:"#%E7%B0%A1%E6%98%93%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB%E9%96%A2%E6%95%B0",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"簡易シェーディングマテリアルマテリアル関数"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここまで作成したもので、ある視点から見たときの球の形状は判定できるようになりました。ここでは球のシェーディングマテリアルを作成していきます。\nシェーディングは二次的なレイのトレースによるものが望ましいですが、今回はライト方向と法線の内積を用いた簡易的なものにしました。\nきちんとしたレイトレースによる色付けを考える場合にはノードだと（主に繰り返し処理が）厳しいので、もっと広範囲を HLSL で記述したほうが良いと思いますが、今回は趣旨と外れるのでやめておきました。\n以下がシェーディング用の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"DotShading"}]},{type:"text",value:"マテリアル関数です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"dot shading",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fdot-shading.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"color"},children:[{type:"element",tag:"a",props:{href:"#color",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Color"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここでは、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"l"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{l}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9774399999999999em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.01968em;"},children:[{type:"text",value:"l"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:"をライト方向として導入します。また、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"msub",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"P"}]},{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"b"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"a"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"e"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"o"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"l"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"o"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"P_\\mathit{basecolor}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.83333em;vertical-align:-0.15em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.13889em;"},children:[{type:"text",value:"P"}]},{type:"element",tag:"span",props:{className:["msupsub"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.33610799999999996em;"},children:[{type:"element",tag:"span",props:{style:"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:2.7em;"},children:[]},{type:"element",tag:"span",props:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"b"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"a"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"s"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"e"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"c"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"o"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"l"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"o"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"r"}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.15em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]}]}]},{type:"text",value:"はその点を塗るベースカラーです。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"msub",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"P"}]},{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"o"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"l"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"o"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"("}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"l"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⋅"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"n"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:")"}]},{type:"element",tag:"msub",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"P"}]},{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"b"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"a"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"s"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"e"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"o"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"l"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"o"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"P_\\mathit{color} = (\\vec{l} \\cdot \\vec{n}) P_\\mathit{basecolor}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.83333em;vertical-align:-0.15em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.13889em;"},children:[{type:"text",value:"P"}]},{type:"element",tag:"span",props:{className:["msupsub"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.33610799999999996em;"},children:[{type:"element",tag:"span",props:{style:"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:2.7em;"},children:[]},{type:"element",tag:"span",props:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"c"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"o"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"l"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"o"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"r"}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.15em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1.2274399999999999em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.9774399999999999em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.01968em;"},children:[{type:"text",value:"l"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3.26344em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"⋅"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"n"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.2355em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.13889em;"},children:[{type:"text",value:"P"}]},{type:"element",tag:"span",props:{className:["msupsub"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.33610799999999996em;"},children:[{type:"element",tag:"span",props:{style:"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:2.7em;"},children:[]},{type:"element",tag:"span",props:{className:["sizing","reset-size6","size3","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mtight"]},children:[{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"b"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"a"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"s"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"e"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"c"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"o"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"l"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"o"}]},{type:"element",tag:"span",props:{className:["mord","mathit","mtight"]},children:[{type:"text",value:"r"}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.15em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ただし、ノード上では陰影の濃度の調整のために少し処理を追加しています。"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Add"}]},{type:"text",value:"で乗算する内積値の下限を底上げしているだけですが、そのままでは内積値が負の値を持ってしまう特性で意味がなくなってしまうので、事前に"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"saturate"}]},{type:"text",value:"しています。\n"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"saturate"}]},{type:"text",value:"は現代の GPU ではノーコストで実行できるので、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"["}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"0"}]},{type:"element",tag:"mo",props:{separator:"true"},children:[{type:"text",value:","}]},{type:"element",tag:"mn",props:{},children:[{type:"text",value:"1"}]},{type:"element",tag:"mo",props:{stretchy:"false"},children:[{type:"text",value:"]"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"[0, 1]"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mopen"]},children:[{type:"text",value:"["}]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"0"}]},{type:"element",tag:"span",props:{className:["mpunct"]},children:[{type:"text",value:","}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.16666666666666666em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"1"}]},{type:"element",tag:"span",props:{className:["mclose"]},children:[{type:"text",value:"]"}]}]}]}]}]},{type:"text",value:"へのクランプでは"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"clamp"}]},{type:"text",value:"よりおすすめです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"複数オブジェクトの描画"},children:[{type:"element",tag:"a",props:{href:"#%E8%A4%87%E6%95%B0%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E6%8F%8F%E7%94%BB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"複数オブジェクトの描画"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"先ほど作成した球の描画マテリアル関数を使えば、もう単一の球を描画することができます。しかし、せっかくなので複数のオブジェクトを描画できるようにしたいです。複数オブジェクト描画用のマテリアル関数を考えていきます。このマテリアル関数は"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Render"}]},{type:"text",value:"という名称とします。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"render mat func",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Frender-mat-func.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この関数はここまでの作業の集大成となっています。処理の流れは以下のようなものです。"}]},{type:"text",value:"\n"},{type:"element",tag:"ol",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"レイ情報("},{type:"element",tag:"code",props:{},children:[{type:"text",value:"RayOrigin"}]},{type:"text",value:", "},{type:"element",tag:"code",props:{},children:[{type:"text",value:"RayDirection"}]},{type:"text",value:")、ライト方向("},{type:"element",tag:"code",props:{},children:[{type:"text",value:"LightDirection"}]},{type:"text",value:")、レイの"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"値の初期値("},{type:"element",tag:"code",props:{},children:[{type:"text",value:"TMax"}]},{type:"text",value:")を入力として受け取る。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"Sphere"}]},{type:"text",value:"関数で球の衝突判定をする。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"DotShading"}]},{type:"text",value:"関数でシェーディングを行い、色を決定する。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"以上の処理を 1 単位としてカスケード接続し、衝突判定結果に応じて色とノーマルを"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Lerp"}]},{type:"text",value:"で合成、全体でのオブジェクトの衝突位置を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Add"}]},{type:"text",value:"で統合する。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"描画全体の衝突判定結果を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Hit"}]},{type:"text",value:"、描画結果を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Color"}]},{type:"text",value:"、ノーマルの描画結果を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Normal"}]},{type:"text",value:"、この描画を通して得られたレイの最短衝突位置(を導ける変数)である"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"t"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"t"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.61508em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"t"}]}]}]}]}]},{type:"text",value:"を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"T"}]},{type:"text",value:"として出力する。"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"実際に外部の環境情報を入力するマテリアル"},children:[{type:"element",tag:"a",props:{href:"#%E5%AE%9F%E9%9A%9B%E3%81%AB%E5%A4%96%E9%83%A8%E3%81%AE%E7%92%B0%E5%A2%83%E6%83%85%E5%A0%B1%E3%82%92%E5%85%A5%E5%8A%9B%E3%81%99%E3%82%8B%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"実際に外部の環境情報を入力するマテリアル"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここまでの処理はみなマテリアル関数として記述してきましたが、すでにレイトレースに必要な処理は出揃ったので、実際にオブジェクトに適用するマテリアルを作成します。このマテリアルでは、実際のライト方向やカメラ位置などの環境情報を入力します。マテリアル名は"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"RayTracing"}]},{type:"text",value:"としました。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"raytracing mat",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fraytracing-mat.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"このマテリアルでの描画はマテリアルによって実装されているので、エンジンが持っているライティングによってシェーディングを受ける必要はありません。\nそのため、マテリアルの Shading Model は"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Unlit"}]},{type:"text",value:"にしてあります。\nまた、Blend Mode を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Masked"}]},{type:"text",value:"とし、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Render"}]},{type:"text",value:"マテリアル関数の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Hit"}]},{type:"text",value:"出力を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Opacity Mask"}]},{type:"text",value:"に入力してみました。これによって、衝突が検出されなかった場所はマスクされることになり、あたかもレイトレースで描画したオブジェクトがそこに存在するかのように見せることができます。\nその他、ノードの接続については、ここまでで解説したものを適切につなげているだけです。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"以下はマテリアルエディタ上の View で板ポリに描画された"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Raytracing"}]},{type:"text",value:"マテリアルです。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"result view",src:"\u002Farticle-assets\u002Funrealengine\u002Fraytracing-on-a-material\u002F\u002Fresult-view.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"3 つの球があります！(板です)"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"まとめ"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%BE%E3%81%A8%E3%82%81",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"まとめ"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"こうして作成されたマテリアルをそこらのメッシュに適用すれば、そのメッシュの輪郭の内側をスクリーンとして、実装したレイトレースによるオブジェクトを描画できます。\nどのように見えるかは、記事冒頭の動画をご参照ください。\n使いみちは不明ですが、UE のマテリアルの機能を色々使えて楽しいです。おわりです。"}]}]},dir:"\u002Farticles\u002Funrealengine",path:"\u002Farticles\u002Funrealengine\u002Fraytracing-on-a-material",extension:".md",createdAt:"2022-01-31T07:18:53.000Z",updatedAt:"2022-01-31T11:01:13.000Z",gitCreatedAt:"2022-01-31T07:18:53.000Z",gitUpdatedAt:"2022-01-31T11:01:13.000Z"},{slug:"draw-rectangles-lines-on-uv-coords",description:"UEのマテリアルを使って、UV座標上に図形を描画するメモ",title:"マテリアルでUV座標上に図形を描く",tags:["Unreal Engine","UE Material"],assets:"\u002Farticle-assets\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords",toc:[{id:"uv-座標から長方形マスクを作成する",depth:2,text:"UV 座標から長方形マスクを作成する"},{id:"色付き長方形を作成する",depth:2,text:"色付き長方形を作成する"},{id:"使ってみる",depth:2,text:"使ってみる"},{id:"円の数学的な表示",depth:2,text:"円の数学的な表示"},{id:"円のマスクを描画する",depth:2,text:"円のマスクを描画する"},{id:"色付き円を作成する",depth:2,text:"色付き円を作成する"}],body:{type:"root",children:[{type:"element",tag:"h1",props:{id:"趣旨"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E8%B6%A3%E6%97%A8",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"趣旨"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UV 座標空間に長方形とかの図形を描くマテリアルを遊びで作ったのでメモとして記事にしておきます。以下のようなことになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"video",props:{controls:true,src:"\u002Farticle-assets\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords\u002F\u002Frectangles.mp4"},children:[{type:"text",value:"draw-rect-mask-internal"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"環境"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E7%92%B0%E5%A2%83",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"環境"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"Engine Version: 5.0.0 Early Access 2"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"長方形"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E9%95%B7%E6%96%B9%E5%BD%A2",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"長方形"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"uv-座標から長方形マスクを作成する"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#uv-%E5%BA%A7%E6%A8%99%E3%81%8B%E3%82%89%E9%95%B7%E6%96%B9%E5%BD%A2%E3%83%9E%E3%82%B9%E3%82%AF%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"UV 座標から長方形マスクを作成する"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"まず、以下のような Material Function を作成しました。Custom ノード内部の内部で各ピクセルの UV 座標に基づいて長方形の内外を判定し、マスクを作成しています。\n"},{type:"element",tag:"img",props:{alt:"draw-rect-mask-internal.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords\u002F\u002Fdraw-rect-mask-internal.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"Custom Nodeのコード"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-hlsl"]},children:[{type:"text",value:"float range = abs(UVs.x - 0.5 + Offset.x);\nfloat half_w = Width \u002F 2;\n\nfloat ubGrad = (0.5 - abs(UVs.y - 0.5 + Offset.y)) * 2;\nfloat mask = int((ubGrad - CutOut*2) + 0.999999);\n\nfloat lineBase = 1-int(range - half_w + 0.999999);\n\nreturn mask * lineBase;"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"シェーダーにおいては、if などによる分岐命令パイプライン上で分岐が発生する機能を使用すると大きな性能低下が見られるため、if を用いない形で記述しています。\nそのため少しわかりにくくなっていますが、やっていることは"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Width"}]},{type:"text",value:"の幅を持ち、上下を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"CutOut"}]},{type:"text",value:"の大きさだけカットされ、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Offset"}]},{type:"text",value:"分描画位置をオフセットされた長方形を想定し、該当ピクセルに対応する UV 座標がその内側か外側かを判定しているだけです。これだけで、長方形のマスクを作成することができます。\n(ノードを見ると CustomRotator による入力 UV の回転を行い、長方形を回転させる機能が入っていますが、汎用性のために入れただけで今回は使っていません)"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"しかし、このパラメータだとすこし使いにくいので、より長方形マスクを作成することに特化したマテリアル関数でラップします。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"draw-rect-mask.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords\u002F\u002Fdraw-rect-mask.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"こちらは極めて単純です。先程のマテリアル関数の入力パラメータを"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"UVs"}]},{type:"text",value:" "},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Width"}]},{type:"text",value:" "},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Height"}]},{type:"text",value:" "},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Left"}]},{type:"text",value:" "},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Top"}]},{type:"text",value:" という扱いやすいものにするための前処理を加えただけです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"色付き長方形を作成する"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E8%89%B2%E4%BB%98%E3%81%8D%E9%95%B7%E6%96%B9%E5%BD%A2%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"色付き長方形を作成する"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"せっかくですので、長方形マスクだけでなく、透明度と色を持った長方形を描画するマテリアル関数も作ってみましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"draw-color-rect.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords\u002F\u002Fdraw-color-rect.png"},children:[]},{type:"text",value:"\nこのネットワークでは、先ほど作成した長方形マスク関数を元に、長方形の色と背景の色を透明度付きで指定できるようにしています。\nこれで位置・サイズ・色が指定可能な長方形が作れたので、これを素材に何かを生成するなり、テクスチャに合成するなりして自由に使うことができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"使ってみる"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"使ってみる"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"今回はテストですので、テクスチャに対して異なる色・透明度を持つ複数の正方形をアルファブレンドするサンプル(冒頭に示していたもの)を作成しました。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"final-node.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords\u002F\u002Ffinal-node.png"},children:[]},{type:"text",value:"\nこちらがサンプルのネットワークです。(動きをつけている部分は今回の本質ではないので入れていません)"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"すると、冒頭に示したこちらの動画のように、テクスチャが配置された UV 座標に基づいて長方形の描画ができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"円"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E5%86%86",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"円"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"今度は円を描画してみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"円の数学的な表示"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E5%86%86%E3%81%AE%E6%95%B0%E5%AD%A6%E7%9A%84%E3%81%AA%E8%A1%A8%E7%A4%BA",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"円の数学的な表示"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"円はベクトルとして表すと、以下のようになります。\nここで、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]}]},{type:"text",value:"は円周上の任意の点、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{c}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.714em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:"は円の中心、"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"r"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.43056em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"r"}]}]}]}]}]},{type:"text",value:"は半径です。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{mathvariant:"normal"},children:[{type:"text",value:"∥"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mi",props:{mathvariant:"normal"},children:[{type:"text",value:"∥"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"="}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\|\\vec{p}-\\vec{c}\\| = r"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"∥"}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"∥"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"="}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.43056em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"r"}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これは"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{p}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.9084399999999999em;vertical-align:-0.19444em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]}]}]}]}]},{type:"text",value:"と"},{type:"element",tag:"span",props:{className:["math","math-inline"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\vec{c}"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.714em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]}]}]}]}]},{type:"text",value:"の距離が r と等しくなるような点の集合が円であるということなので、結果として線状の円周を示します。今回指定したいのは円の内側の面領域なので、不等式にすればよいです。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["math","math-display"]},children:[{type:"element",tag:"span",props:{className:["katex-display"]},children:[{type:"element",tag:"span",props:{className:["katex"]},children:[{type:"element",tag:"span",props:{className:["katex-mathml"]},children:[{type:"element",tag:"math",props:{xmlns:"http:\u002F\u002Fwww.w3.org\u002F1998\u002FMath\u002FMathML",display:"block"},children:[{type:"element",tag:"semantics",props:{},children:[{type:"element",tag:"mrow",props:{},children:[{type:"element",tag:"mi",props:{mathvariant:"normal"},children:[{type:"text",value:"∥"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"p"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"−"}]},{type:"element",tag:"mover",props:{accent:"true"},children:[{type:"element",tag:"mi",props:{},children:[{type:"text",value:"c"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"⃗"}]}]},{type:"element",tag:"mi",props:{mathvariant:"normal"},children:[{type:"text",value:"∥"}]},{type:"element",tag:"mo",props:{},children:[{type:"text",value:"≤"}]},{type:"element",tag:"mi",props:{},children:[{type:"text",value:"r"}]}]},{type:"element",tag:"annotation",props:{encoding:"application\u002Fx-tex"},children:[{type:"text",value:"\\|\\vec{p}-\\vec{c}\\| \\leq r"}]}]}]}]},{type:"element",tag:"span",props:{className:["katex-html"],ariaHidden:"true"},children:[{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"∥"}]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t","vlist-t2"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"p"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.15216em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["vlist-s"]},children:[{type:"text",value:"​"}]}]},{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.19444em;"},children:[{type:"element",tag:"span",props:{},children:[]}]}]}]}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]},{type:"element",tag:"span",props:{className:["mbin"]},children:[{type:"text",value:"−"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2222222222222222em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:1em;vertical-align:-0.25em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","accent"]},children:[{type:"element",tag:"span",props:{className:["vlist-t"]},children:[{type:"element",tag:"span",props:{className:["vlist-r"]},children:[{type:"element",tag:"span",props:{className:["vlist"],style:"height:0.714em;"},children:[{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"element",tag:"span",props:{className:["mord","mathnormal"]},children:[{type:"text",value:"c"}]}]}]},{type:"element",tag:"span",props:{style:"top:-3em;"},children:[{type:"element",tag:"span",props:{className:["pstrut"],style:"height:3em;"},children:[]},{type:"element",tag:"span",props:{className:["accent-body"],style:"left:-0.17994em;"},children:[{type:"element",tag:"span",props:{className:["overlay"],style:"height:0.714em;width:0.471em;"},children:[{type:"element",tag:"svg",props:{width:"0.471em",height:"0.714em",style:"width:0.471em",viewBox:"0 0 471 714",preserveAspectRatio:"xMinYMin"},children:[{type:"element",tag:"path",props:{d:"M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5\n3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11\n10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63\n-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1\n-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59\nH213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359\nc-16-25.333-24-45-24-59z"},children:[]}]}]}]}]}]}]}]}]},{type:"element",tag:"span",props:{className:["mord"]},children:[{type:"text",value:"∥"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]},{type:"element",tag:"span",props:{className:["mrel"]},children:[{type:"text",value:"≤"}]},{type:"element",tag:"span",props:{className:["mspace"],style:"margin-right:0.2777777777777778em;"},children:[]}]},{type:"element",tag:"span",props:{className:["base"]},children:[{type:"element",tag:"span",props:{className:["strut"],style:"height:0.43056em;vertical-align:0em;"},children:[]},{type:"element",tag:"span",props:{className:["mord","mathnormal"],style:"margin-right:0.02778em;"},children:[{type:"text",value:"r"}]}]}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"円のマスクを描画する"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E5%86%86%E3%81%AE%E3%83%9E%E3%82%B9%E3%82%AF%E3%82%92%E6%8F%8F%E7%94%BB%E3%81%99%E3%82%8B",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"円のマスクを描画する"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この考えに従うと、円のマスクを描画するのは次のコード 1 行で完結します。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"Custom Nodeのコード"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-hlsl"]},children:[{type:"text",value:"return int(saturate(Radius - distance(Center, UVs)) + 0.999999);"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"また分岐を使っていないので可読性が下がっていますが、やっていることは円の中心"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Center"}]},{type:"text",value:"と現在のUV座標である"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"UVs"}]},{type:"text",value:"の距離を出し(ノルムに対応)、半径からその距離を減算し、0以下になったかそうでないかで、最終的に0と1のどちらかに値がなるように調整しています。\nこちらを以下のようにCustomノードに記入して、配線するだけです。これで位置と半径を指定した円を描くことができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"draw-circle-mask.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords\u002F\u002Fdraw-circle-mask.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"色付き円を作成する"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E8%89%B2%E4%BB%98%E3%81%8D%E5%86%86%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"色付き円を作成する"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これについては、色付き長方形を作成した際の長方形マスクマテリアル関数を、そのまま円のマスクマテリアル関数の置き換えるだけで作成可能なので、割愛します。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"まとめ"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E3%81%BE%E3%81%A8%E3%82%81",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"まとめ"}]},{type:"text",value:"\n"},{type:"element",tag:"video",props:{controls:true,src:"\u002Farticle-assets\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords\u002F\u002Fresult.mp4"},children:[{type:"text",value:"result.mp4"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UV 座標を元に図形を描くのは簡単にできることがわかったと思います。次はレイマーチングしたい。"}]}]},dir:"\u002Farticles\u002Funrealengine",path:"\u002Farticles\u002Funrealengine\u002Fdraw-rectangles-lines-on-uv-coords",extension:".md",createdAt:"2022-01-29T00:45:39.000Z",updatedAt:"2022-01-29T18:57:28.000Z",gitCreatedAt:"2022-01-29T00:45:39.000Z",gitUpdatedAt:"2022-01-29T18:57:28.000Z"},{slug:"write-an-nbit-adder-using-only-types",description:"C++の型システムだけで、組み合わせ論理回路であるN-bit加算器を実装してみる。",title:"[C++]型だけでN bit加算器を書こう",enforceCreatedAt:"2021\u002F6\u002F17",enforceUpdatedAt:"2021\u002F6\u002F17",tags:["C++","metaprogramming","静的型付け","concept","C++20"],assets:"\u002Farticle-assets\u002Fcpp\u002Fwrite-an-nbit-adder-using-only-types",toc:[{id:"最低限の出力処理を用意しておく",depth:2,text:"最低限の出力処理を用意しておく"},{id:"nand-ゲート型",depth:2,text:"NAND ゲート型"},{id:"その他のゲートの型を用意する",depth:2,text:"その他のゲートの型を用意する"},{id:"基本論理ゲートのソースコード",depth:3,text:"基本論理ゲートのソースコード"},{id:"半加算器",depth:2,text:"半加算器"},{id:"全加算器",depth:2,text:"全加算器"},{id:"n-bit-加算器",depth:2,text:"N bit 加算器"},{id:"バイナリ型シーケンスの作成",depth:3,text:"バイナリ型シーケンスの作成"},{id:"n-bit-加算器本体",depth:3,text:"N bit 加算器本体"}],body:{type:"root",children:[{type:"element",tag:"p",props:{},children:[{type:"element",tag:"nuxt-link",props:{to:"\u002Farticle-assets\u002Fcpp\u002Fwrite-an-nbit-adder-using-only-types\u002F\u002Fhogehoge.txt"},children:[{type:"text",value:"hoge"}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"最近、Twitter で以下の記事を見かけました。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"a",props:{href:"https:\u002F\u002Fqiita.com\u002FKuniwak\u002Fitems\u002F983ba68fcf68d915b07d",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"https:\u002F\u002Fqiita.com\u002FKuniwak\u002Fitems\u002F983ba68fcf68d915b07d"}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"2018 年の記事と少し古めですが、TypeScript の型システムを利用して論理ゲート～ 4bit 加算器を実装しています。こんなものを見かけたら、C++でもやりたくなってしまうのが人間というものです。ということなので、今回は C++の型システムで組み合わせ回路を実装していきたいと思います。やりたかっただけです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"レギュレーション"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%AC%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"レギュレーション"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"上記の記事では、TypeScript の型システムを用いた静的計算を「コンパイル時計算」とし、TypeScript のコンパイル時計算で組み合わせ回路を実装するという趣旨になっていました。しかし、C++でこの言葉をそのまま採用して実装すると、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"constexpr"}]},{type:"text",value:"で世界のすべてを殴り倒すことが出来てしまい、面白くありません。せっかくなので今回は、以下のような条件のもとでコードを書いてみましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"非型テンプレートパラメータ以外の場所では、定数値を含め値を書かない。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"同様に、非型テンプレートパラメータを算出する以外の目的で"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"constexpr"}]},{type:"text",value:"な処理を利用しない。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"実行時の処理については、上記の制約の対象としない。ただし、実行時にして良い処理は入出力に関するもののみとする。"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"もはや型で遊びたいだけであり、何が目的の実装なのかよくわかりませんが(そもそもレギュレーションガバガバですが)、まあよいでしょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"検証環境"},children:[{type:"element",tag:"a",props:{href:"#%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"検証環境"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"clang version 12.0.0"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"x86_64-pc-linux-gnu"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"std=c++2a"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"注意点"},children:[{type:"element",tag:"a",props:{href:"#%E6%B3%A8%E6%84%8F%E7%82%B9",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"注意点"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"本記事の実装では、fold expression の展開数制限および template の再帰深度上限を回避するような実装は行っていません。ですので、N を大きくしていくと意外とすぐ死にます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"バイナリ型を定義する"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E5%9E%8B%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"バイナリ型を定義する"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"先駆者様に倣って、0 or 1 の保持にも型を利用していこうと思います。ここは複雑ではありませんので、全体のコードをいきなり提示します。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"binary.h"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"#pragma once\n#include \u003Ctype_traits\u003E\n\nnamespace Binary {\n    struct Binary {};\n    struct I : public Binary {};\n    struct O : public Binary  {};\n\n    template \u003Ctypename T\u003E\n    concept IsBinary = std::is_base_of_v\u003CBinary, T\u003E;\n\n    template \u003Ctypename T\u003E\n    concept IsZero = std::is_same_v\u003CT, O\u003E && IsBinary\u003CT\u003E;\n\n    template \u003Ctypename T\u003E\n    concept IsOne = std::is_same_v\u003CT, I\u003E && IsBinary\u003CT\u003E;\n}\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"マーカーの役割を果たす"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Binary"}]},{type:"text",value:"型と、それを継承した"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"O"}]},{type:"text",value:"と"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"I"}]},{type:"text",value:"のバイナリ型を定義しました。今回はドントケアを含む回路は想定しませんので、回路で現れる値(型だけど)が 0 と 1 以外の値を取ることはありません。ですので、渡されてきた型がバイナリであるか、つまり"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"O"}]},{type:"text",value:"と"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"I"}]},{type:"text",value:"のどちらかであるかを判断するコンセプトを定義しています。また、対象の型が"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"O"}]},{type:"text",value:"であるか、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"I"}]},{type:"text",value:"であるかを判断するための"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IsZero"}]},{type:"text",value:"と"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IsOne"}]},{type:"text",value:"のコンセプトも用意しました。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"最低限の出力処理を用意しておく"},children:[{type:"element",tag:"a",props:{href:"#%E6%9C%80%E4%BD%8E%E9%99%90%E3%81%AE%E5%87%BA%E5%8A%9B%E5%87%A6%E7%90%86%E3%82%92%E7%94%A8%E6%84%8F%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"最低限の出力処理を用意しておく"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この後論理ゲートを実装していきますが、結果が確認できないと困ります。予め最低限の出力処理を用意しておくことにします。レギュレーションより、ここでは自由な値の利用が許可されます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"最低限の出力処理"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"using Binary::O;\nusing Binary::I;\n\ntemplate \u003CBinary::IsBinary T\u003E\nstruct bitToChar {};\n\ntemplate \u003CBinary::IsZero T\u003E\nstruct bitToChar\u003CT\u003E { inline static constexpr const char v = '0'; };\n\ntemplate \u003CBinary::IsOne T\u003E\nstruct bitToChar\u003CT\u003E { inline static constexpr const char v = '1'; };\n\ntemplate \u003CBinary::IsBinary T\u003E\nconstexpr const char bitToCharV = bitToChar\u003CT\u003E::v;\n\ntemplate \u003Ctemplate \u003Ctypename, typename\u003E typename Gate\u003E\nstatic void printTruthTable() {\n    fmt::print(\"0 0 | {}\\n\", bitToCharV\u003CGate\u003CO, O\u003E\u003E);\n    fmt::print(\"0 1 | {}\\n\", bitToCharV\u003CGate\u003CO, I\u003E\u003E);\n    fmt::print(\"1 0 | {}\\n\", bitToCharV\u003CGate\u003CI, O\u003E\u003E);\n    fmt::print(\"1 1 | {}\\n\", bitToCharV\u003CGate\u003CI, I\u003E\u003E);\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"このコードは、2 入力 1 出力のゲート型を受け取って、その真理値表を出力するものです。基本論理ゲートの動作確認にはこれを使っていきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"基本論理ゲートを実装する"},children:[{type:"element",tag:"a",props:{href:"#%E5%9F%BA%E6%9C%AC%E8%AB%96%E7%90%86%E3%82%B2%E3%83%BC%E3%83%88%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"基本論理ゲートを実装する"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"前述の記事では、基本論理ゲートの出力をテーブル化して参照するようにしていました。しかし、"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"NAND 論理の完全性"}]},{type:"text",value:"を利用すれば NAND 以外のゲートをテーブル化する必要はありませんので、本記事ではテーブル化するゲートは NAND のみとし、その他のゲートは NAND 型を組み合わせた型として実装していきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"nand-ゲート型"},children:[{type:"element",tag:"a",props:{href:"#nand-%E3%82%B2%E3%83%BC%E3%83%88%E5%9E%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"NAND ゲート型"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"NAND ゲートの実装は以下のようなものにしました。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"basic_gates.h(NAND部)"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    struct NAND  {};\n    template \u003CBinary::IsZero A, Binary::IsZero B\u003E\n    struct NAND\u003CA, B\u003E  { using X = Binary::One; };\n    template \u003CBinary::IsZero A, Binary::IsOne B\u003E\n    struct NAND\u003CA, B\u003E  { using X = Binary::One; };\n    template \u003CBinary::IsOne A, Binary::IsZero B\u003E\n    struct NAND\u003CA, B\u003E  { using X = Binary::One; };\n    template \u003CBinary::IsOne A, Binary::IsOne B\u003E\n    struct NAND\u003CA, B\u003E  { using X = Binary::Zero; };\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using NANDv = typename NAND\u003CA, B\u003E::X"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"C++20 のコンセプト万々歳です。とても楽にテンプレートパラメータに基づいたオーバーロードを書くことが出来ます。これで、NAND 型のテンプレートパラメータとして渡された 2 つのバイナリ型の組み合わせによって、NAND 型がその内部に NAND ゲートの出力であるバイナリ型の型エイリアス"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"X"}]},{type:"text",value:"を持つようになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"動作しているかどうか、先程用意した出力処理を利用して検証してみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"NAND出力テスト"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"int main()\n{\n    printTruthTable\u003CGates::NANDv\u003E();\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"出力"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-shell"]},children:[{type:"text",value:"0 0 | 1\n0 1 | 1\n1 0 | 1\n1 1 | 0"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"どうやらしっかり動作しているようです！"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"その他のゲートの型を用意する"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E3%82%B2%E3%83%BC%E3%83%88%E3%81%AE%E5%9E%8B%E3%82%92%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"その他のゲートの型を用意する"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"先述したとおり、あらゆる論理ゲートは NAND ゲートを用いて表現することが出来ます。つまりは、NAND 型を組み合わせるだけで他のゲートの型は用意できるわけです。一気にやってしまいましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"basic_gates.h(その他のゲート達)"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"    template \u003CBinary::IsBinary A\u003E\n    using NOT = NAND\u003CA, A\u003E;\n    template \u003CBinary::IsBinary A\u003E\n    using NOTv = typename NOT\u003CA\u003E::X;\n\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using AND = NOT\u003CNANDv\u003CA, B\u003E\u003E;\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using ANDv = typename AND\u003CA, B\u003E::X;\n\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using OR = NAND\u003CNOTv\u003CA\u003E, NOTv\u003CB\u003E\u003E;\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using ORv = typename OR\u003CA, B\u003E::X;\n\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using NOR = NOT\u003CORv\u003CA, B\u003E\u003E;\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using NORv = typename NOR\u003CA, B\u003E::X;\n\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using XOR = NAND\u003CNANDv\u003CA, NANDv\u003CA, B\u003E\u003E, NANDv\u003CNANDv\u003CA, B\u003E, B\u003E\u003E;\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using XORv = typename XOR\u003CA, B\u003E::X"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"NOT"}]},{type:"text",value:"\u002F"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"AND"}]},{type:"text",value:"\u002F"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"OR"}]},{type:"text",value:"\u002F"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"NOR"}]},{type:"text",value:"\u002F"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"XOR"}]},{type:"text",value:"の型を定義しました。すべてエイリアステンプレートのみによって実現することが出来ました。"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"NAND"}]},{type:"text",value:"に感謝です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"一応、出力を確認しておきましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"出力テスト"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"int main()\n{\n    printTruthTable\u003CGates::ANDv\u003E(\"NAND\");\n    printTruthTable\u003CGates::ORv\u003E(\"OR\");\n    printTruthTable\u003CGates::NORv\u003E(\"NOR\");\n    printTruthTable\u003CGates::XORv\u003E(\"XOR\");\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-unknown"]},children:[{type:"element",tag:"code",props:{className:["language-unknown"]},children:[{type:"text",value:"[NAND]\n0 0 | 0\n0 1 | 0\n1 0 | 0\n1 1 | 1\n[OR]\n0 0 | 0\n0 1 | 1\n1 0 | 1\n1 1 | 1\n[NOR]\n0 0 | 1\n0 1 | 0\n1 0 | 0\n1 1 | 0\n[XOR]\n0 0 | 0\n0 1 | 1\n1 0 | 1\n1 1 | 0"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"完璧です。きちんと型のみで論理ゲートが実装できています。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"基本論理ゲートのソースコード"},children:[{type:"element",tag:"a",props:{href:"#%E5%9F%BA%E6%9C%AC%E8%AB%96%E7%90%86%E3%82%B2%E3%83%BC%E3%83%88%E3%81%AE%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"基本論理ゲートのソースコード"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"基本論理ゲートの実装全体を以下に示しておきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"basic_gates.h"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"#pragma once\n\n#include \"binary.h\"\n\nnamespace Gates {\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    struct NAND  {};\n    template \u003CBinary::IsZero A, Binary::IsZero B\u003E\n    struct NAND\u003CA, B\u003E  { using X = Binary::I; };\n    template \u003CBinary::IsZero A, Binary::IsOne B\u003E\n    struct NAND\u003CA, B\u003E  { using X = Binary::I; };\n    template \u003CBinary::IsOne A, Binary::IsZero B\u003E\n    struct NAND\u003CA, B\u003E  { using X = Binary::I; };\n    template \u003CBinary::IsOne A, Binary::IsOne B\u003E\n    struct NAND\u003CA, B\u003E  { using X = Binary::O; };\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using NANDv = typename NAND\u003CA, B\u003E::X;\n\n    template \u003CBinary::IsBinary A\u003E\n    using NOT = NAND\u003CA, A\u003E;\n    template \u003CBinary::IsBinary A\u003E\n    using NOTv = typename NOT\u003CA\u003E::X;\n\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using AND = NOT\u003CNANDv\u003CA, B\u003E\u003E;\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using ANDv = typename AND\u003CA, B\u003E::X;\n\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using OR = NAND\u003CNOTv\u003CA\u003E, NOTv\u003CB\u003E\u003E;\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using ORv = typename OR\u003CA, B\u003E::X;\n\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using NOR = NOT\u003CORv\u003CA, B\u003E\u003E;\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using NORv = typename NOR\u003CA, B\u003E::X;\n\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using XOR = NAND\u003CNANDv\u003CA, NANDv\u003CA, B\u003E\u003E, NANDv\u003CNANDv\u003CA, B\u003E, B\u003E\u003E;\n    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    using XORv = typename XOR\u003CA, B\u003E::X;\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここまでくれば加算器なんて簡単です。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"加算器"},children:[{type:"element",tag:"a",props:{href:"#%E5%8A%A0%E7%AE%97%E5%99%A8",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"加算器"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"型で加算器を実装していきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"半加算器"},children:[{type:"element",tag:"a",props:{href:"#%E5%8D%8A%E5%8A%A0%E7%AE%97%E5%99%A8",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"半加算器"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"全加算器を作るためには、まず半加算器からです。\n"},{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Fcpp\u002Fwrite-an-nbit-adder-using-only-types\u002F\u002Fhalf-adder.png"},children:[]},{type:"text",value:"\n半加算器は出力が複数あるため、これまでのように基本論理ゲートのエイリアステンプレートで定義することは出来ません。構造体を使って独自の型として実現していきましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"basic_adders.h(HalfAdder部)"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"    template \u003CBinary::IsBinary A, Binary::IsBinary B\u003E\n    struct HalfAdder {\n        using X = Gates::XORv\u003CA, B\u003E;\n        using Y = Gates::ANDv\u003CA, B\u003E;\n    };"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"以上です。なんと容易いのでしょうか。"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"XOR"}]},{type:"text",value:"が既に存在するおかげで、半加算器はたったこれだけのコードで実現できました。動作を確認します。出力が増えたため、新たな出力関数を定義しています。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"出力テスト"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"template \u003Ctemplate \u003Ctypename, typename\u003E typename Gate\u003E\nstatic void printTruthTable2_2(const std::string& title) {\n    fmt::print(\"[{}]\\n\", title);\n    fmt::print(\"A B | Y X\\n\", title);\n    fmt::print(\"0 0 | {} {}\\n\", bitToCharV\u003Ctypename Gate\u003CO, O\u003E::Y\u003E, bitToCharV\u003Ctypename Gate\u003CO, O\u003E::X\u003E);\n    fmt::print(\"0 1 | {} {}\\n\", bitToCharV\u003Ctypename Gate\u003CO, I\u003E::Y\u003E, bitToCharV\u003Ctypename Gate\u003CO, I\u003E::X\u003E);\n    fmt::print(\"1 0 | {} {}\\n\", bitToCharV\u003Ctypename Gate\u003CI, O\u003E::Y\u003E, bitToCharV\u003Ctypename Gate\u003CI, O\u003E::X\u003E);\n    fmt::print(\"1 1 | {} {}\\n\", bitToCharV\u003Ctypename Gate\u003CI, I\u003E::Y\u003E, bitToCharV\u003Ctypename Gate\u003CI, I\u003E::X\u003E);\n}\n\nint main()\n{\n    printTruthTable2_2\u003CCircuits::HalfAdder\u003E(\"HalfAdder\");\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-unknown"]},children:[{type:"element",tag:"code",props:{className:["language-unknown"]},children:[{type:"text",value:"[HalfAdder]\nA B | Y X\n0 0 | 0 0\n0 1 | 0 1\n1 0 | 0 1\n1 1 | 1 0"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"きちんと加算できていますし、桁上りの出力も正常です。半加算器型が実現できています。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"全加算器"},children:[{type:"element",tag:"a",props:{href:"#%E5%85%A8%E5%8A%A0%E7%AE%97%E5%99%A8",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"全加算器"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Fcpp\u002Fwrite-an-nbit-adder-using-only-types\u002F\u002Ffull-adder.png"},children:[]},{type:"text",value:"\n半加算器と全く同じです。違いを上げるとすれば、可読性のために構造体内部で型エイリアスを利用しているくらいです。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"basic_adders.h(FullAdder部)"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"    template \u003CBinary::IsBinary A, Binary::IsBinary B, Binary::IsBinary C\u003E\n    class FullAdder {\n        using HA1 = HalfAdder\u003CA, B\u003E;\n        using HA2 = HalfAdder\u003Ctypename HA1::X, C\u003E;\n    public:\n        using X = typename HA2::X;\n        using Y = Gates::ORv\u003Ctypename HA1::Y, typename HA2::Y\u003E;\n    };"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"早速出力を見てみましょう。今度は入力が増えたので、再び新たな出力関数を定義しています。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"出力テスト"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"template \u003Ctemplate \u003Ctypename, typename, typename\u003E typename Gate\u003E\nvoid printTruthTable3_2(const std::string& title)\n{\n    fmt::print(\"[{}]\\n\", title);\n    fmt::print(\"A B C | Y X\\n\"\n               \"0 0 0 | {} {}\\n0 0 1 | {} {}\\n0 1 0 | {} {}\\n0 1 1 | {} {}\\n\"\n               \"1 0 0 | {} {}\\n1 0 1 | {} {}\\n1 1 0 | {} {}\\n1 1 1 | {} {}\\n\",\n            bitToCharV\u003Ctypename Gate\u003CO, O, O\u003E::Y\u003E,\n            bitToCharV\u003Ctypename Gate\u003CO, O, O\u003E::X\u003E,\n            bitToCharV\u003Ctypename Gate\u003CO, O, I\u003E::Y\u003E,\n            bitToCharV\u003Ctypename Gate\u003CO, O, I\u003E::X\u003E,\n            bitToCharV\u003Ctypename Gate\u003CO, I, O\u003E::Y\u003E,\n            bitToCharV\u003Ctypename Gate\u003CO, I, O\u003E::X\u003E,\n            bitToCharV\u003Ctypename Gate\u003CO, I, I\u003E::Y\u003E,\n            bitToCharV\u003Ctypename Gate\u003CO, I, I\u003E::X\u003E,\n            bitToCharV\u003Ctypename Gate\u003CI, O, O\u003E::Y\u003E,\n            bitToCharV\u003Ctypename Gate\u003CI, O, O\u003E::X\u003E,\n            bitToCharV\u003Ctypename Gate\u003CI, O, I\u003E::Y\u003E,\n            bitToCharV\u003Ctypename Gate\u003CI, O, I\u003E::X\u003E,\n            bitToCharV\u003Ctypename Gate\u003CI, I, O\u003E::Y\u003E,\n            bitToCharV\u003Ctypename Gate\u003CI, I, O\u003E::X\u003E,\n            bitToCharV\u003Ctypename Gate\u003CI, I, I\u003E::Y\u003E,\n            bitToCharV\u003Ctypename Gate\u003CI, I, I\u003E::X\u003E\n            );\n}\n\nint main()\n{\n    printTruthTable3_2\u003CCircuits::FullAdder\u003E(\"FullAdder\");\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-unknown"]},children:[{type:"element",tag:"code",props:{className:["language-unknown"]},children:[{type:"text",value:"[FullAdder]\nA B C | Y X\n0 0 0 | 0 0\n0 0 1 | 0 1\n0 1 0 | 0 1\n0 1 1 | 1 0\n1 0 0 | 0 1\n1 0 1 | 1 0\n1 1 0 | 1 0\n1 1 1 | 1 1"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"はい。完璧です。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"n-bit-加算器"},children:[{type:"element",tag:"a",props:{href:"#n-bit-%E5%8A%A0%E7%AE%97%E5%99%A8",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"N bit 加算器"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Fcpp\u002Fwrite-an-nbit-adder-using-only-types\u002F\u002Fnbit-adder.png"},children:[]},{type:"text",value:"\nさて、全加算器が出来ましたので、複数 bit の加算がしたくなってきます。4 bit などの固定長としても良いですが、我々が今利用しているのはソフトウェアですので、ビット長くらいパラメトリックにしたいものです。C++には可変長テンプレートという N bit 加算器のための機能がありますので、こちらを利用して実装してみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"バイナリ型シーケンスの作成"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E5%9E%8B%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9%E3%81%AE%E4%BD%9C%E6%88%90",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"バイナリ型シーケンスの作成"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"N bit の加算器を作成するにあたっては、その加算対象となる値や得られる結果をバイナリ型のシーケンスとして扱いたくなります。型のシーケンスなんて作れるのかと思うかもしれませんが、それほど難しくありません。以下を"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"binary.h"}]},{type:"text",value:"に追記します。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"binary.h"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"    template \u003Ctypename T\u003E\n    struct IType {\n        using type = T;\n    };\n\n    template \u003CIsBinary... Bs\u003E\n    struct BinarySeq;\n\n    template\u003Ctypename IndexSeq, IsBinary SetType, std::size_t Pos, std::size_t Len, IsBinary... Ts\u003E\n    struct BinarySeqSetHelper;\n\n    template\u003Cstd::size_t... Indexes, IsBinary SetType, std::size_t Pos, std::size_t Len, IsBinary... Ts\u003E\n    struct BinarySeqSetHelper\u003Cstd::index_sequence\u003CIndexes...\u003E, SetType, Pos, Len, Ts...\u003E\n      : IType\u003CBinarySeq\u003C\n            std::tuple_element_t\u003CIndexes == Pos ? Len : Indexes, std::tuple\u003CTs..., SetType\u003E\u003E...\u003E\u003E {\n        static_assert(Pos \u003C Len, \"out of range\");\n    };\n\n    template\u003CIsBinary... Bs\u003E\n    struct BinarySeq : IType\u003CBinarySeq\u003CBs...\u003E\u003E {\n        static constexpr const std::size_t size = sizeof...(Bs);\n\n        template\u003CIsBinary SetType, std::size_t Pos\u003E\n        using Set = typename BinarySeqSetHelper\u003Cstd::make_index_sequence\u003Csizeof...(Bs)\u003E,\n                                 SetType,\n                                 Pos,\n                                 sizeof...(Bs),\n                                 Bs...\u003E::type;\n    };\n\n    template\u003CIsBinary B, std::size_t N, IsBinary... Bs\u003E\n    struct GenBinarySeq {\n        using type = typename GenBinarySeq\u003CB, N - 1, Bs..., B\u003E::type;\n    };\n\n    template\u003CIsBinary B, IsBinary... Bs\u003E\n    struct GenBinarySeq\u003CB, 0, Bs...\u003E {\n        using type = typename IType\u003CBinarySeq\u003CBs...\u003E\u003E::type;\n    };"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここでは、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"という可変長テンプレートパラメータに IsBinary を満たすバイナリ型を持つ型を定義しています。"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"が持つ型パラメータを型シーケンスと見做すわけです。"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"には"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Set"}]},{type:"text",value:"という型エイリアステンプレートが含まれていますが、この"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Set"}]},{type:"text",value:"はテンプレートパラメータとしてシーケンス上の位置と書き込みたい型を指定すると、そのように編集した後の型シーケンスを表すようになるという機能を持っています。また、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"GenBinarySeq"}]},{type:"text",value:"という型も定義されています。これは、テンプレートパラメータとして型と長さを指定すると、指定された型と長さを持つ"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"を作成してくれます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"binaryseqを出力可能にする"},children:[{type:"element",tag:"a",props:{href:"#binaryseq%E3%82%92%E5%87%BA%E5%8A%9B%E5%8F%AF%E8%83%BD%E3%81%AB%E3%81%99%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"を出力可能にする"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"バイナリ型を任意の長さのシーケンスとして保持できるようになったのは良いですが、これは値ではなく型テンプレートパラメータとして保持されているに過ぎません。これを我々の確認できる形で出力することは、以下のような実装で実現することが出来ます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"BinarySeqの出力実装"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"template \u003Ctypename Bs\u003E\nstruct BinarySeqPrintHelper;\n\ntemplate \u003CBinary::IsBinary... S\u003E\nstruct BinarySeqPrintHelper\u003CBinary::BinarySeq\u003CS...\u003E\u003E {\n    static void print() {\n        (fmt::print(\"{}\", bitToCharV\u003CS\u003E), ...);\n    }\n};"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"テンプレートの部分特殊化を利用して、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"の型パラメータ部分だけを取り出し、c++17 で導入された fold expression で出力しています。"}]},{type:"text",value:"\n"},{type:"element",tag:"h4",props:{id:"binaryseqを使ってみる"},children:[{type:"element",tag:"a",props:{href:"#binaryseq%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"を使ってみる"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"言葉で言われてもわかりにくいかと思いますので、実際の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"の動作を示すサンプルを提示します。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"BinarySeqのサンプルコード"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"int main()\n{\n    using Seq1 = Binary::BinarySeq\u003CI, I, I, O, O, I, O, I\u003E;\n    fmt::print(\"1: \");\n    BinarySeqPrintHelper\u003CSeq1\u003E::print();\n    fmt::print(\"\\n\");\n\n    using Seq2 = Seq1::Set\u003CI, 4\u003E::Set\u003CO, 1\u003E;\n    fmt::print(\"2: \");\n    BinarySeqPrintHelper\u003CSeq2\u003E::print();\n    fmt::print(\"\\n\");\n\n    using Seq3 = Binary::GenBinarySeq\u003CO, 4\u003E::type;\n    fmt::print(\"3: \");\n    BinarySeqPrintHelper\u003CSeq3\u003E::print();\n    fmt::print(\"\\n\");\n\n    using Seq4 = Binary::GenBinarySeq\u003CI, 5\u003E::type;\n    fmt::print(\"4: \");\n    BinarySeqPrintHelper\u003CSeq4\u003E::print();\n    fmt::print(\"\\n\");\n\n    using Seq5 = Seq3::Set\u003CI, 2\u003E;\n    fmt::print(\"5: \");\n    BinarySeqPrintHelper\u003CSeq5\u003E::print();\n    fmt::print(\"\\n\");\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-unknown"]},children:[{type:"element",tag:"code",props:{className:["language-unknown"]},children:[{type:"text",value:"1: 11100101\n2: 10101101\n3: 0000\n4: 11111\n5: 0010"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"完全に型テンプレートパラメータが「任意長で扱えて」、「要素の編集も可能」なリストと化しています。きっとそういう機能なんだと思います(？)。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"n-bit-加算器本体"},children:[{type:"element",tag:"a",props:{href:"#n-bit-%E5%8A%A0%E7%AE%97%E5%99%A8%E6%9C%AC%E4%BD%93",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"N bit 加算器本体"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここまでで、すべての準備は整いました。あとはこれらを利用して N bit 加算器を実装するだけです。もったいぶっても仕方ないので(小出しにして詳細に説明するのが面倒なので)実装を貼ります。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"n_bit_adder.h"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"#pragma once\n\n#include \u003Ctuple\u003E\n#include \"basic_adders.h\"\n\nnamespace Circuits {\n    template \u003Cstd::size_t Len, typename BS1, typename BS2, typename BS3, Binary::IsBinary Ci\u003E\n    struct NbitAdderHelper;\n\n    template \u003CBinary::IsBinary... S1, Binary::IsBinary... S2, Binary::IsBinary... S3, Binary::IsBinary Ci\u003E\n    struct NbitAdderHelper\u003Csizeof...(S1), Binary::BinarySeq\u003CS1...\u003E, Binary::BinarySeq\u003CS2...\u003E, Binary::BinarySeq\u003CS3...\u003E, Ci\u003E {\n        static_assert(sizeof...(S1) == sizeof...(S2) && sizeof...(S1) == sizeof...(S3), \"Bit length not matched.\");\n        static constexpr const std::size_t N = sizeof...(S1);\n        using A = std::tuple_element_t\u003CN-1, std::tuple\u003CS1...\u003E\u003E;\n        using B = std::tuple_element_t\u003CN-1, std::tuple\u003CS2...\u003E\u003E;\n        using HAdder = Circuits::HalfAdder\u003CA, B\u003E;\n\n        using Ss = typename NbitAdderHelper\u003CN-1, Binary::BinarySeq\u003CS1...\u003E, Binary::BinarySeq\u003CS2...\u003E, typename Binary::BinarySeq\u003CS3...\u003E::template Set\u003Ctypename HAdder::X, N-1\u003E, typename HAdder::Y\u003E::Ss;\n    };\n\n    template \u003Cstd::size_t N, Binary::IsBinary... S1, Binary::IsBinary... S2, Binary::IsBinary... S3, Binary::IsBinary Ci\u003E\n    struct NbitAdderHelper\u003CN, Binary::BinarySeq\u003CS1...\u003E, Binary::BinarySeq\u003CS2...\u003E, Binary::BinarySeq\u003CS3...\u003E, Ci\u003E {\n        static_assert(sizeof...(S1) == sizeof...(S2) && sizeof...(S1) == sizeof...(S3), \"Bit length not matched.\");\n        using A = std::tuple_element_t\u003CN-1, std::tuple\u003CS1...\u003E\u003E;\n        using B = std::tuple_element_t\u003CN-1, std::tuple\u003CS2...\u003E\u003E;\n        using FAdder = Circuits::FullAdder\u003CA, B, Ci\u003E;\n\n        using Ss = typename NbitAdderHelper\u003CN-1, Binary::BinarySeq\u003CS1...\u003E, Binary::BinarySeq\u003CS2...\u003E, typename Binary::BinarySeq\u003CS3...\u003E::template Set\u003Ctypename FAdder::X, N-1\u003E, typename FAdder::Y\u003E::Ss;\n    };\n\n    template \u003CBinary::IsBinary... S1, Binary::IsBinary... S2, Binary::IsBinary... S3, Binary::IsBinary Ci\u003E\n    struct NbitAdderHelper\u003C0, Binary::BinarySeq\u003CS1...\u003E, Binary::BinarySeq\u003CS2...\u003E, Binary::BinarySeq\u003CS3...\u003E, Ci\u003E {\n        static_assert(sizeof...(S1) == sizeof...(S2) && sizeof...(S1) == sizeof...(S3), \"Bit length not matched.\");\n        using Ss = Binary::BinarySeq\u003CCi, S3...\u003E;\n    };\n\n    template \u003Ctypename BS1, typename BS2\u003E\n    using NbitAdder = NbitAdderHelper\u003CBS1::size, BS1, BS2, typename Binary::GenBinarySeq\u003CBinary::O, BS1::size\u003E::type, Binary::O\u003E;\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"いや～ C++は良い言語ですね！！！！\nこのコードでやっているのは、先に示した回路図の安直な再現です。「一番はじめの半加算器」「2 番目～から[ビット長-1]番目の全加算器」「終了処理」の 3 つに特殊化されるように実装を切り分け、再帰的に演算結果を伝達させていっています。テンプレートパラメータの名前で説明するのならば、「"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"std::size_t N"}]},{type:"text",value:"がその時に対象としている半加算器\u002F全加算器の通番」「"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"typename BS1"}]},{type:"text",value:"と"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"typename BS2"}]},{type:"text",value:"は加算に使われる 2 つのバイナリ型シーケンス」「"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"typename BS3"}]},{type:"text",value:"は演算結果を保持しているバイナリ型シーケンス」「"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Binary::IsBinary Ci"}]},{type:"text",value:"は下位の加算器からの桁上り入力」です。結果として、演算対象とするシーケンスを受け取った"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"NbitAdderHelper"}]},{type:"text",value:"型は「先頭に最後の桁上り、2 番めから終端までが演算結果」となるバイナリ型シーケンスを示す型"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Ss"}]},{type:"text",value:"を内部に持つようになります。読みにくさはピカイチですが、やっていることはそんなに複雑ではありません。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この実装では与えられる"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"の長さが同一でなければ静的アサートでコンパイルエラーとなるようにしています。しかし、今回の処理は加算であるため、単純な 0 埋めの(メタ)実装を追加することで異なる長さの"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BinarySeq"}]},{type:"text",value:"も加算可能になります(あれ、でもそれって加算回路的にどうなの)。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここで例によって、結果を見える形にするための出力処理を実装しておきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"NbitAdderprintHelper"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"template \u003Ctypename Bs\u003E\nstruct NbitAdderPrintHelper;\n\ntemplate \u003CBinary::IsBinary... S1, Binary::IsBinary... S2\u003E\nstruct NbitAdderPrintHelper\u003CCircuits::NbitAdder\u003CBinary::BinarySeq\u003CS1...\u003E, Binary::BinarySeq\u003CS2...\u003E\u003E\u003E {\n    static void print_result() {\n        (fmt::print(\"{}\", bitToCharV\u003CS1\u003E), ...);\n        fmt::print(\" + \");\n        (fmt::print(\"{}\", bitToCharV\u003CS2\u003E), ...);\n\n        using Adder = Circuits::NbitAdder\u003CBinary::BinarySeq\u003CS1...\u003E, Binary::BinarySeq\u003CS2...\u003E\u003E;\n        fmt::print(\" = \");\n        BinarySeqPrintHelper\u003Ctypename Adder::Ss\u003E::print();\n        fmt::print(\"\\n\");\n    }\n};"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"特筆すべきところは特にありませんね。では結果を確認していきましょう！"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"Nbit加算器動作確認"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"int main()\n{\n    using ASeq = Binary::BinarySeq\u003CI, I, I, O, O, I, O, I, O, O, I, I, O, I, I, O\u003E;\n    using BSeq = Binary::BinarySeq\u003CI, I, O, I, O, O, I, I, O, I, O, O, O, O, I, I\u003E;\n    NbitAdderPrintHelper\u003CCircuits::NbitAdder\u003CASeq, BSeq\u003E\u003E::print_result();\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-unknown"]},children:[{type:"element",tag:"code",props:{className:["language-unknown"]},children:[{type:"text",value:"1110010100110110 + 1101001101000011 = 11011100001111001"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この結果が正しいのか、Windows の電卓くんに計算してもらいました。\n"},{type:"element",tag:"img",props:{alt:"出力検証結果",src:"\u002Farticle-assets\u002Fcpp\u002Fwrite-an-nbit-adder-using-only-types\u002F\u002Fresult.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"やった！完璧ですね！！C++の型システム上で N bit の加算器を動作させることに成功しました！！"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"おわりに"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"おわりに"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここまで記事を読んでくださった方に朗報があります。C++には**+演算子**と呼ばれる演算子が存在しており、以下のように記述することで加算を行うことが出来ます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"add"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"1 + 2 \u002F\u002F → 3"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"また、このようにコンパイル時に値が確定するリテラルとして表記された値は、コンパイラの最適化によってコンパイル時に演算結果の値へと置き換えられることが殆どであり、実行時コストを考える必要もありません。2 進数以外読めないという方も安心してください。C++14 からの C++は 2 進数リテラルを持っています。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"bin_add"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"0b1 + 0b10 \u002F\u002F → 0b11 (3)"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"よって、C++の型システムで加算器を実装する必要はありません。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"追記"},children:[{type:"element",tag:"a",props:{href:"#%E8%BF%BD%E8%A8%98",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"追記"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"本記事で利用したソースコードを GitHub にあげておきました。\n"},{type:"element",tag:"a",props:{href:"https:\u002F\u002Fgithub.com\u002Fstrvworks\u002Flogical_cpp\u002Ftree\u002Fmaster",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"https:\u002F\u002Fgithub.com\u002Fstrvworks\u002Flogical_cpp\u002Ftree\u002Fmaster"}]}]}]},dir:"\u002Farticles\u002Fcpp",path:"\u002Farticles\u002Fcpp\u002Fwrite-an-nbit-adder-using-only-types",extension:".md",createdAt:"2021-06-17T00:00:00.000Z",updatedAt:"2021-06-17T00:00:00.000Z",gitCreatedAt:"2021-11-25T17:55:07.000Z",gitUpdatedAt:"2022-01-29T00:45:39.000Z"},{slug:"support-user-defined-types-for-bp-operator-nodes-in-ue5",description:"UE5で追加されたType promotion機能付き演算子ノードに、ユーザー定義型サポートを追加する方法について",title:"UE5のBP演算子ノードにユーザー定義型を対応させる",enforceCreatedAt:"2021\u002F6\u002F8",enforceUpdatedAt:"2021\u002F6\u002F8",tags:["Unreal Engine","Blueprint","Unreal C++","Unreal Engine 5"],assets:"\u002Farticle-assets\u002Funrealengine\u002Fsupport-user-defined-types-for-bp-operator-nodes-in-ue5",toc:[{id:"ue5の演算子ノードってなに",depth:2,text:"UE5の演算子ノードってなに？"},{id:"対象とするデータ型",depth:2,text:"対象とするデータ型"},{id:"実装例",depth:2,text:"実装例"},{id:"対応のための条件",depth:2,text:"対応のための条件"},{id:"type-promotionがサポートする演算",depth:2,text:"Type promotionがサポートする演算"},{id:"どうやって実装を収集しているのか",depth:2,text:"どうやって実装を収集しているのか"},{id:"なぜ本来の実装ノードがbpのメニューに現れないか",depth:2,text:"なぜ本来の実装ノードがBPのメニューに現れないか"}],body:{type:"root",children:[{type:"element",tag:"h1",props:{id:"まえがき"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%BE%E3%81%88%E3%81%8C%E3%81%8D",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"まえがき"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"ue5の演算子ノードってなに"},children:[{type:"element",tag:"a",props:{href:"#ue5%E3%81%AE%E6%BC%94%E7%AE%97%E5%AD%90%E3%83%8E%E3%83%BC%E3%83%89%E3%81%A3%E3%81%A6%E3%81%AA%E3%81%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"UE5の演算子ノードってなに？"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"先日Early Accessが開始されたUE5には、仮想化されたジオメトリを扱うシステムであるNaniteや、動的かつ高度なライティングを行うLumenなど目を引く新機能が満載です。\nそんな華々しい機能の裏に隠れがちですが、同時に"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ブループリントのType promotion"}]},{type:"text",value:"というBlueprintに関する地味ながら便利な変更も追加されています。この変更は、これまでそれぞれの型ごとに別々のノードとして実装されていた各種演算子(Operator)ノードを、任意の型を演算可能な統一された演算子ノードで行えるようにするというものです。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"例えばUE4の時点では、加算に関するノードだけで以下のような状況になっていました。\n"},{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fsupport-user-defined-types-for-bp-operator-nodes-in-ue5\u002F\u002Fue4-operator-nodes.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"しかし、UE5以降では基本的な演算子ノードの入力ピンがすべてワイルドカードとなり、接続されたデータ型に対する加算処理を行うノードへと自動的に型をpromoteしてくれるようになったのです。\n"},{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fsupport-user-defined-types-for-bp-operator-nodes-in-ue5\u002F\u002Fue5-operator-node.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"素朴な疑問"},children:[{type:"element",tag:"a",props:{href:"#%E7%B4%A0%E6%9C%B4%E3%81%AA%E7%96%91%E5%95%8F",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"素朴な疑問"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"Type promotionは簡便かつ整理された状態を提供してくれる素晴らしい変更ですが、この仕様を見ると「"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ユーザーが追加した演算可能なデータ型に対してUE5の演算子ノードは対応可能なのか？？"}]},{type:"text",value:"」という疑問が湧いてきます。\nC++を用いてワイルドカードを入力として持つBPノードを実装するためには、UFUNCTIONにCustomThunk等のmeta指定子とThunk関数の実装を用いるか、K2_Nodeを継承した独自ノードをUFUNCTIONマクロを用いずに実装する必要があります。Type promotionを行うUE5の演算子ノードも同様に実装されていることは容易に推察ができますが、データ型に対する演算処理のように後からユーザーが追加する可能性があり、かつ内部処理が常に自動生成できるとは限らない処理をワイルドカード化して問題ないのでしょうか。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"調査結果"},children:[{type:"element",tag:"a",props:{href:"#%E8%AA%BF%E6%9F%BB%E7%B5%90%E6%9E%9C",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"調査結果"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"エンジンのソースを追った結果、非常に簡単にユーザー定義型をUE5の演算子ノードで扱うことができることがわかりました。以下では、ユーザー定義型をUE5のType promotionに対応させるために踏まえるべき点を記載します。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"対象とするデータ型"},children:[{type:"element",tag:"a",props:{href:"#%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"対象とするデータ型"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"実装例を提示するため、以下のようなサンプルのデータ型を定義しました。このデータ型を複素数型と見做して、UE5の演算子ノードで複素数に定義されるいくつかの演算を実装してみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"ComplexNumber.h"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"#pragma once\n#include \"ComplexNumber.generated.h\"\n\nUSTRUCT(BlueprintType)\nstruct FComplexNumber\n{\n\tGENERATED_BODY()\n\n\tFComplexNumber() : Real(0.0f), Imag(0.0f) {}\n\tFComplexNumber(const float Real, const float Imaginary) : Real(Real), Imag(Imaginary) {}\n\n\tUPROPERTY(BlueprintReadWrite, EditAnywhere)\n\tfloat Real;\n\n\tUPROPERTY(BlueprintReadWrite, EditAnywhere)\n\tfloat Imag;\n};"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"実装例"},children:[{type:"element",tag:"a",props:{href:"#%E5%AE%9F%E8%A3%85%E4%BE%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"実装例"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"詳細な説明に先んじて、実装例を提示します。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"ComplexNumberBlueprintLibrary.h"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"#pragma once\n\n#include \"CoreMinimal.h\"\n#include \"ComplexNumber.h\"\n#include \"ComplexNumberBlueprintLibrary.generated.h\"\n\nUCLASS()\nclass UComplexNumberBlueprintLibrary : public UBlueprintFunctionLibrary\n{\n\tGENERATED_BODY()\npublic:\n\n\t\u002F\u002F ---------演算の実装はここから-----------\n\n\t\u002F\u002F ComplexNumber + ComplexNumber (加算)\n\tUFUNCTION(BlueprintPure, meta=(DisplayName=\"ComplexNumber + ComplexNumber\", CompactNodeTitle=\"+\"), Category=\"ComplexNumber\")\n\tstatic FComplexNumber Add_ComplexNumberComplexNumber(const FComplexNumber A, const FComplexNumber B) { return FComplexNumber(A.Real + B.Real, A.Imag + B.Imag); }\n\n\t\u002F\u002F ComplexNumber - ComplexNumber (減算)\n\tUFUNCTION(BlueprintPure, meta=(DisplayName=\"ComplexNumber - ComplexNumber\", CompactNodeTitle=\"-\"), Category=\"ComplexNumber\")\n\tstatic FComplexNumber Subtract_ComplexNumberComplexNumber(const FComplexNumber A, const FComplexNumber B) { return FComplexNumber(A.Real - B.Real, A.Imag - B.Imag); }\n\n\t\u002F\u002F ComplexNumber * float (floatとの乗算)\n\tUFUNCTION(BlueprintPure, meta=(DisplayName=\"ComplexNumber * float\", CompactNodeTitle=\"*\"), Category=\"ComplexNumber\")\n\tstatic FComplexNumber Multiply_ComplexNumberFloat(const FComplexNumber A, const float B) { return FComplexNumber(A.Real * B, A.Imag * B); }\n\n\t\u002F\u002F ---------------ここまで---------------\n\n\t\u002F\u002F ToString\t(ComplexNumber)\n\tUFUNCTION(BlueprintPure, meta=(DisplayName = \"ToString (ComplexNumber)\", CompactNodeTitle=\"-\u003E\", BlueprintAutoCast), Category=\"ComplexNumber\")\n\tstatic FString ToString(const FComplexNumber In)\n\t{\n\t\treturn FString::Printf(TEXT(\"%.3f %s %.3fi\"),\n\t\t\t\tIn.Real,\n\t\t\t\tIn.Imag \u003C 0 ? TEXT(\"-\") : TEXT(\"+\"),\n\t\t\t\tFMath::Abs(In.Imag));\n\t}\n};\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"たったこれだけです。このコードをコンパイルすると、BPエディタにおいて"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ComplexNumber同士の加算"}]},{type:"text",value:"、"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ComplexNumber同士の減算"}]},{type:"text",value:"、"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ComplexNumberとfloatの乗算"}]},{type:"text",value:"が演算子ノードによって行えるようになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"接続が許可されるようになって……\n"},{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fsupport-user-defined-types-for-bp-operator-nodes-in-ue5\u002F\u002Fcomplex-type-1.png"},children:[]},{type:"text",value:"\n繋ぐとComplexNumberの加算ノードになる！\n"},{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fsupport-user-defined-types-for-bp-operator-nodes-in-ue5\u002F\u002Fcomplex-type-2.png"},children:[]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"こうして演算子ノードと接続した際に行われる処理は、当然ながら先程示したコードで実装されていた関数の内部の処理に置き換わっています。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"対応のための条件"},children:[{type:"element",tag:"a",props:{href:"#%E5%AF%BE%E5%BF%9C%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E6%9D%A1%E4%BB%B6",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"対応のための条件"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"なんと、UE5の演算子ノードのType promotionに対応するにあたって必要な点は以下の3つのみです。"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"対象のデータ型に対して、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BlueprintPure"}]},{type:"text",value:"を指定されたstaticなUFUNCTIONの実装がどこかに存在すること。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"演算を実装したUFUNCTIONに戻り値が存在すること。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"演算を実装したUFUNCTIONの名前が"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"[演算名Prefix]_"}]},{type:"text",value:"で始まること。"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"参考: Engine\\Source\\Editor\\BlueprintGraph\\Private\\BlueprintTypePromotion.cpp"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"必要となる"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"演算名Prefix"}]},{type:"text",value:"については次節で触れます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"先の実装についていたその他の指定子などは、全て細かなノードの見た目やカテゴリ表示に関するものであり、Type promotionとは一切関係がありません。条件を満たしたUFUNCTIONが存在するだけで、勝手にBPエディタがその存在を認識して、演算子ノードが処理の呼び分けを行ってくれるようになるのです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"type-promotionがサポートする演算"},children:[{type:"element",tag:"a",props:{href:"#type-promotion%E3%81%8C%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E6%BC%94%E7%AE%97",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Type promotionがサポートする演算"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"以下に、Type promotionがサポートする演算と、その実装をするために必要なUFUNCTIONのPrefixとなる演算名の対応表を示します。"}]},{type:"text",value:"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{type:"element",tag:"table",props:{},children:[{type:"element",tag:"thead",props:{},children:[{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"th",props:{},children:[{type:"text",value:"演算"}]},{type:"element",tag:"th",props:{},children:[{type:"text",value:"Prefix"}]}]}]},{type:"element",tag:"tbody",props:{},children:[{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"+"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Add"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"*"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Multiply"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"-"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Subtract"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"\u002F"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Divide"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"\u003E"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Greater"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"\u003E="}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"GreaterEqual"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"\u003C"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Less"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"\u003C="}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"LessEqual"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"!="}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"NotEqual"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"=="}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"EqualEqual"}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"参考: Engine\\Source\\Editor\\BlueprintGraph\\Private\\BlueprintTypePromotion.cpp"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"このPrefixをUFUNCTIONの関数名の頭に付加することで、対応する演算の実装として認識してもらうことが出来ます。簡単ですね！"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"おまけ"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%8A%E3%81%BE%E3%81%91",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"おまけ"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"簡単に動くのはいいですが、一体どんな仕組みで動いているのか気になってしまうと思いますので、少し見てみましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"どうやって実装を収集しているのか"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E5%AE%9F%E8%A3%85%E3%82%92%E5%8F%8E%E9%9B%86%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"どうやって実装を収集しているのか"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"実装を覗くと、この部分はなかなかのパワー的処理によって実現されています。以下はエンジンのソースコードからの抜粋です。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"BlueprintTypePromotion.cpp(抜粋)"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"void FTypePromotion::CreateOpTable()\n{\n\tTRACE_CPUPROFILER_EVENT_SCOPE(FTypePromotion::CreateOpTable);\n\tconst UEdGraphSchema_K2* Schema = GetDefault\u003CUEdGraphSchema_K2\u003E();\n\n\tOperatorTable.Empty();\n\n\tTArray\u003CUClass*\u003E Libraries;\n\tGetDerivedClasses(UBlueprintFunctionLibrary::StaticClass(), Libraries);\n\tfor (UClass* Library : Libraries)\n\t{\n\t\t\u002F\u002F Ignore abstract libraries\u002Fclasses\n\t\tif (!Library || Library-\u003EHasAnyClassFlags(CLASS_Abstract))\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\n\t\tfor (UFunction* Function : TFieldRange\u003CUFunction\u003E(Library, EFieldIteratorFlags::ExcludeSuper, EFieldIteratorFlags::ExcludeDeprecated))\n\t\t{\n\t\t\tif(!IsPromotableFunction(Function))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tFEdGraphPinType FuncPinType;\n\t\t\tFName OpName = GetOpNameFromFunction(Function);\n\n\t\t\tif (OpName != OperatorNames::NoOp && Schema-\u003EConvertPropertyToPinType(Function-\u003EGetReturnProperty(), \u002F* out *\u002F FuncPinType))\n\t\t\t{\n\t\t\t\tAddOpFunction(OpName, Function);\n\t\t\t}\n\t\t}\n\t}\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"CreateOpTable"}]},{type:"text",value:"というメソッドが何をしているかをざっくりまとめると、以下のようになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"ol",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"UBlueprintFunctionLibrary"}]},{type:"text",value:"を継承しているすべてのUClassを取得して配列に詰める。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"UClassの配列をループして走査しながら、それぞれのUClassが持っているUFUNCTIONを走査する。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"前述の3つの条件を満たすUFUNCTIONが現れたら、それを演算子ノードの実装に利用可能であると見做してルックアップテーブルに詰める！"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"パワーを感じます。パワーです。とてもメタメタしています。楽しいですね。\nなお、この"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"CreateOpTable"}]},{type:"text",value:"メソッドは、所属している"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"FTypePromotion"}]},{type:"text",value:"クラスのコンストラクタで呼び出されている他、エンジンのモジュール構成に変化があったとき(ホットリロード時など)に呼び出されるようになっています。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"なぜ本来の実装ノードがbpのメニューに現れないか"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%AA%E3%81%9C%E6%9C%AC%E6%9D%A5%E3%81%AE%E5%AE%9F%E8%A3%85%E3%83%8E%E3%83%BC%E3%83%89%E3%81%8Cbp%E3%81%AE%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%81%AB%E7%8F%BE%E3%82%8C%E3%81%AA%E3%81%84%E3%81%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"なぜ本来の実装ノードがBPのメニューに現れないか"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"先程の実装例のUFUNCTIONは、ここまで述べてきたUE5以降のType promotionシステムの知識を無いものとして考えると、ただのBPから利用可能なUFUNCTION定義です。つまり、従来の考え方からするとそれ自体もBPのノードリストに登録されていなければおかしいはずです。しかし、実際にはそうなっておらず、「"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ComplexNumber"}]},{type:"text",value:"用の演算ノード」は現れなくなっています。以下の画像のように、統合されたものしか表示されません。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fsupport-user-defined-types-for-bp-operator-nodes-in-ue5\u002F\u002Fquestion.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これは、以下の部分のエンジンコードを見るとわかります。このメソッドは長いため、今回の内容にとって重要ではない場所は省いています。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"BlueprintFunctionNodeSpawner.cpp"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"UBlueprintFunctionNodeSpawner* UBlueprintFunctionNodeSpawner::Create(UFunction const* const Function, UObject* Outer\u002F* = nullptr*\u002F)\n{\n    \u002F\u002F 略\n\tbool const bIsPromotableFunction = TypePromoDebug::IsTypePromoEnabled() && FTypePromotion::IsFunctionPromotionReady(Function);\n\n\tTSubclassOf\u003CUK2Node_CallFunction\u003E NodeClass;\n\tif (bIsPromotableFunction)\n\t{\n\t\tNodeClass = UK2Node_PromotableOperator::StaticClass();\n\t}\n    \u002F\u002F 略\n\telse\n\t{\n\t\tNodeClass = UK2Node_CallFunction::StaticClass();\n\t}\n\n\treturn Create(NodeClass, Function, Outer);\n}\n\n\nUBlueprintFunctionNodeSpawner* UBlueprintFunctionNodeSpawner::Create(TSubclassOf\u003CUK2Node_CallFunction\u003E NodeClass, UFunction const* const Function, UObject* Outer\u002F* = nullptr*\u002F)\n{\n    \u002F\u002F 略\n\n\tbool const bIsPromotableFunction =\n\t\tTypePromoDebug::IsTypePromoEnabled() &&\n\t\tFTypePromotion::IsFunctionPromotionReady(Function);\n\n\tFName OpName = FTypePromotion::GetOpNameFromFunction(Function);\n\n\t\u002F\u002F If a spawner for this operator has been created already, than just return that\n\tif (bIsPromotableFunction && FTypePromotion::IsOperatorSpawnerRegistered(Function))\n\t{\n\t\tif (UBlueprintFunctionNodeSpawner* OpSpawner = FTypePromotion::GetOperatorSpawner(OpName))\n\t\t{\n\t\t\treturn OpSpawner;\n\t\t}\n\t}\n\n\tUBlueprintFunctionNodeSpawner* NodeSpawner = NewObject\u003CUBlueprintFunctionNodeSpawner\u003E(Outer);\n\tNodeSpawner-\u003ESetField(const_cast\u003CUFunction*\u003E(Function));\n\n    \u002F\u002F 略\n\n\tFBlueprintActionUiSpec& MenuSignature = NodeSpawner-\u003EDefaultMenuSignature;\n\n\tif(bIsPromotableFunction)\n\t{\n\t\tMenuSignature.MenuName = FTypePromotion::GetUserFacingOperatorName(OpName);\n\t\tMenuSignature.Category = LOCTEXT(\"UtilityOperatorCategory\", \"Utilities|Operators\");\n\t\t\u002F\u002F Possibly generate some special tooltips for promotable operators?\n\t\tMenuSignature.Tooltip = FTypePromotion::GetUserFacingOperatorName(OpName);\n\t\tMenuSignature.Keywords = FTypePromotion::GetKeywordsForOperator(OpName);\n\t\tFTypePromotion::RegisterOperatorSpawner(OpName, NodeSpawner);\n\t}\n\telse\n\t{\n\t\tMenuSignature.MenuName = UK2Node_CallFunction::GetUserFacingFunctionName(Function);\n\t\tMenuSignature.Category = UK2Node_CallFunction::GetDefaultCategoryForFunction(Function, FText::GetEmpty());\n\t\tMenuSignature.Tooltip = FText::FromString(UK2Node_CallFunction::GetDefaultTooltipForFunction(Function));\n\t\t\u002F\u002F add at least one character, so that PrimeDefaultUiSpec() doesn't attempt to query the template node\n\t\tMenuSignature.Keywords = UK2Node_CallFunction::GetKeywordsForFunction(Function);\n\t}\n\n    \u002F\u002F 略\n\n\treturn NodeSpawner;\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"このコードには2つの"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Create"}]},{type:"text",value:"というメソッドのオーバーロード定義が含まれており、上の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Create"}]},{type:"text",value:"の定義の最終行で下の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Create"}]},{type:"text",value:"を呼び出してもいるという構造になっています。\nこれらはBPエディタで右クリックした際に表示されるノードリスト(など)で利用される情報を作成するメソッドです。作成される情報の内容には、名前やTooltipなどの表示情報のほか、ユーザーによってそのリストからノードが選択されたときにエディタ上に実際にノードをSpawnさせるためのSpawnerオブジェクトなどが含まれます。BPエディタが初期化・変更されるなどして全体のリフレッシュ処理が実行されると、BPエディタは存在するすべてのUClassを走査して、それらが持っているAction(エディタからアクセス可能なUPropertyやUFunction、そしてそれらが持っている表示情報や利用時の処理など……)を収集します。その処理の流れの中で、UFunctionに関するものの一部はこの"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Create"}]},{type:"text",value:"メソッドのところにUFunctionに関する情報を作成させ、取得しにやってくるのです。このとき呼ばれるのは、上の方の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Create"}]},{type:"text",value:"の定義からになります。この前提のもとにこの処理をまとめると、以下のようになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"ol",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"あるUFunctionが渡されてくる。Type promotionが有効化されていて、かつ受け取ったUFunctionがType promotionの条件を満たしてる場合、SpawnするBPノードのクラスを問答無用でUK2Node_PromotableOperatorノードにする。UK2Node_PromotableOperatorノードは統合後の演算子ノードの実装クラスである。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"また、同じく受け取ったUFunctionが条件を満たしている場合、作成するActionの情報もUFunctionのものは直接利用せず、受け取ったUFunctionが「定義している演算が属する」演算の名前や表示名、検索キーワードが設定される。この時に作成された情報やSpawnerは登録される。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"再び、データ型は違うが属する演算は同じUFunctionが渡されてきたとする(例えば、Add_IntIntとAdd_FloatFloatはデータ型は違うがAdd演算に属する定義)。すると、登録処理の前に既に同じ演算のUK2Node_PromotableOperatorノードが登録されていることが検出され、新規に情報を作成するのではなく既に登録した情報を返すようになる。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"結果として、「ある演算に対して１つも実装が存在しないと、UE5のType promotionする演算子ノードも一つも存在しない。」「ある演算に対して１つ以上の実装が存在すると、それらに共通する演算子ノードが１つだけ登録される」という処理となる。"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"おわりに"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"おわりに"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"楽しい機能で大変良いですね。正直、はじめは新たなmeta指定子でも追加されたんだろうと思って実装を見始めたのですが、一切プリプロセスに変更を加えないで対応していて面白かったです。長くなりそうで面倒だったので触れませんでしたが、UK2Node_PromotableOperatorノードが行っている、収集した関数の実装から、渡されてきたピンの型情報に最も合致する関数を探し出す処理などもこの機能の根幹を占めている部分ですので、興味があれば実装を読んでみると面白いと思います。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ところで、こういう方面進めるなら、はやく部分的にでもUFUNCTIONをtemplateに対応させてくれないかなあという個人的な気持ちがあります。みなさんでこのPRを応援しましょう(他人任せ)。\n"},{type:"element",tag:"a",props:{href:"https:\u002F\u002Fgithub.com\u002FEpicGames\u002FUnrealEngine\u002Fpull\u002F6902",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"https:\u002F\u002Fgithub.com\u002FEpicGames\u002FUnrealEngine\u002Fpull\u002F6902"}]}]}]},dir:"\u002Farticles\u002Funrealengine",path:"\u002Farticles\u002Funrealengine\u002Fsupport-user-defined-types-for-bp-operator-nodes-in-ue5",extension:".md",createdAt:"2021-06-08T00:00:00.000Z",updatedAt:"2021-06-08T00:00:00.000Z",gitCreatedAt:"2021-11-25T19:56:59.000Z",gitUpdatedAt:"2022-01-29T00:45:39.000Z"},{slug:"a-little-more-about-the-ue4-module",description:"UE4のモジュールシステムについて、すこしだけ詳しく書いた記事",title:"ちょっとだけくわしくUE4 モジュールの話",enforceCreatedAt:"2019\u002F7\u002F28",enforceUpdatedAt:"2019\u002F10\u002F29",tags:["Unreal Engine","Unreal C++"],assets:"\u002Farticle-assets\u002Funrealengine\u002Fa-little-more-about-the-ue4-module",toc:[{id:"ゲームモジュールを追加する意義",depth:2,text:"ゲームモジュールを追加する意義"},{id:"モジュールの構成",depth:2,text:"モジュールの構成"},{id:"モジュールファイル",depth:2,text:"モジュールファイル"},{id:"ターゲットファイル",depth:2,text:"ターゲットファイル"},{id:"uproject-ファイル",depth:2,text:".uproject ファイル"},{id:"type",depth:3,text:"Type"},{id:"loadingphase",depth:3,text:"LoadingPhase"},{id:"なぜビルド設定が-c",depth:2,text:"なぜビルド設定が C#?"},{id:"implement_primary_game_module",depth:2,text:"IMPLEMENT_PRIMARY_GAME_MODULE"},{id:"implement_game_module",depth:2,text:"IMPLEMENT_GAME_MODULE"},{id:"implement_module",depth:2,text:"IMPLEMENT_MODULE"},{id:"モジュール実装マクロの余談",depth:2,text:"モジュール実装マクロの余談"},{id:"startupmodule",depth:2,text:"StartupModule"},{id:"postloadcallback",depth:2,text:"PostLoadCallback"},{id:"shutdonwmodule",depth:2,text:"ShutdonwModule"},{id:"preunloadcallback",depth:2,text:"PreUnloadCallback"}],body:{type:"root",children:[{type:"element",tag:"h1",props:{id:"趣旨"},children:[{type:"element",tag:"a",props:{href:"#%E8%B6%A3%E6%97%A8",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"趣旨"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UE4 は本当にいろいろなことができますが、特定のトピックに対する情報のまとまった記事というのがあまりない気がします。\n手順書的な記事は結構あったりするのですが、そのものに対する解説記事的なのは更にない気がします。なので、UE4 の勉強がてら書いてみました。この記事を読むときは、手元で同じように実装を読んでいってもらえるとわかりやすいかと思います。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"僕は趣味で UE4 をやっているへっぽこ学生なので、なにか間違っていたら遠慮なくご指摘いただけると、僕とこの記事を今後見る人が助かります。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"環境"},children:[{type:"element",tag:"a",props:{href:"#%E7%92%B0%E5%A2%83",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"環境"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"エンジンバージョン: 4.22.3"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"プロジェクト名: MyProject"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"OS: Windows 10"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"プロジェクト名や環境依存の名前などは適時読み替えてください。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"モジュール"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"モジュール"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UE4 においてモジュールとは、エンジンを構成する構成単位そのものです。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"エンジン自体が大きな塊ではなく、機能ごとにモジュールという形で分割されています。また、UE4 においてはプラグインもモジュールとして実装されます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"さらに、エンジンを用いて開発される C++プロジェクトのソースも、新たなモジュールとして扱われます。\n以下にモジュールのイメージ図を示します。\n"},{type:"element",tag:"img",props:{alt:"UE4Archtecture.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fa-little-more-about-the-ue4-module\u002F\u002Fmodule-architecture.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この図を見ていただくと、エンジンとして持っている大量のモジュールの中に、C++プロジェクトで実装した内容が新規モジュールとして追加されている構造がわかりやすいと思います。この C++プロジェクトで実装を行うモジュールのことを、ゲームモジュールといいます。特に、C++プロジェクト作成時にデフォルトで作成されるゲームモジュールのことをプライマリゲームモジュールと呼び、プライマリゲームモジュールはプロジェクトに 1 つしか存在できません。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UE4 におけるビルドは、モジュール単位で行われます。ビルドを行うと、1 モジュールにつき 1 つの"},{type:"element",tag:"code",props:{},children:[{type:"text",value:".dll"}]},{type:"text",value:"、つまりダイナミックリンクライブラリが出力されます。こうしてビルドされたダイナミックリンクライブラリを読み込んでいき、結果として UE4 という大きなシステムが動作していることになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UE4 はこのようなアーキテクチャによって、Unreal C++プログラマがお世話になっている"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ホットリロード"}]},{type:"text",value:"を実現しています。本来 C++のような事前コンパイルを必要とする言語は、対象のプログラムを起動したままソースを再コンパイルして変更を反映するなどもちろんできません。しかし、UE4 ではこのようなモジュール単位でのビルドの仕組みがあるため、UE4 という大きな視点ではプログラムを起動したまま、変更のあったモジュールのみリビルドし、変更前に読み込んでいた dll をアンロード、変更後の dll を"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ホットリロード"}]},{type:"text",value:"しているのです。モジュール様様、動的リンク様様ですね。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"なお、モジュールのビルド結果である dll の場所は、UE4 上で"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"module list"}]},{type:"text",value:"というコマンドを打つと簡単に確認できます。\n"},{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fa-little-more-about-the-ue4-module\u002F\u002Fmodule-list-console.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"ゲームモジュールを追加する意義"},children:[{type:"element",tag:"a",props:{href:"#%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B%E6%84%8F%E7%BE%A9",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"ゲームモジュールを追加する意義"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"プライマリゲームモジュール以外にゲームモジュールを追加作成すべきシチュエーションの例を挙げておきます。\nプロジェクト上で独自のアセットを実装し、ゲーム上で利用するとします。この独自アセットには、エディタ上での作成機能、インポート機能、独自エディタが実装されています。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この時、アセット自体に含まれるプロパティやメソッドは、ゲーム上に必要な情報です。しかし、エディタ機能やインポート機能などは、ゲーム上に必要な情報でしょうか？これはエディタを用いて制作を行う過程において必要な実装情報であって、Shipping ビルドを行ってユーザーにゲームを公開する際には含む必要のない情報です。しかしそんな都合はビルドシステムもコンパイラも察してくれないため、1 つのモジュールに愚直に実装してしまうと、エディタにしか必要のない情報をゲームに含めてしまいます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここで新規モジュールの登場です。UE4 のビルドシステムには、ビルド設定ごとにビルドに含めるモジュールを変更する機能が用意されています。このため、新規モジュールを用意しカスタムエディタや新規作成機能部分のみをこちらに実装、Editor ビルド時にのみ対象とするよう設定すれば、Game ビルド(Shipping ビルドなどのこと)時にはゲームに必要な実装のみを含めることができるようになります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"また、モジュールを分割することでビルド時のリンク速度を上げることができます。ただし、ゲーム実装自体を分割すると、リンク速度の向上とトレードオフとして実行時に読み込む DLL の数が増えるため、ゲームプレイにおいては悪影響を及ぼす恐れがあり（ますと公式に書いてあり）ます。実際の影響の程度は検証を行っていないためわかりませんが、そこまで大きな影響はなさそうな気もします。というか Game ビルド時にはサードパーティ製以外のバイナリは実行ファイルにまとめられているはずですが、モジュール数は影響するんでしょうか？"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"コードの結合度を下げて、使い回しを楽にしやすいという利点もあります。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"モジュールの構成"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E6%A7%8B%E6%88%90",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"モジュールの構成"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"C++プロジェクトを作成すると、Source 以下はこんな構成になっていると思います。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-treeview"]},children:[{type:"element",tag:"code",props:{className:["language-treeview"]},children:[{type:"text",value:"-- Source\n    |-- MyProject\n    |   |-- MyProject.Build.cs\n    |   |-- MyProject.cpp\n    |   `-- MyProject.h\n    |-- MyProject.Target.cs\n    `-- MyProjectEditor.Target.cs\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここで"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject"}]},{type:"text",value:"というディレクトリの中に入っているのが、C++プロジェクト作成時に生成されるプライマリゲームモジュールです。\n"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.cpp"}]},{type:"text",value:", "},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.h"}]},{type:"text",value:"といった C++ファイルはモジュールについての実装を行うために用意されているファイルです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"モジュールファイル"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"モジュールファイル"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここで重要なのは"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Build.cs"}]},{type:"text",value:"という C#ファイルです。このファイルは、モジュールに関する各種設定を行うためのファイルで、モジュールファイルと呼ばれるものです。UE4 でビルドを行う際には、ビルドツールがモジュールファイルを探索し、モジュールを認識することで、モジュールに含まれるコードが適切な設定でビルドされます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"では、デフォルトで生成されている"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Build.cs"}]},{type:"text",value:"を覗いてみましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"MyProject.Build.cs"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"text",value:"\u002F\u002F Fill out your copyright notice in the Description page of Project Settings.\n\nusing UnrealBuildTool;\n\npublic class MyProject : ModuleRules\n{\n\tpublic MyProject(ReadOnlyTargetRules Target) : base(Target)\n\t{\n\t\tPCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs;\n\n\t\tPublicDependencyModuleNames.AddRange(new string[] { \"Core\", \"CoreUObject\", \"Engine\", \"InputCore\" });\n\n\t\tPrivateDependencyModuleNames.AddRange(new string[] {  });\n\t}\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"デフォルトでは、そこまで複雑な設定は行われていません。"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"PublicDependencyModuleNames"}]},{type:"text",value:"というメンバ変数の配列になにか文字列を追加しているところと、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"PCHUsage"}]},{type:"text",value:"というメンバ変数になにか代入しているところだけです。順に説明します。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"配列"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"PublicDependencyModuleNames"}]},{type:"text",value:"は、この"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Build.cs"}]},{type:"text",value:"が示すモジュールが依存するモジュールの名前をセットし、モジュール内で外部の依存するモジュールを利用できるように設定する変数です。依存しているモジュールがここに含まれていないと、ビルド時にエラーが出ます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"PCHUsage"}]},{type:"text",value:"というのは、IWYU(Include-What-You-Use)というシステムの利用方法について設定する変数です。IWYU についてはここでは解説しませんが、簡単に言えば依存関係をいい感じに整理することでビルド速度などを早くしてくれる機能です。詳細は以下の記事とドキュメントを御覧ください。"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"IWYU でコーディングしよう\n"},{type:"element",tag:"a",props:{href:"http:\u002F\u002Fmiyahuji111.hatenablog.com\u002Fentry\u002F2017\u002F04\u002F03\u002F081222",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"http:\u002F\u002Fmiyahuji111.hatenablog.com\u002Fentry\u002F2017\u002F04\u002F03\u002F081222"}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"IWYU リファレンス ガイド\n"},{type:"element",tag:"a",props:{href:"https:\u002F\u002Fapi.unrealengine.com\u002FJPN\u002FProgramming\u002FUnrealBuildSystem\u002FIWYUReferenceGuide\u002Findex.html",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"https:\u002F\u002Fapi.unrealengine.com\u002FJPN\u002FProgramming\u002FUnrealBuildSystem\u002FIWYUReferenceGuide\u002Findex.html"}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここではこの 2 つしか設定が行われていませんが、他にも多くの設定項目が存在します。\n設定可能な項目については以下の記事とドキュメントが詳しいです。"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ModuleRules(XXX.build.cs ファイル)について\n"},{type:"element",tag:"a",props:{href:"https:\u002F\u002Fqiita.com\u002Ftakayashiki2\u002Fitems\u002Fdb995c558024c3db8223",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"https:\u002F\u002Fqiita.com\u002Ftakayashiki2\u002Fitems\u002Fdb995c558024c3db8223"}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"アンリアル ビルド システムのモジュール ファイル\n"},{type:"element",tag:"a",props:{href:"https:\u002F\u002Fapi.unrealengine.com\u002FJPN\u002FProgramming\u002FUnrealBuildSystem\u002FModuleFiles\u002Findex.html",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"https:\u002F\u002Fapi.unrealengine.com\u002FJPN\u002FProgramming\u002FUnrealBuildSystem\u002FModuleFiles\u002Findex.html"}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"設定項目に代入すべき列挙型の中身が不明だったりして困惑することがありますが、そんなときにはエンジンソースに含まれているビルドツールのソースを読みに行きましょう！！"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"ターゲットファイル"},children:[{type:"element",tag:"a",props:{href:"#%E3%82%BF%E3%83%BC%E3%82%B2%E3%83%83%E3%83%88%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"ターゲットファイル"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"Source"}]},{type:"text",value:"の直下にある"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Target.cs"}]},{type:"text",value:","},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProjectEditor.Target.cs"}]},{type:"text",value:"の 2 つの C#ファイルもやはりビルドに関する設定を行うファイルで、ターゲットファイルと呼ばれるものです。これらの中では、上記の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Build.cs"}]},{type:"text",value:"等で発見されたモジュールのうち、”どれを”ビルド対象にするかという設定を行います。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"つまり、モジュールとして完璧な形のコードを作成しても、ここに設定を追記しなければモジュールはビルドに含まれないということです。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"では、なぜこのファイルは 2 つ生成されるのでしょうか。ここで、Game ビルド時と Editor ビルド時で含まれるモジュールを変えられるというところに話が戻ります。\n"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProjectEditor.Target.cs"}]},{type:"text",value:"に設定したモジュールは Editor ビルド時にビルド対象となり、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Target.cs"}]},{type:"text",value:"に設定したモジュールは Game ビルド時にビルド対象となるといったように、使い分けることができます。\n試しに、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Target.cs"}]},{type:"text",value:"の方を見てみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"MyProject.Target.cs"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"text",value:"\u002F\u002F Fill out your copyright notice in the Description page of Project Settings.\n\nusing UnrealBuildTool;\nusing System.Collections.Generic;\n\npublic class MyProjectTarget : TargetRules\n{\n\tpublic MyProjectTarget(TargetInfo Target) : base(Target)\n\t{\n\t\tType = TargetType.Game;\n\n\t\tExtraModuleNames.AddRange( new string[] { \"MyProject\" } );\n\t}\n}\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"まず、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Type"}]},{type:"text",value:"という変数にこの"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Target.cs"}]},{type:"text",value:"によって行われるビルドの種類を指定しています。ちなみに、ビルドツールのコードではこの"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"TargetType"}]},{type:"text",value:"という型は以下のように列挙型として定義されています。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"ビルドツールより抜粋(TargetRules.cs)"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"text",value:"\tpublic enum TargetType\n\t{\n\t\tGame,\n\t\tEditor,\n\t\tClient,\n\t\tServer,\n\t\tProgram,\n\t}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"生成される"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Target.cs"}]},{type:"text",value:","},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProjectEditor.Target.cs"}]},{type:"text",value:"は"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"TargetType"}]},{type:"text",value:"に"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Game"}]},{type:"text",value:","},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Editor"}]},{type:"text",value:"が設定されたターゲットファイルですが、ビルドツールを見るとまだ他にもタイプがあるようです。"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"アンリアルビルド システムのターゲット ファイル\n"},{type:"element",tag:"a",props:{href:"https:\u002F\u002Fapi.unrealengine.com\u002FJPN\u002FProgramming\u002FUnrealBuildSystem\u002FTargetFiles\u002Findex.html",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"https:\u002F\u002Fapi.unrealengine.com\u002FJPN\u002FProgramming\u002FUnrealBuildSystem\u002FTargetFiles\u002Findex.html"}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"公式から引用させていただくと、それぞれこんな意味があるそうです。"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"Game - クック済みデータの実行を要求するスタンドアロン ゲームです。\nClient - Game と同じですが、サーバー コードは含まれません。ネットワーク ゲームに役立ちます。\nServer - Game と同じですが、クライアント コードは含まれません。ネットワーク ゲームのデディケイテッド サーバーに役立ちます。\nEditor - アンリアル エディタを拡張するターゲットです。\nProgram - アンリアル エンジンに加えてビルドされているスタンドアロン ユーティリティ プログラムです。"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"なお、引用元に重大な誤植があったため、引用文は一部修正を加えています。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これだけビルドタイプがあるにも関わらず、デフォルトでは 2 種類分しか生成されないということは、自分でターゲットファイルを追加することができるということです。ターゲットファイルの作成については流石に話がそれすぎるのでここでは解説しません。ちなみに、同じビルドタイプのターゲットファイルを複数作成しても、1 つしか認識されませんのでご注意ください。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"次に、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ExtraModuleNames"}]},{type:"text",value:"です。ここが重要なところで、ビルドターゲットにするモジュールの識別名をセットする配列です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"デフォルトではゲームモジュールがプライマリゲームモジュール 1 つしかないので 1 つしか指定されておらず、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.Target.cs"}]},{type:"text",value:"と"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProjectEditor.Target.cs"}]},{type:"text",value:"どちらも同じ設定になっていますが、前述のような都合でモジュールを追加した場合は大変便利です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"IDE などからビルドを行う際には、ターゲットファイルのクラス名が併記されたビルド設定が生成されているので、対応するものを選択すれば、どちらの設定でビルドを行うか指定することができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"uproject-ファイル"},children:[{type:"element",tag:"a",props:{href:"#uproject-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:".uproject ファイル"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UE4 のプロジェクト直下に生成される"},{type:"element",tag:"code",props:{},children:[{type:"text",value:".uproject"}]},{type:"text",value:"ファイルにもモジュールに関する設定項目が存在します。\n今回生成された"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.uproject"}]},{type:"text",value:"を覗いてみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"MyProject.uproject"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-json"]},children:[{type:"text",value:"{\n\t\"FileVersion\": 3,\n\t\"EngineAssociation\": \"4.22\",\n\t\"Category\": \"\",\n\t\"Description\": \"\",\n\t\"Modules\": [\n\t\t{\n\t\t\t\"Name\": \"MyProject\",\n\t\t\t\"Type\": \"Runtime\",\n\t\t\t\"LoadingPhase\": \"Default\"\n\t\t}\n\t]\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"モジュールに関する項目は"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"\"Modules\""}]},{type:"text",value:"の箇所です。ここには、プロジェクトで定義したモジュールを設定します。モジュールファイルやターゲットファイルには基本的にビルドに関する設定を行ってきましたが、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:".uproject"}]},{type:"text",value:"に記述するのは起動時の読み込み対象のモジュールの識別名です。ここに記述しなくてもビルド対象にすることはできますが、起動時の読み込みやホットリロード等の対象にはなりません。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"また、識別名だけでなく、そのモジュールを読み込む動作タイプと、読み込みタイミングも設定することができます。それぞれ以下のようになっています。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"type"},children:[{type:"element",tag:"a",props:{href:"#type",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Type"}]},{type:"text",value:"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{type:"element",tag:"table",props:{},children:[{type:"element",tag:"thead",props:{},children:[{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"th",props:{},children:[{type:"text",value:"読み込み時タイプ名"}]},{type:"element",tag:"th",props:{},children:[{type:"text",value:"概要"}]}]}]},{type:"element",tag:"tbody",props:{},children:[{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"Runtime"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"通常実行時には読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"RuntimeNoCommandlet"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"実行時、コマンドレットでない場合読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"RuntimeAndProgram"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"実行時かつビルドターゲットが Progarm である場合読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"CookedOnly"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"クックビルドされた後の場合読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"Developer"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"デベロッパツールをサポートしたエンジン上でのみ読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"Editor"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"エディタビルドの場合読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"EditorNoCommandlet"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"エディタビルドかつコマンドレットでない場合読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"Program"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Program ビルドされた場合のみ読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"ServerOnly"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Server ビルドされた場合のみ読み込む"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"ClientOnly"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Client ビルドされた場合のみ読み込む"}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"loadingphase"},children:[{type:"element",tag:"a",props:{href:"#loadingphase",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"LoadingPhase"}]},{type:"text",value:"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{type:"element",tag:"table",props:{},children:[{type:"element",tag:"thead",props:{},children:[{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"th",props:{},children:[{type:"text",value:"読み込み順"}]},{type:"element",tag:"th",props:{},children:[{type:"text",value:"ローディングフェーズ名"}]},{type:"element",tag:"th",props:{},children:[{type:"text",value:"タイミング"}]}]}]},{type:"element",tag:"tbody",props:{},children:[{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"1"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"EarliestPossible"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"可能な限り最も早く読み込みます"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"2"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PostConfigInit"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"エンジン設定の初期化後に読み込みます"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"3"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PreEaryLoadingScreen"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PreLoadingScreen よりも前に読み込みます"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"4"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PreLoadingScreen"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"画面が起動する前に読み込みます"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"5"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PreDefault"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Default の前に読み込みます"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"6"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Default"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"通常のモジュールロードタイミングで読み込みます"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"7"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PostDefault"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"Default の後に読み込みます"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"8"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PostEngineInit"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"エンジンの初期化処理が終了したあとに読み込みます"}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"なお、モジュールを追加する際には以下のようにします。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"MyProject.uproject"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-json"]},children:[{type:"text",value:"{\n\t\"FileVersion\": 3,\n\t\"EngineAssociation\": \"4.22\",\n\t\"Category\": \"\",\n\t\"Description\": \"\",\n\t\"Modules\": [\n\t\t{\n\t\t\t\"Name\": \"MyProject\",\n\t\t\t\"Type\": \"Runtime\",\n\t\t\t\"LoadingPhase\": \"Default\"\n\t\t},\n\t\t{\n\t\t\t\"Name\": \"NewModule\",\n\t\t\t\"Type\": \"Editor\",\n\t\t\t\"LoadingPhase\": \"Default\"\n\t\t}\n\t]\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"なぜビルド設定が-c"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%AA%E3%81%9C%E3%83%93%E3%83%AB%E3%83%89%E8%A8%AD%E5%AE%9A%E3%81%8C-c",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"なぜビルド設定が C#?"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"設定ファイルが C#なのは、UE4 のビルドツールが本体が C#で書かれていることに由来します。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"モジュールファイルや後述のターゲットファイルといった C#による設定ファイルは、Generate ~などのメニューからプロジェクトを生成する際にビルドが行われ、そのプロジェクトにおけるモジュールのビルドルールとなる DLL が生成されます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これをビルドツール本体が動的リンクすることで、C++プロジェクトのゲームモジュールを含めた適切なビルドを行っているんだと思います。（間違っていたらごめんなさい）\n謎のビルドエラーが起こったときに Intermediate を消すと動くのはここにも一因があると思われます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"コンテキストメニュー\n"},{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fa-little-more-about-the-ue4-module\u002F\u002Fbuild-context-menu.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"生成されたビルドルールの DLL\n"},{type:"element",tag:"img",props:{alt:"image.png",src:"\u002Farticle-assets\u002Funrealengine\u002Fa-little-more-about-the-ue4-module\u002F\u002Fbuild-rule-dlls.png"},children:[]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"単なる設定ファイルとしてだけでなく、ビルド時に行いたい処理なども記述できるので結構便利です。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"モジュールの実装を確認してみる"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E5%AE%9F%E8%A3%85%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"モジュールの実装を確認してみる"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここまでモジュールの設定方法とビルドについて詳しく見てきましたが、肝心のモジュールの宣言方法に触れていません。モジュール自体は C++実装なのですから、モジュールの宣言も C++で行ってやる必要があります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"改めてモジュールの構成を示します。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-treeview"]},children:[{type:"element",tag:"code",props:{className:["language-treeview"]},children:[{type:"text",value:"-- Source\n    |-- MyProject\n    |   |-- MyProject.Build.cs\n    |   |-- MyProject.cpp\n    |   `-- MyProject.h\n    |-- MyProject.Target.cs\n    `-- MyProjectEditor.Target.cs\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"C#のファイルたちは皆設定を行うファイルだったので、モジュールの実装を行うのは残った C++ファイル 2 つ、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.h"}]},{type:"text",value:"と"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"MyProject.cpp"}]},{type:"text",value:"です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"とりあえず、デフォルトの状態のこの 2 つのファイルを見てみましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"MyProject.h"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"\u002F\u002F Fill out your copyright notice in the Description page of Project Settings.\n\n#pragma once\n\n#include \"CoreMinimal.h\""}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"MyProject.cpp"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"\u002F\u002F Fill out your copyright notice in the Description page of Project Settings.\n\n#include \"MyProject.h\"\n#include \"Modules\u002FModuleManager.h\"\n\nIMPLEMENT_PRIMARY_GAME_MODULE( FDefaultGameModuleImpl, MyProject, \"MyProject\" );"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"もはや無です。というか、実装らしき箇所が 1 箇所しかありません。\nこれはこの C++プロジェクトが生成した、プライマリゲームモジュールをコードであるため、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_PRIMARY_GAME_MODULE"}]},{type:"text",value:"というマクロで、そのマクロ名の通りプライマリゲームモジュールが実装されています。\nでは、このマクロを含め、モジュール定義のためのマクロたちを紹介します。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"implement_primary_game_module"},children:[{type:"element",tag:"a",props:{href:"#implement_primary_game_module",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"IMPLEMENT_PRIMARY_GAME_MODULE"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これはたった今登場した、プライマリゲームモジュール実装のためのマクロです。\nプライマリゲームモジュールはプロジェクト上に 1 つしか実装できないため、必然的にこのマクロもプロジェクトを通して 1 つのモジュールにしか書くことはありません。逆に、これがないと Shipping ビルドなどのモノリシックビルド時にビルドが通らないんじゃないかと思います。(試してないです)"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-cpp"]},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"IMPLEMENT_PRIMARY_GAME_MODULE"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"ModuleImplClass"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" ModuleName"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" GameName"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"このマクロは、第一引数に"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"モジュールを実装したクラス"}]},{type:"text",value:"、第二引数に"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"モジュール名"}]},{type:"text",value:"、第三引数に"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ゲーム(プロジェクト)名"}]},{type:"text",value:"を取ります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"第一引数に渡すモジュールを実装したクラスは、後述の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IModuleInterface"}]},{type:"text",value:"というインターフェイスを継承して実装したモジュールクラスを渡すことができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"第二引数に渡すモジュール名は、他のモジュールやエンジン上からこのモジュールを識別する際の名称として使われる文字列を決定します。実装クラスと同じ名前である必要はありません。例えば、ターゲットファイルの"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ExtraModuleNames"}]},{type:"text",value:"に渡していたのはここで決定される識別名です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"第三引数はゲーム(プロジェクト)名を渡すのですが、実装を覗くと、この第三引数はもう利用されていません。昔はここに渡したゲーム名を利用した処理が行われていたようなのですが、現在は"},{type:"element",tag:"code",props:{},children:[{type:"text",value:".uproject"}]},{type:"text",value:"ファイルから自動的にプロジェクト名をパースしてくるようで、コード上でも廃止予定とされています。おそらく残っているのは後方互換性のためでしょう。現状も値を渡さなければエラーが出ますが、実際は文字列さえ渡しておけば良いと思われます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"implement_game_module"},children:[{type:"element",tag:"a",props:{href:"#implement_game_module",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"IMPLEMENT_GAME_MODULE"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"こちらはゲームモジュールを実装するためのマクロです。ゲームモジュールはプライマリゲームモジュールと異なり、プロジェクト上に複数個実装することが可能なため、このマクロも複数のモジュールに書くことができます。ゲームコードを含むモジュールはこれで実装しましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-cpp"]},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"IMPLEMENT_GAME_MODULE"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"ModuleImplClass"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" ModuleName"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"第一引数と第二引数はプライマリゲームモジュールの場合と同じで、実装クラスとその識別名を与えます。\n(プライマリゲームモジュールの第三引数は廃止予定だったので、中身は異なりますが渡しているものは実質同じですね。)"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"implement_module"},children:[{type:"element",tag:"a",props:{href:"#implement_module",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"IMPLEMENT_MODULE"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"こちらはシンプルなモジュールを実装するためのマクロです。ゲームコードを含まないモジュールはこのマクロで実装されます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-cpp"]},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"IMPLEMENT_MODULE"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"ModuleImplClass"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" ModuleName"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"渡している引数は"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_GAME_MODULE"}]},{type:"text",value:"と同様です。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここで使われている"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_PRIMARY_GAME_MODULE"}]},{type:"text",value:"というマクロはプライマリゲームモジュールを実装する(implement なので)マクロなのですが、実は初期状態では、はじめから用意されている"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"FDefaultGameModuleImpl"}]},{type:"text",value:"という最低限のクラスをゲームモジュールとして利用(代用？)しているだけです。もっとモジュールクラス自体に機能を持たせるために用意されている手段は後述しますので、とりあえず"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"FDefaultGameModuleImpl"}]},{type:"text",value:"の中身を見てみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"モジュール実装マクロの余談"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E5%AE%9F%E8%A3%85%E3%83%9E%E3%82%AF%E3%83%AD%E3%81%AE%E4%BD%99%E8%AB%87",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"モジュール実装マクロの余談"}]},{type:"text",value:"\n"},{type:"element",tag:"font",props:{color:"darkred"},children:[{type:"text",value:"\n"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"この節には不確定要素が多いです。"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n\nここまで紹介してきたモジュール実装のためのマクロたちですが、実装を見るとこれらはビルド方式によって内部処理が変動しているようです。プラットフォームなどによる変動はもちろんあるのですが、最も大きいのが**Monolithic(一枚岩)\n"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"と"}]},{type:"text",value:"\nModular(まとまりごと)**という 2 種類のリンクタイプのによる違いです。\nリンクがわからない方は詳しくは調べてほしいのですが、ざっくり言えばコンパイルした複数のファイルや必要なライブラリを正しく関連付ける作業です。\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この 2 つのリンクタイプによって生まれるビルドの結果は「ビルド結果として得られるバイナリが実行ファイルにまとまっているか、多量の.dll などに分散しているか」の違いがあります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"パッケージングのビルドや Game ビルド(Shipping ビルド)などは実行ファイルとしてバイナリがまとまるため"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"Monolithic"}]},{type:"text",value:"で行われて、Editor ビルドの際などは.dll としてバイナリがモジュールごとに生成されるため"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"Modular"}]},{type:"text",value:"で行われていることがわかります。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"そして、Modular でリンクが行われる際、前述の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_MODULE"}]},{type:"text",value:","},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_GAME_MODULE"}]},{type:"text",value:","},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_PRIMARY_GAME_MODULE"}]},{type:"text",value:"の 3 つのモジュール実装マクロの内部処理に"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"差はありません"}]},{type:"text",value:"。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"すべての実装マクロが、リンクタイプが Modular 時の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_MODULE"}]},{type:"text",value:"の処理へと渡されています。これは推測ですが、Modular すなわち Editor 上で開発を行っている際には、エンジンというソフトウェアの管理はエンジン側にあるため、ゲームモジュールを含めすべてのモジュールは内部的には同等のプログラムとして扱われているのではないでしょうか。確かに、Game ビルド時のようにプライマリゲームモジュール中心で動作していたら、それ自身のホットリロードは困難な気がします。(怪しいです。違ったら指摘してほしいところ No.1 です)"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"一方 Monolithic 時の実装は"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_PRIMARY_GAME_MODULE"}]},{type:"text",value:"が独自の複雑な処理に変わったり、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_MODULE"}]},{type:"text",value:"の処理からホットリロードの処理が外されたりしています。しかし、実装を見る限りでは"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_MODULE"}]},{type:"text",value:"と"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_GAME_MODULE"}]},{type:"text",value:"の間にはこちらでも差異は見られない気がします……。というか、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_GAME_MODULE"}]},{type:"text",value:"の実装は常に以下になっています。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"ModuleManager.hより抜粋"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"#define IMPLEMENT_GAME_MODULE( ModuleImplClass, ModuleName ) \\\n\tIMPLEMENT_MODULE( ModuleImplClass, ModuleName )"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"うーん。各所の説明を読むと別のものとされているのですが、表面上のものなのでしょうか？有識者の方、教えて下さい。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"モジュールクラスについて"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"モジュールクラスについて"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここでは、モジュール実装マクロに渡すモジュールクラスについて触れます。\n例として、デフォルトで生成された"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IMPLEMENT_PRIMARY_GAME_MODULE"}]},{type:"text",value:"に渡されていた"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"FDefaultGameModuleImpl"}]},{type:"text",value:"クラスの実装に注目しましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"ModuleManager.hより抜粋"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"class FDefaultModuleImpl\n\t: public IModuleInterface\n{ };\n\nclass FDefaultGameModuleImpl\n\t: public FDefaultModuleImpl\n{\n\tvirtual bool IsGameModule() const override\n\t{\n\t\treturn true;\n\t}\n};"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここからわかることは、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IModuleInterface"}]},{type:"text",value:"というクラス(インターフェイス?)を継承して、先程の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"FDefaultGameModuleImpl"}]},{type:"text",value:"は作られていたということです。そして、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"FDefaultGameModuleImpl"}]},{type:"text",value:"は唯一つ、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IsGameModule"}]},{type:"text",value:"という"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"bool"}]},{type:"text",value:"を返すメソッドで"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"true"}]},{type:"text",value:"を返すというオーバーライドが実装されています。"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IsGameModule"}]},{type:"text",value:"はその名と型の通り、自らがゲームモジュールである場合"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"true"}]},{type:"text",value:"を返すよう設定するためのメソッドです。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここではこれ 1 つのみですが、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"IModuleInterface"}]},{type:"text",value:"が宣言・定義されている"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ModuleInterface.h"}]},{type:"text",value:"の実装を覗くと、他のオーバーライド可能なメソッドを知ることができます。自分でゲームモジュールを追加で宣言する場合には、このあたりを利用することが多いため、一度目を通しておくと良いです。一応ドキュメントもありますが、実装ファイル以上の情報はありません。"}]},{type:"text",value:"\n"},{type:"element",tag:"blockquote",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"IModuleInterface\n"},{type:"element",tag:"a",props:{href:"https:\u002F\u002Fapi.unrealengine.com\u002FINT\u002FAPI\u002FRuntime\u002FCore\u002FModules\u002FIModuleInterface\u002Findex.html",rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:"text",value:"https:\u002F\u002Fapi.unrealengine.com\u002FINT\u002FAPI\u002FRuntime\u002FCore\u002FModules\u002FIModuleInterface\u002Findex.html"}]}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"モジュール実装に多用されるメソッド"},children:[{type:"element",tag:"a",props:{href:"#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E5%AE%9F%E8%A3%85%E3%81%AB%E5%A4%9A%E7%94%A8%E3%81%95%E3%82%8C%E3%82%8B%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"モジュール実装に多用されるメソッド"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"IModuleInterface"}]},{type:"text",value:"には、設定項目的なメソッド以外にも、モジュールの実装にあたって非常に重要なメソッドがいくつか定義されています。\nそれらをオーバライドすることで、独自モジュール実装に利用することができます。ここでは、特に使用頻度の高いメソッドについて触れます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"startupmodule"},children:[{type:"element",tag:"a",props:{href:"#startupmodule",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"StartupModule"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"モジュールの DLL がロードが開始された直後に呼び出されるメソッドです。モジュールのオブジェクトが作成されて真っ先に呼び出されると考えれば良いです。ここには、依存関係にあるモジュールの読み込みや、このモジュールで行う実装の初期化処理などを行うことができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"postloadcallback"},children:[{type:"element",tag:"a",props:{href:"#postloadcallback",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"PostLoadCallback"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"モジュールのロードが後に実行されるメソッドです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"shutdonwmodule"},children:[{type:"element",tag:"a",props:{href:"#shutdonwmodule",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"ShutdonwModule"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"モジュールが完全にアンロードされる直前に呼び出されます。終了時処理などを行うことができます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"preunloadcallback"},children:[{type:"element",tag:"a",props:{href:"#preunloadcallback",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"PreUnloadCallback"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"モジュールのアンロード開始前に呼び出されるメソッドです。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"この 4 つのメソッドを以下のような実装でオーバーライドしてビルドの上、ホットリロードが行われた場合の出力を確認してみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"実装例.cpp"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-cpp"]},children:[{type:"text",value:"\n\u002F*\n** このコードは単体では動作しません。また、ShutdownModuleとPreUnloadCallbackについては\n** 前回ビルドの結果が出力されるため、2回以上リビルドしなければ後述の出力は得られません。\n*\u002F\n\nclass FMyProjectModule : public FDefaultGameModuleImpl\n{\npublic:\n    virtual void StartupModule() override\n    {\n        UE_LOG(LogTemp, Log, TEXT(\"StartupModule\"))\n    }\n\n    virtual void PostLoadCallback() override\n    {\n        UE_LOG(LogTemp, Log, TEXT(\"PostLoadCallback\"))\n    }\n\n    virtual void ShutdownModule() override\n    {\n        UE_LOG(LogTemp, Log, TEXT(\"ShutdonwModule\"))\n    }\n\n    virtual void PreUnloadCallback() override\n    {\n        UE_LOG(LogTemp, Log, TEXT(\"PreUnloadCallback\"))\n    }\n};\n\nIMPLEMENT_PRIMARY_GAME_MODULE(FMyProjectModule, MyProjectModule, \"MyProject\")\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"ホットリロード時の出力"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-text"]},children:[{type:"text",value:"LogTemp: PreUnloadCallback\nLogTemp: ShutdonwModule\nLogTemp: StartupModule\nLogTemp: PostLoadCallback"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"つまり、以下のような実行順で実行されるということがわかります。"}]},{type:"text",value:"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{type:"element",tag:"table",props:{},children:[{type:"element",tag:"thead",props:{},children:[{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"th",props:{},children:[{type:"text",value:"実行順"}]},{type:"element",tag:"th",props:{},children:[{type:"text",value:"メソッド名"}]}]}]},{type:"element",tag:"tbody",props:{},children:[{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"1"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"StartupModule"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"2"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PostLoadCallback"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"-"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"(モジュール動作中)"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"3"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"PreUnloadCallback"}]}]},{type:"element",tag:"tr",props:{},children:[{type:"element",tag:"td",props:{},children:[{type:"text",value:"4"}]},{type:"element",tag:"td",props:{},children:[{type:"text",value:"ShutdonwModule"}]}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これらは本当によく使うため、覚えておきましょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"まとめ"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%BE%E3%81%A8%E3%82%81",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"まとめ"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"UE4 はモジュールの集合体！"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"モジュールには種類があって、使い分ける"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"モジュールは自作できる。"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"モジュール実装のための便利なものが親として提供されているから、頑張って使いこなそう！"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"おわりに"},children:[{type:"element",tag:"a",props:{href:"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB",ariaHidden:"true",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"おわりに"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"粗く長くやりましたが、モジュールの宣言のされかたやビルドツールとの関わりなどが少しわかっていただけたら嬉しいです。"}]}]},dir:"\u002Farticles\u002Funrealengine",path:"\u002Farticles\u002Funrealengine\u002Fa-little-more-about-the-ue4-module",extension:".md",createdAt:"2019-07-28T00:00:00.000Z",updatedAt:"2019-10-29T00:00:00.000Z",gitCreatedAt:"2021-11-25T20:46:01.000Z",gitUpdatedAt:"2022-01-29T00:45:39.000Z"},{slug:"the-process-to-start-building-with-the-unreal-build-tool-in-ue4",description:"UBTが各種ビルドモードを開始するまでにしていることについて調べたやつ",title:"UE4のUnreal Build Toolのビルド開始までの流れについて",enforceCreatedAt:"2019\u002F6\u002F14",enforceUpdatedAt:"2019\u002F6\u002F15",tags:["Unreal Engine","Unreal Build Tool"],toc:[{id:"エントリーポイント",depth:2,text:"エントリーポイント"},{id:"コマンドライン引数のパース",depth:3,text:"コマンドライン引数のパース"},{id:"動作モードと動作オプションの取得",depth:3,text:"動作モードと動作オプションの取得"},{id:"各種設定処理",depth:3,text:"各種設定処理"},{id:"処理実行",depth:3,text:"処理実行"}],body:{type:"root",children:[{type:"element",tag:"h1",props:{id:"概要"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E6%A6%82%E8%A6%81",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"概要"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"別の UE4 のリフレクションについての記事を調べながら書こうとしていたのですが、ビルドツール周りについての項で既に肥大化しそうだったので別記事にすることにしました。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここに書いてあるのはビルドツール全体の話ではなく、ビルドツールがビルドを開始するまでの流れと概要についてのメモです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"環境"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E7%92%B0%E5%A2%83",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"環境"}]},{type:"text",value:"\n"},{type:"element",tag:"ul",props:{},children:[{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"Unreal Engine 4.22.2"}]},{type:"text",value:"\n"},{type:"element",tag:"li",props:{},children:[{type:"text",value:"Windows 10"}]},{type:"text",value:"\n"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"文章中にソースコードの行数や関数・変数名等が登場しますが、これらは上述の環境におけるものですので、他の環境においては変動する可能性があります。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"unreal-build-tool-ubt"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#unreal-build-tool-ubt",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"Unreal Build Tool (UBT)"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UE4 には独自のビルドツールが搭載されており、このビルドツールがいろいろやってくれていることで UE4 上での C++コーディングがとても楽になっています。例えば、UE4 で C++を使って実装したアクタのプロパティがエンジンの詳細パネルからアクセスできたり、BP 上で関数が呼び出せたりといったような機能はこのビルドツール(と、Unreal Header Tools)があるおかげです。\nそもそも UnrealC++の構文機能は C++の標準機能を飛び出しているので、こいつが前処理してくれないとコンパイルにかけることすらできません。\nまあそんなすごいことをやっているビルドツール(笑)なので、単にビルド設定をしているとかファイルを管理してるとか以上のことをやっており、ここの中身を少しでも知っておけばいろいろ楽なんじゃなかろうかと思うわけです。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"呼び出しを追っていく"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%82%92%E8%BF%BD%E3%81%A3%E3%81%A6%E3%81%84%E3%81%8F",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"呼び出しを追っていく"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"まず、UBT のソースコードはエンジンがインストールされているディレクトリから"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-unknown"]},children:[{type:"element",tag:"code",props:{className:["language-unknown"]},children:[{type:"text",value:"Engine\\Source\\Programs\\UnrealBuildTool"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"と辿っていくと見つかります。ここには何やらいろんなディレクトリがあり、それぞれの中にも大量のコードがあります。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-treeview"]},children:[{type:"element",tag:"code",props:{className:["language-treeview"]},children:[{type:"text",value:"UnrealBuildTool\n|-- Configuration\n|-- DotNetCore\n|-- Executors\n|-- Modes\n|-- Platform\n|-- ProjectFiles\n|-- Properties\n|-- System\n|-- ToolChain\n|-- UnrealBuildTool.cs\n|-- UnrealBuildTool.csproj\n|-- app.config\n`-- app.manifest\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h2",props:{id:"エントリーポイント"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E3%82%A8%E3%83%B3%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"エントリーポイント"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"UBT のエントリーポイントは、UBT のコードがあるディレクトリにある"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"UnrealBuildTool.cs"}]},{type:"text",value:"内の Main 関数です。\nそれなりに長いので、ビルドに直接関係しそうなところだけ抜き出して、コメントを翻訳・追記してみます。\nかなり削っているので、いろんなオプション機能や例外処理、パフォーマンス計測用のコードが消えています。ご注意ください。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"UnreaalBuildTool.csのMain関数"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"text",value:"\t\tprivate static int Main(string[] ArgumentsArray)\n\t\t{\n\t\t\t\u002F\u002F Mutex保持用変数\n\t\t\tSingleInstanceMutex Mutex = null;\n\n            \u002F\u002F コマンドライン引数をパース\n            CommandLineArguments Arguments = new CommandLineArguments(ArgumentsArray);\n\n            \u002F\u002F グローバル設定をパース\n            GlobalOptions Options = new GlobalOptions(Arguments);\n\n            \u002F\u002F ビルドを行うディレクトリを Engine\u002FSource に変更します。\n            DirectoryReference.SetCurrentDirectory(UnrealBuildTool.EngineSourceDirectory);\n\n            \u002F\u002Fビルド設定とビルド管理を保持するクラスの型情報を取得\n            Type ModeType = typeof(BuildMode);\n\n            \u002F\u002F 動作モードの指定がされていた場合、動作モードに該当するクラスを探索して型情報をModeTypeに格納する\n            if(Options.Mode != null)\n            {\n                \u002F\u002F すべての有効なモードを探索\n                Dictionary\u003Cstring, Type\u003E ModeNameToType = new Dictionary\u003Cstring, Type\u003E(StringComparer.OrdinalIgnoreCase);\n                foreach(Type Type in Assembly.GetExecutingAssembly().GetTypes())\n                {\n                    if(Type.IsClass && !Type.IsAbstract && Type.IsSubclassOf(typeof(ToolMode)))\n                    {\n                        ToolModeAttribute Attribute = Type.GetCustomAttribute\u003CToolModeAttribute\u003E();\n                        ModeNameToType.Add(Attribute.Name, Type);\n                    }\n                }\n                \u002F\u002F モードの設定を行う\n                ModeNameToType.TryGetValue(Options.Mode, out ModeType)\n            }\n\n            \u002F\u002F ビルドモードクラスの属性に設定されているオプションを取得\n            ToolModeOptions ModeOptions = ModeType.GetCustomAttribute\u003CToolModeAttribute\u003E().Options;\n\n            \u002F\u002F エンジンのコンテンツ(ソースコードなど)のプリフェッチ(事前読み込み)オプションが有効化されていれば開始\n            if((ModeOptions & ToolModeOptions.StartPrefetchingEngine) != 0)\n            {\n                FileMetadataPrefetch.QueueEngineDirectory();\n            }\n\n            \u002F\u002F XMLの設定ファイル読み込みが有効化されていれば読み込み\n            if((ModeOptions & ToolModeOptions.XmlConfig) != 0)\n            {\n                string XmlConfigMutexName = SingleInstanceMutex.GetUniqueMutexForPath(\"UnrealBuildTool_Mutex_XmlConfig\", Assembly.GetExecutingAssembly().CodeBase);\n                using(SingleInstanceMutex XmlConfigMutex = new SingleInstanceMutex(XmlConfigMutexName, true))\n                {\n                    FileReference XmlConfigCache = Arguments.GetFileReferenceOrDefault(\"-XmlConfigCache=\", null);\n                    XmlConfig.ReadConfigFiles(XmlConfigCache);\n                }\n            }\n\n            \u002F\u002F SingleInstance(コードに対して複数のビルドが同時実行できない設定)が有効になっていれば、Mutexを設定\n            if((ModeOptions & ToolModeOptions.SingleInstance) != 0 && !Options.bNoMutex)\n            {\n                string MutexName = SingleInstanceMutex.GetUniqueMutexForPath(\"UnrealBuildTool_Mutex\", Assembly.GetExecutingAssembly().CodeBase);\n                Mutex = new SingleInstanceMutex(MutexName, Options.bWaitMutex);\n            }\n\n            \u002F\u002F すべてのプラットフォームに対してのビルドを登録する場合としない場合の設定\n            if((ModeOptions & ToolModeOptions.BuildPlatforms) != 0)\n            {\n                UEBuildPlatform.RegisterPlatforms(false);\n            }\n            if((ModeOptions & ToolModeOptions.BuildPlatformsForValidation) != 0)\n            {\n                UEBuildPlatform.RegisterPlatforms(true);\n            }\n\n            \u002F\u002F 設定されたモードから適切なハンドラを生成\n            ToolMode Mode = (ToolMode)Activator.CreateInstance(ModeType);\n\n            \u002F\u002F ハンドラに設定されたモードを実行\n            int Result = Mode.Execute(Arguments);\n\n            \u002F\u002F ビルド所要時間の表示が有効であれば表示\n            if((ModeOptions & ToolModeOptions.ShowExecutionTime) != 0)\n            {\n\t            \u002F\u002F 表示用コード　省略\n            }\n\n            return Result;\n\t\t}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これがビルドツールのエントリーポイントです。もう少し詳しく見ていきます。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"コマンドライン引数のパース"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E5%BC%95%E6%95%B0%E3%81%AE%E3%83%91%E3%83%BC%E3%82%B9",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"コマンドライン引数のパース"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"まず、コマンドライン引数のパース部です。ここに関してはやってることはそのままですね。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-csharp"]},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F コマンドライン引数をパース"}]},{type:"text",value:"\n       "},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"CommandLineArguments"}]},{type:"text",value:" Arguments "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"new"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","class-name","constructor-invocation"]},children:[{type:"text",value:"CommandLineArguments"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"ArgumentsArray"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n\n       "},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F グローバル設定をパース"}]},{type:"text",value:"\n       "},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"GlobalOptions"}]},{type:"text",value:" Options "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"new"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","class-name","constructor-invocation"]},children:[{type:"text",value:"GlobalOptions"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Arguments"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"element",tag:"code",props:{},children:[{type:"text",value:"CommandLineArguments"}]},{type:"text",value:"という便利なクラスが"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Engine\u002FSource\u002FPrograms\u002FDotNETCommon\u002FDotNETUtilities\u002FCommandLineArguments.cs"}]},{type:"text",value:"に定義されていて、こいつにコマンドラインから受け取った引数配列を渡すだけでいい感じにしてくれているようです。\nそして、いい感じの形にしたコマンドライン引数の情報を、これまた"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"GlobalOptions"}]},{type:"text",value:"という便利なクラスに渡しています。こちらは Main と同じ"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"UnrealBuildTool.cs"}]},{type:"text",value:"内にいます。"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"GlobalOptions"}]},{type:"text",value:"はその名の通り設定情報を保持するクラスなのですが、そのコンストラクタは引数として"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"CommandLineArguments"}]},{type:"text",value:"を受け取る仕様になっています。該当コンストラクタを抜き出してきました。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"UnreaalBuildTool.csのGlobalOptionsのコンストラクタ"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"text",value:"\tpublic GlobalOptions(CommandLineArguments Arguments)\n\t{\n\t\tArguments.ApplyTo(this);\n\t\tif (!string.IsNullOrEmpty(RemoteIni))\n\t\t{\n\t\t\tUnrealBuildTool.SetRemoteIniPath(RemoteIni);\n\t\t}\n\t}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"やっていることは渡された"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"CommandLineArguments"}]},{type:"text",value:"のインスタンスが持っている"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ApplyTo()"}]},{type:"text",value:"を、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"GlobalOptions"}]},{type:"text",value:"自らに対して適用させるというのが主なようです。ついでに"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"-remoteini"}]},{type:"text",value:"が指定されている場合の処理もここでやっていますね。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここで設定の適用された"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"GlobalOptions"}]},{type:"text",value:"が出来上がり、Main の方でそれを取得しているんですね。"}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"動作モードと動作オプションの取得"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E5%8B%95%E4%BD%9C%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A8%E5%8B%95%E4%BD%9C%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%8F%96%E5%BE%97",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"動作モードと動作オプションの取得"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"個人的にここの処理がモダンな言語の暴力といった感じで好きです。\nここでは指定された動作モードに対応するクラスを取得してくる処理をしているわけなんですが、なかなかアクロバティックです。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-csharp"]},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F初期値としてビルド設定とビルド管理を保持するクラスの型情報を取得"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"Type"}]},{type:"text",value:" ModeType "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"typeof"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","class-name","type-expression"]},children:[{type:"text",value:"BuildMode"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F 動作モードの指定がされていた場合、動作モードに該当するクラスを探索して型情報をModeTypeに格納する"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Options"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"Mode "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"!="}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"null"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F すべての有効なモードを探索"}]},{type:"text",value:"\n    "},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"Dictionary"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003C"}]},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"string"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003E"}]}]},{type:"text",value:" ModeNameToType "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"new"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","class-name","constructor-invocation"]},children:[{type:"text",value:"Dictionary"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003C"}]},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"string"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003E"}]}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"StringComparer"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"OrdinalIgnoreCase"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"foreach"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"Type"}]},{type:"text",value:" Type "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" Assembly"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"GetExecutingAssembly"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"GetTypes"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n    "},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n        "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"IsClass "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"&&"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"!"}]},{type:"text",value:"Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"IsAbstract "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"&&"}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"IsSubclassOf"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"typeof"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","class-name","type-expression"]},children:[{type:"text",value:"ToolMode"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n        "},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n            "},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"ToolModeAttribute"}]},{type:"text",value:" Attribute "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","generic-method"]},children:[{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"GetCustomAttribute"}]},{type:"element",tag:"span",props:{className:["token","class-name","generic"]},children:[{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003C"}]},{type:"text",value:"ToolModeAttribute"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003E"}]}]}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n            ModeNameToType"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"Add"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Attribute"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"Name"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        "},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n    "},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n\n    "},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F モードの設定を行う"}]},{type:"text",value:"\n    ModeNameToType"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"TryGetValue"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Options"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"Mode"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"out"}]},{type:"text",value:" ModeType"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"まず、Type 型(型情報を持つやつ)の ModeType 変数を宣言しています。初期値はビルドモードを保持する"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BuildMode"}]},{type:"text",value:"クラスです。\n"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BuildMode"}]},{type:"text",value:"クラスは"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Engine\u002FSource\u002FPrograms\u002FUnrealBuildTool\u002FModes"}]},{type:"text",value:"にある"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"BuoldMode.cs"}]},{type:"text",value:"に宣言されているクラスなのですが、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Engine\u002FSource\u002FPrograms\u002FUnrealBuildTool\u002FModes"}]},{type:"text",value:"には他にも似たようなファイルがあります。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-treeview"]},children:[{type:"element",tag:"code",props:{className:["language-treeview"]},children:[{type:"text",value:"Modes\u002F\n|-- BuildMode.cs\n|-- CleanMode.cs\n|-- DeployMode.cs\n|-- GenerateProjectFilesMode.cs\n|-- JsonExportMode.cs\n|-- SetupPlatformsMode.cs\n|-- ValidatePlatformsMode.cs\n|-- WriteDocumentationMode.cs\n`-- WriteMetadataMode.cs\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"これらのファイルにはすべて、"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ToolMode"}]},{type:"text",value:"という抽象クラスを継承した各モードのクラスの実装が行われています。そして、これらのクラスは当然、C#で記述されたビルドツールがコンパイルされるときにビルドツール自体のバイナリの中に取り込まれます。\nこれを念頭に置いて、上記の処理からモードの探索部分を改めてみてみます。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-csharp"]},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F すべての有効なモードを探索"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"Dictionary"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003C"}]},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"string"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003E"}]}]},{type:"text",value:" ModeNameToType "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"new"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","class-name","constructor-invocation"]},children:[{type:"text",value:"Dictionary"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003C"}]},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"string"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003E"}]}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"StringComparer"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"OrdinalIgnoreCase"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"foreach"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"Type"}]},{type:"text",value:" Type "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"in"}]},{type:"text",value:" Assembly"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"GetExecutingAssembly"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"GetTypes"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"IsClass "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"&&"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"!"}]},{type:"text",value:"Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"IsAbstract "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"&&"}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"IsSubclassOf"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"typeof"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","class-name","type-expression"]},children:[{type:"text",value:"ToolMode"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n    "},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n        "},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"ToolModeAttribute"}]},{type:"text",value:" Attribute "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","generic-method"]},children:[{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"GetCustomAttribute"}]},{type:"element",tag:"span",props:{className:["token","class-name","generic"]},children:[{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003C"}]},{type:"text",value:"ToolModeAttribute"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003E"}]}]}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n        ModeNameToType"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"Add"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Attribute"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"Name"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" Type"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n    "},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここでは、はじめにモード名文字列をキーにとり、対応するモードが実装されたクラスの型情報を値に持つ連想配列を宣言しています。\nそして次に、"},{type:"element",tag:"strong",props:{},children:[{type:"text",value:"ビルドツール自らのバイナリ内に宣言されている全ての public な型の情報を実行時に取得して"}]},{type:"text",value:"、その中から抽象クラス ToolMode を継承している型を抜き出し、そのクラスに設定されている Attribute(属性)情報からモード名を取得、ディクショナリに情報を追加しています。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"クラスの属性については、以下のように各モードクラスの頭に宣言されています。僕はあまり C#を書かないので、C#にこんな属性の記法があることを初めて知りました。UnrealC++の記法ってやっぱり C#リスペクトあるんですかね。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-csharp"]},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"["}]},{type:"element",tag:"span",props:{className:["token","attribute"]},children:[{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"ToolMode"}]},{type:"element",tag:"span",props:{className:["token","attribute-arguments"]},children:[{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","string"]},children:[{type:"text",value:"\"Build\""}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" ToolModeOptions"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"XmlConfig "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"|"}]},{type:"text",value:" ToolModeOptions"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"BuildPlatforms "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"|"}]},{type:"text",value:" ToolModeOptions"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"SingleInstance "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"|"}]},{type:"text",value:" ToolModeOptions"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"StartPrefetchingEngine "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"|"}]},{type:"text",value:" ToolModeOptions"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"ShowExecutionTime"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]}]}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"]"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"class"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"BuildMode"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:":"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","type-list"]},children:[{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"ToolMode"}]}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F略"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"おそらくこの機構により、他の部分に一切手を加えなくても"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Engine\u002FSource\u002FPrograms\u002FUnrealBuildTool\u002FModes"}]},{type:"text",value:"に新たなモードのクラスを実装したファイルを追加して引数のパース部にオプションを増やすだけでモードを増やせるようにしているのでしょう。"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"最後に、コマンドライン引数で指定されたモードに該当するモードが探索結果のディクショナリにあったら ModeType に参照渡しで設定して完璧です。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-csharp"]},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F モードの設定を行う"}]},{type:"text",value:"\nModeNameToType"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"TryGetValue"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Options"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"Mode"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:","}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"out"}]},{type:"text",value:" ModeType"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"各種設定処理"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E5%90%84%E7%A8%AE%E8%A8%AD%E5%AE%9A%E5%87%A6%E7%90%86",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"各種設定処理"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"ここでは、ここまでに取得した情報から各種設定を行っています。やっているだけな感じの処理が大半なので、コードは冒頭のみにします。前述の全文の方を御覧ください。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-csharp"]},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F ビルドモードクラスの属性に設定されているオプションを取得"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"ToolModeOptions"}]},{type:"text",value:" ModeOptions "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" ModeType"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","generic-method"]},children:[{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"GetCustomAttribute"}]},{type:"element",tag:"span",props:{className:["token","class-name","generic"]},children:[{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003C"}]},{type:"text",value:"ToolModeAttribute"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"\u003E"}]}]}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"Options"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F エンジンのコンテンツ(ソースコードなど)のプリフェッチ(事前読み込み)オプションが有効化されていれば開始。"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"if"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"ModeOptions "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"&"}]},{type:"text",value:" ToolModeOptions"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"text",value:"StartPrefetchingEngine"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"!="}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","number"]},children:[{type:"text",value:"0"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"{"}]},{type:"text",value:"\n    FileMetadataPrefetch"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"QueueEngineDirectory"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"}"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F XMLの設定ファイル読み込みが有効化されていれば読み込み"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F 略"}]},{type:"text",value:"\n\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F SingleInstance(コードに対して複数のビルドが同時実行できない設定)が有効になっていれば、Mutexを設定"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F 略"}]},{type:"text",value:"\n\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F すべてのプラットフォームに対してのビルドを登録する場合としない場合の設定"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F 略"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"h3",props:{id:"処理実行"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E5%87%A6%E7%90%86%E5%AE%9F%E8%A1%8C",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"処理実行"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"いよいよ情報が揃ったので、実行箇所です。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["remark-highlight"]},children:[{type:"element",tag:"pre",props:{className:["language-csharp"]},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F 設定されたモードから適切なハンドラを生成"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"text",value:"ToolMode"}]},{type:"text",value:" Mode "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" "},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"ToolMode"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"text",value:"Activator"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"CreateInstance"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"ModeType"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n\n"},{type:"element",tag:"span",props:{className:["token","comment"]},children:[{type:"text",value:"\u002F\u002F ハンドラに設定されたモードを実行"}]},{type:"text",value:"\n"},{type:"element",tag:"span",props:{className:["token","class-name"]},children:[{type:"element",tag:"span",props:{className:["token","keyword"]},children:[{type:"text",value:"int"}]}]},{type:"text",value:" Result "},{type:"element",tag:"span",props:{className:["token","operator"]},children:[{type:"text",value:"="}]},{type:"text",value:" Mode"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"."}]},{type:"element",tag:"span",props:{className:["token","function"]},children:[{type:"text",value:"Execute"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:"("}]},{type:"text",value:"Arguments"},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:")"}]},{type:"element",tag:"span",props:{className:["token","punctuation"]},children:[{type:"text",value:";"}]},{type:"text",value:"\n"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"モードに合わせたクラスの型情報を持っている"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ModeType"}]},{type:"text",value:"をもとにインスタンスを作成し、抽象クラスである"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ToolMode"}]},{type:"text",value:"にアップキャストしてハンドラ用の"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"Mode"}]},{type:"text",value:"変数に格納しています。今更ですが、抽象クラス"},{type:"element",tag:"code",props:{},children:[{type:"text",value:"ToolMode"}]},{type:"text",value:"の中身はこんな感じです。"}]},{type:"text",value:"\n"},{type:"element",tag:"div",props:{className:["code-extra"]},children:[{type:"element",tag:"div",props:{className:["filename"]},children:[{type:"text",value:"ToolMode.csのToolModeクラス"}]},{type:"element",tag:"pre",props:{},children:[{type:"element",tag:"code",props:{className:["language-csharp"]},children:[{type:"text",value:"abstract class ToolMode\n{\n\tpublic abstract int Execute(CommandLineArguments Arguments);\n}"}]}]}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"嘘ではないですがハンドラ(実行しかできない)みたいな感じがすごいですね。\nまあ、そんな感じでこれを通して各モードの実装が実行されるわけですね。"}]},{type:"text",value:"\n"},{type:"element",tag:"h1",props:{id:"いったんまとめ"},children:[{type:"element",tag:"a",props:{ariaHidden:"true",href:"#%E3%81%84%E3%81%A3%E3%81%9F%E3%82%93%E3%81%BE%E3%81%A8%E3%82%81",tabIndex:-1},children:[{type:"element",tag:"span",props:{className:["icon","icon-link"]},children:[]}]},{type:"text",value:"いったんまとめ"}]},{type:"text",value:"\n"},{type:"element",tag:"p",props:{},children:[{type:"text",value:"とりあえず Unreal Build Tool がビルドやその他の処理を呼び出すまでの流れはわかりました。\n次はビルド処理を読んで記事を書こうと思います。"}]}]},dir:"\u002Farticles\u002Funrealengine",path:"\u002Farticles\u002Funrealengine\u002Fthe-process-to-start-building-with-the-unreal-build-tool-in-ue4",extension:".md",createdAt:"2019-06-14T00:00:00.000Z",updatedAt:"2019-06-15T00:00:00.000Z",gitCreatedAt:"2021-11-25T21:00:30.000Z",gitUpdatedAt:"2021-11-30T16:52:43.000Z"}]},completed:a}],fetch:{},mutations:a}}(void 0)));