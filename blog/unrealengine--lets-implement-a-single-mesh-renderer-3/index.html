<!doctype html>
<html data-n-head-ssr lang="ja" prefix="og: http://ogp.me/ns#" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22ja%22%7D,%22prefix%22:%7B%22ssr%22:%22og:%20http://ogp.me/ns#%22%7D%7D">
  <head>
    <title>単一Static Meshレンダラを独自メッシュパスで実装する - strv.dev</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" name="format-detection" content="telephone=no"><meta data-n-head="ssr" data-hid="og:locale" property="og:locale" content="ja_jp"><meta data-n-head="ssr" data-hid="og:site_name" property="og:site_name" content="strv.dev"><meta data-n-head="ssr" data-hid="og:type" property="og:type" content="article"><meta data-n-head="ssr" name="twitter:card" content="summary_large_image"><meta data-n-head="ssr" name="twitter:creator" content="@strvert"><meta data-n-head="ssr" data-hid="description" name="description" content="アイテムの描画とか、一つだけのメッシュをレンダリングするのに便利なツールを実装してみる記事のその２。独自のメッシュパスを実装して単一パスの軽量なレンダラを書く。"><meta data-n-head="ssr" data-hid="og:description" property="og:description" content="アイテムの描画とか、一つだけのメッシュをレンダリングするのに便利なツールを実装してみる記事のその２。独自のメッシュパスを実装して単一パスの軽量なレンダラを書く。"><meta data-n-head="ssr" data-hid="og:url" property="og:url" content="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-3"><meta data-n-head="ssr" data-hid="og:title" property="og:title" content="単一Static Meshレンダラを独自メッシュパスで実装する - strv.dev"><meta data-n-head="ssr" data-hid="og:image" property="og:image" content="https://strv.dev/images/ogp/generated/unrealengine--lets-implement-a-single-mesh-renderer-3.png"><link data-n-head="ssr" data-hid="gf-prefetch" rel="dns-prefetch" href="https://fonts.gstatic.com/"><link data-n-head="ssr" data-hid="gf-preconnect" rel="preconnect" href="https://fonts.gstatic.com/" crossorigin=""><link data-n-head="ssr" data-hid="gf-preload" rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=M PLUS 1:wght@200;300;400;600&family=Source Code Pro:wght@300;400&display=swap"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="apple-touch-icon" type="image/png" href="/apple-touch-icon-180x180.png"><link data-n-head="ssr" rel="icon" type="image/png" href="/icon-192x192.png"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"><script data-n-head="ssr" src="https://www.googletagmanager.com/gtag/js?id=G-7CSGM5KZ9W" async></script><script data-n-head="ssr" data-hid="gf-script">!function(){var e=document.createElement("link");e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=M PLUS 1:wght@200;300;400;600&family=Source Code Pro:wght@300;400&display=swap",document.querySelector("head").appendChild(e)}()</script><noscript data-n-head="ssr" data-hid="gf-noscript"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=M PLUS 1:wght@200;300;400;600&family=Source Code Pro:wght@300;400&display=swap"></noscript><link rel="preload" href="/_nuxt/runtime.451661d.js" as="script"><link rel="preload" href="/_nuxt/commons/app.98a0816.js" as="script"><link rel="preload" href="/_nuxt/vendors/app.070d0bc.js" as="script"><link rel="preload" href="/_nuxt/app.541b271.js" as="script"><link rel="preload" href="/_nuxt/pages/blog/_blogpost.970c9d9.js" as="script"><link rel="preload" href="/_nuxt/components/atoms-blogpost-frame.b3ab725.js" as="script"><style data-vue-ssr-id="5f655f6e:0 47b1254e:0 e0c2e3f4:0 1e38ac46:0 30178fb4:0 0d0f8c20:0 efa3685a:0 6f59ad13:0 4fe6bba3:0 4f708215:0 519f442c:0 1ffacb4b:0 5baef921:0 21c0f031:0 ddc74972:0 46b5b2f1:0 a1473730:0 698678c4:0 49d44ae3:0 513d0dee:0 00512ee8:0 cb9a5eee:0 31bee032:0 0cbf0b3c:0 06d41f1b:0">*,:after,:before{box-sizing:border-box}:after,:before{text-decoration:inherit;vertical-align:inherit}html{cursor:default;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-tap-highlight-color:transparent;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;word-break:break-word}body{margin:0}h1{font-size:2em;margin:.67em 0}dl dl,dl ol,dl ul,ol dl,ol ol,ol ul,ul dl,ul ol,ul ul{margin:0}hr{height:0;overflow:visible}main{display:block}nav ol,nav ul{list-style:none;padding:0}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}audio,canvas,iframe,img,svg,video{vertical-align:middle}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}iframe,img{border-style:none}svg:not([fill]){fill:currentColor}svg:not(:root){overflow:hidden}table{border-collapse:collapse}button,input,select{margin:0}button{overflow:visible;text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}fieldset{border:1px solid #a0a0a0;padding:.35em .75em .625em}input{overflow:visible}legend{color:inherit;display:table;max-width:100%;white-space:normal}progress{display:inline-block;vertical-align:baseline}select{text-transform:none}textarea{margin:0;overflow:auto;resize:vertical}[type=checkbox],[type=radio]{padding:0}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}details,dialog{display:block}dialog{background-color:#fff;border:solid;color:#000;height:-moz-fit-content;height:fit-content;left:0;margin:auto;padding:1em;position:absolute;right:0;width:-moz-fit-content;width:fit-content}dialog:not([open]){display:none}summary{display:list-item}canvas{display:inline-block}template{display:none}[tabindex],a,area,button,input,label,select,summary,textarea{touch-action:manipulation}[hidden]{display:none}[aria-busy=true]{cursor:progress}[aria-controls]{cursor:pointer}[aria-disabled=true],[disabled]{cursor:not-allowed}[aria-hidden=false][hidden]{display:initial}[aria-hidden=false][hidden]:not(:focus){clip:rect(0,0,0,0);position:absolute}/*!
 * iconmonstr iconic font v1.2.0
 * Created by Alexander Kahlkopf - http://iconmonstr.com - @iconmonstr
 * License - http://iconmonstr.com/license
 */@font-face{font-family:iconmonstr-iconic-font;src:url(/_nuxt/fonts/iconmonstr-iconic-font.477addb.woff2) format("woff2"),url(/_nuxt/fonts/iconmonstr-iconic-font.7af9e9b.woff) format("woff"),url(/_nuxt/fonts/iconmonstr-iconic-font.44d85dc.ttf) format("truetype")}.im{display:inline-block;font:normal normal normal 24px/1 iconmonstr-iconic-font;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.im-angle-right:before{content:"\e001"}.im-angle-left:before{content:"\e002"}.im-angle-down:before{content:"\e003"}.im-angle-up:before{content:"\e004"}.im-angle-right-circle:before{content:"\e005"}.im-angle-left-circle:before{content:"\e006"}.im-angle-down-circle:before{content:"\e007"}.im-angle-up-circle:before{content:"\e008"}.im-arrow-right:before{content:"\e009"}.im-arrow-left:before{content:"\e00a"}.im-arrow-down:before{content:"\e00b"}.im-arrow-up:before{content:"\e00c"}.im-arrow-right-circle:before{content:"\e00d"}.im-arrow-left-circle:before{content:"\e00e"}.im-arrow-down-circle:before{content:"\e00f"}.im-arrow-up-circle:before{content:"\e010"}.im-care-right:before{content:"\e011"}.im-care-left:before{content:"\e012"}.im-care-down:before{content:"\e013"}.im-care-up:before{content:"\e014"}.im-forbidden:before{content:"\e015"}.im-printer:before{content:"\e016"}.im-menu:before{content:"\e017"}.im-menu-list:before{content:"\e018"}.im-quote-left:before{content:"\e019"}.im-quote-right:before{content:"\e01a"}.im-bell:before{content:"\e01b"}.im-bell-off:before{content:"\e01c"}.im-bookmark:before{content:"\e01d"}.im-briefcase:before{content:"\e01e"}.im-calendar:before{content:"\e01f"}.im-photo-camera:before{content:"\e020"}.im-video-camera:before{content:"\e021"}.im-microphone:before{content:"\e022"}.im-check-mark:before{content:"\e023"}.im-check-mark-circle:before{content:"\e024"}.im-check-square-o:before{content:"\e025"}.im-check-square:before{content:"\e026"}.im-check-square-i:before{content:"\e027"}.im-square-o:before{content:"\e028"}.im-radio-button-circle-o:before{content:"\e029"}.im-radio-button-circle:before{content:"\e02a"}.im-circle-o:before{content:"\e02b"}.im-clock-o:before{content:"\e02c"}.im-cloud:before{content:"\e02d"}.im-cloud-download:before{content:"\e02e"}.im-cloud-upload:before{content:"\e02f"}.im-code:before{content:"\e030"}.im-speech-bubble:before{content:"\e031"}.im-speech-bubble-comment:before{content:"\e032"}.im-speech-bubble-comments:before{content:"\e033"}.im-copy:before{content:"\e034"}.im-credit-card:before{content:"\e035"}.im-crown:before{content:"\e036"}.im-database:before{content:"\e037"}.im-computer:before{content:"\e038"}.im-download:before{content:"\e039"}.im-upload:before{content:"\e03a"}.im-pencil:before{content:"\e03b"}.im-edit-off:before{content:"\e03c"}.im-play:before{content:"\e03d"}.im-pause:before{content:"\e03e"}.im-stop:before{content:"\e03f"}.im-eject:before{content:"\e040"}.im-previous:before{content:"\e041"}.im-next:before{content:"\e042"}.im-loop:before{content:"\e043"}.im-random:before{content:"\e044"}.im-menu-dot-h:before{content:"\e045"}.im-menu-dot-v:before{content:"\e046"}.im-mail:before{content:"\e047"}.im-info:before{content:"\e048"}.im-warning:before{content:"\e049"}.im-question:before{content:"\e04a"}.im-link:before{content:"\e04b"}.im-unlink:before{content:"\e04c"}.im-external-link:before{content:"\e04d"}.im-eye:before{content:"\e04e"}.im-eye-off:before{content:"\e04f"}.im-file:before{content:"\e050"}.im-file-o:before{content:"\e051"}.im-files-o:before{content:"\e052"}.im-video:before{content:"\e053"}.im-audio:before{content:"\e054"}.im-picture-o:before{content:"\e055"}.im-flag:before{content:"\e056"}.im-folder:before{content:"\e057"}.im-folder-open:before{content:"\e058"}.im-smiley-o:before{content:"\e059"}.im-frown-o:before{content:"\e05a"}.im-gear:before{content:"\e05b"}.im-globe:before{content:"\e05c"}.im-heart:before{content:"\e05d"}.im-home:before{content:"\e05e"}.im-inbox:before{content:"\e05f"}.im-key:before{content:"\e060"}.im-lock:before{content:"\e061"}.im-lock-open:before{content:"\e062"}.im-task-o:before{content:"\e063"}.im-filter:before{content:"\e064"}.im-light-bulb:before{content:"\e065"}.im-flash:before{content:"\e066"}.im-map-o:before{content:"\e067"}.im-location:before{content:"\e068"}.im-maximize:before{content:"\e069"}.im-minimize:before{content:"\e06a"}.im-fullscreen:before{content:"\e06b"}.im-mobile:before{content:"\e06c"}.im-phone:before{content:"\e06d"}.im-coin:before{content:"\e06e"}.im-banknote:before{content:"\e06f"}.im-paper-clip:before{content:"\e070"}.im-bar-chart:before{content:"\e071"}.im-plus:before{content:"\e072"}.im-minus:before{content:"\e073"}.im-plus-circle:before{content:"\e074"}.im-minus-circle:before{content:"\e075"}.im-undo:before{content:"\e076"}.im-redo:before{content:"\e077"}.im-rocket:before{content:"\e078"}.im-rss:before{content:"\e079"}.im-magnifier:before{content:"\e07a"}.im-magnifier-plus:before{content:"\e07b"}.im-magnifier-minus:before{content:"\e07c"}.im-share:before{content:"\e07d"}.im-shield:before{content:"\e07e"}.im-shopping-cart:before{content:"\e07f"}.im-sign-in:before{content:"\e080"}.im-sign-out:before{content:"\e081"}.im-spinner:before{content:"\e082"}.im-star:before{content:"\e083"}.im-star-half:before{content:"\e084"}.im-star-o:before{content:"\e085"}.im-sync:before{content:"\e086"}.im-table:before{content:"\e087"}.im-window-o:before{content:"\e088"}.im-windows-o:before{content:"\e089"}.im-thumb-up:before{content:"\e08a"}.im-thumb-down:before{content:"\e08b"}.im-x-mark:before{content:"\e08c"}.im-x-mark-circle:before{content:"\e08d"}.im-trash-can:before{content:"\e08e"}.im-user-male:before{content:"\e08f"}.im-user-female:before{content:"\e090"}.im-user-circle:before{content:"\e091"}.im-users:before{content:"\e092"}.im-volume:before{content:"\e093"}.im-volume-off:before{content:"\e094"}.im-wifi:before{content:"\e095"}.im-tools:before{content:"\e096"}.im-dashboard:before{content:"\e097"}.im-archive:before{content:"\e098"}.im-save:before{content:"\e099"}.im-floppy-disk:before{content:"\e09a"}.im-sitemap:before{content:"\e09b"}.im-toggle:before{content:"\e09c"}.im-tag:before{content:"\e09d"}.im-tags:before{content:"\e09e"}.im-wizard:before{content:"\e09f"}.im-book:before{content:"\e0a0"}.im-fire:before{content:"\e0a1"}.im-id-card:before{content:"\e0a2"}.im-note-o:before{content:"\e0a3"}.im-control-panel:before{content:"\e0a4"}.im-facebook:before{content:"\e0a5"}.im-facebook-like:before{content:"\e0a6"}.im-twitter:before{content:"\e0a7"}.im-amazon:before{content:"\e0a8"}.im-android-os:before{content:"\e0a9"}.im-apple-os:before{content:"\e0aa"}.im-windows-os:before{content:"\e0ab"}.im-linux-os:before{content:"\e0ac"}.im-chrome:before{content:"\e0ad"}.im-ie:before{content:"\e0ae"}.im-edge:before{content:"\e0af"}.im-firefox:before{content:"\e0b0"}.im-safari:before{content:"\e0b1"}.im-opera:before{content:"\e0b2"}.im-behance:before{content:"\e0b3"}.im-blogger:before{content:"\e0b4"}.im-flickr:before{content:"\e0b5"}.im-github:before{content:"\e0b6"}.im-google-plus:before{content:"\e0b7"}.im-instagram:before{content:"\e0b8"}.im-linkedin:before{content:"\e0b9"}.im-pinterest:before{content:"\e0ba"}.im-skype:before{content:"\e0bb"}.im-snapchat:before{content:"\e0bc"}.im-soundcloud:before{content:"\e0bd"}.im-stackoverflow:before{content:"\e0be"}.im-stumbleupon:before{content:"\e0bf"}.im-tumblr:before{content:"\e0c0"}.im-xing:before{content:"\e0c1"}.im-youtube:before{content:"\e0c2"}.im-reddit:before{content:"\e0c3"}.im-vimeo:before{content:"\e0c4"}.im-vk:before{content:"\e0c5"}.im-whatsapp:before{content:"\e0c6"}.im-paypal:before{content:"\e0c7"}.im-twitch:before{content:"\e0c8"}.im-drop:before{content:"\e0c9"}.im-sun:before{content:"\e0ca"}.im-certificate-o:before{content:"\e0cb"}.im-graduation-hat:before{content:"\e0cc"}.im-store:before{content:"\e0cd"}.im-pin:before{content:"\e0ce"}.im-navigation:before{content:"\e0cf"}.im-keyboard:before{content:"\e0d0"}.im-cursor:before{content:"\e0d1"}.im-monitor-o:before{content:"\e0d2"}.im-laptop-o:before{content:"\e0d3"}.im-power:before{content:"\e0d4"}.im-pie-chart:before{content:"\e0d5"}.im-line-chart-up:before{content:"\e0d6"}.im-clock:before{content:"\e0d7"}.im-flip-chart-o:before{content:"\e0d8"}.im-gift:before{content:"\e0d9"}.im-leaf:before{content:"\e0da"}.im-bug:before{content:"\e0db"}.im-coffee:before{content:"\e0dc"}.im-diamond-o:before{content:"\e0dd"}.im-bell-active:before{content:"\e0de"}.im-history:before{content:"\e0df"}.im-gamepad:before{content:"\e0e0"}.im-binoculars:before{content:"\e0e1"}.im-paperplane:before{content:"\e0e2"}.im-wrench:before{content:"\e0e3"}.im-newspaper-o:before{content:"\e0e4"}.im-lifebuoy:before{content:"\e0e5"}.im-fingerprint:before{content:"\e0e6"}.im-date-o:before{content:"\e0e7"}.im-network:before{content:"\e0e8"}.im-target:before{content:"\e0e9"}.im-user-settings:before{content:"\e0ea"}.im-radio:before{content:"\e0eb"}.im-bank:before{content:"\e0ec"}.im-calculator:before{content:"\e0ed"}.im-battery-empty:before{content:"\e0ee"}.im-battery:before{content:"\e0ef"}.im-battery-full:before{content:"\e0f0"}.im-check-mark-circle-o:before{content:"\e0f1"}.im-x-mark-circle-o:before{content:"\e0f2"}.im-cube:before{content:"\e0f3"}.im-cubes:before{content:"\e0f4"}.im-warning-circle:before{content:"\e0f5"}.im-timer:before{content:"\e0f6"}.im-hashtag:before{content:"\e0f7"}.im-pointer:before{content:"\e0f8"}.im-paintbrush:before{content:"\e0f9"}.im-server:before{content:"\e0fa"}.im-car:before{content:"\e0fb"}.im-edit:before{content:"\e0fc"}.im-flask:before{content:"\e0fd"}.im-language:before{content:"\e0fe"}.im-anchor:before{content:"\e0ff"}.im-trophy:before{content:"\e100"}.im-umbrella:before{content:"\e101"}.im-cc-amex:before{content:"\e102"}.im-cc-visa:before{content:"\e103"}.im-cc-mastercard:before{content:"\e104"}.im-cc-paypal:before{content:"\e105"}.im-cc-amazon:before{content:"\e106"}.im-cc-bitcoin:before{content:"\e107"}html{font-family:"M PLUS 1",-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Hiragino Sans",Meiryo,sans-serif,"Segoe UI Emoji";font-size:15px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;word-wrap:break-word;word-break:break-word;color:var(--strvdev-text-color);background-color:var(--strvdev-bg-color);block-size:100%;scroll-behavior:smooth}body{overflow-x:hidden}a{color:var(--strvdev-link-color);-webkit-text-decoration-line:none;text-decoration-line:none;text-decoration-thickness:.07em}a:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline;-webkit-text-decoration-style:dashed;text-decoration-style:dashed}::-webkit-scrollbar{background:#c9c9c9;inline-size:7.5px;block-size:7.5px}::-webkit-scrollbar-thumb{background:#808494;border-radius:5px}::-moz-selection{text-shadow:none;background:#a3c4fc}::selection{text-shadow:none;background:#a3c4fc}[v-cloak]{opacity:0}.page-enter-active,.page-leave-active{transition-property:opacity height block-size transform;transition-duration:.2s}.page-enter,.page-leave-to{opacity:0}.inverse-page-enter-active,.inverse-page-leave-active,.layout-enter-active,.layout-leave-active{transition-property:opacity height block-size transform;transition-duration:.2s}.layout-enter,.layout-leave-to{opacity:0}.inverse-layout-enter-active,.inverse-layout-leave-active{transition-property:opacity height block-size transform;transition-duration:.2s}@font-face{font-family:Virgil;src:url(https://excalidraw.com/Virgil.woff2)}.blogpost .nuxt-content{--header-height:44px}.blogpost .nuxt-content .headers-border,.blogpost .nuxt-content h1{border-bottom:2px solid;border-color:rgba(0,0,0,.13333333333333333)}.blogpost .nuxt-content h1,.blogpost .nuxt-content h2,.blogpost .nuxt-content h3,.blogpost .nuxt-content h4,.blogpost .nuxt-content h5,.blogpost .nuxt-content h6{position:relative;z-index:0;-webkit-padding-before:var(--header-height);padding-block-start:var(--header-height);-webkit-margin-before:calc(var(--header-height)*-1);margin-block-start:calc(var(--header-height)*-1)}.blogpost .nuxt-content h1:hover a:before,.blogpost .nuxt-content h2:hover a:before,.blogpost .nuxt-content h3:hover a:before,.blogpost .nuxt-content h4:hover a:before,.blogpost .nuxt-content h5:hover a:before,.blogpost .nuxt-content h6:hover a:before{content:"§";display:block;inline-size:2em;position:absolute;font-size:1em;left:-1em;bottom:.05em}.blogpost .nuxt-content h1{font-size:1.7rem}.blogpost .nuxt-content h3{font-size:1.3rem}.blogpost .nuxt-content h4{font-size:1.04rem}.blogpost .nuxt-content .inline-code,.blogpost .nuxt-content li code,.blogpost .nuxt-content p code,.blogpost .nuxt-content table tbody code{font-family:var(--source-code-font);background-color:var(--strvdev-blogpost-code);border-radius:4px;margin:0 .2em;padding:0 .2em}.blogpost .nuxt-content p{position:relative;z-index:1;font-size:1.08rem;letter-spacing:.03em;line-height:3ex}.blogpost .nuxt-content details{position:relative;z-index:1;inline-size:95%;margin:0 auto}.blogpost .nuxt-content .blueprint-renderer,.blogpost .nuxt-content .code-extra pre,.blogpost .nuxt-content img,.blogpost .nuxt-content table,.blogpost .nuxt-content video{box-shadow:5px 5px 7px 2px rgba(0,0,0,.0392156862745098)}.blogpost .nuxt-content #目次+ul p{margin:.2em 0}.blogpost .nuxt-content .code-extra{-webkit-margin-after:1.5rem;margin-block-end:1.5rem}.blogpost .nuxt-content .code-extra pre{margin:0;border-radius:5px;border:2px solid rgba(0,0,0,.13333333333333333);-webkit-padding-before:2rem;padding-block-start:2rem;-webkit-padding-after:1rem;padding-block-end:1rem}.blogpost .nuxt-content .code-extra pre code{z-index:1;font-family:var(--source-code-font)}.blogpost .nuxt-content .code-extra .nuxt-content-highlight{position:relative}.blogpost .nuxt-content .code-extra .filename{position:absolute;font-size:.85rem;padding:4px 6px 4px 8px;border-radius:4px;background-color:rgba(0,0,0,.0392156862745098);font-family:var(--source-code-font);z-index:50}.blogpost .nuxt-content img{display:block;position:relative;left:50%;transform:translateX(-50%);max-inline-size:70%;border-radius:4px;z-index:10;transition-property:max-inline-size position;transition-duration:.5s}.blogpost .nuxt-content img:hover{max-inline-size:85vw;z-index:11}.blogpost .nuxt-content .without-shadow img{box-shadow:none}.blogpost .nuxt-content svg{display:block;position:relative;left:50%;transform:translateX(-50%)}.blogpost .nuxt-content video{display:block;margin:0 auto;max-inline-size:100%;min-inline-size:70%;border-radius:4px}.blogpost .nuxt-content table{inline-size:100%}.blogpost .nuxt-content table thead{border-radius:40px;background-color:var(--strvdev-palette-4);color:hsla(0,0%,100%,.8509803921568627)}.blogpost .nuxt-content table tbody code{background-color:hsla(0,0%,100%,.3137254901960784)}.blogpost .nuxt-content table tbody tr:nth-child(2n){background-color:#ccc}.blogpost .nuxt-content table tbody td{padding:.5em}.blogpost .nuxt-content .blueprint-renderer{display:block;inline-size:100%;block-size:500px;border-radius:4px;margin-top:15px;margin-bottom:15px}.blogpost .nuxt-content .footnotes li{-webkit-padding-before:var(--header-height);padding-block-start:var(--header-height);-webkit-margin-before:calc(var(--header-height)*-1);margin-block-start:calc(var(--header-height)*-1)}.blogpost .nuxt-content .katex{font-size:1.3em}:root{--source-code-font:"Source Code Pro";--strvdev-palette-1:#d9dbd9;--strvdev-palette-2:#7ac292;--strvdev-palette-3:#505464;--strvdev-palette-4:#273134;--strvdev-palette-5:#4174a5;--strvdev-palette-6:#a61010;--strvdev-blogpost-code:hsla(0,0%,100%,0.5647058823529412);--strvdev-blogpost-tag:#d1d3d1;--strvdev-bg-color:var(--strvdev-palette-1);--strvdev-text-color:var(--strvdev-palette-4);--strvdev-link-color:var(--strvdev-palette-5);--default-margin-block-start:80px}code[class*=language-],pre[class*=language-]{background:#fafafa;color:#383a42;font-family:"Fira Code","Fira Mono",Menlo,Consolas,"DejaVu Sans Mono",monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#e5e5e6;color:inherit}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#e5e5e6;color:inherit}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#e5e5e6;color:inherit}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-]{padding:.2em .3em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.prolog{color:#a0a1a7}.token.doctype,.token.entity,.token.punctuation{color:#383a42}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#b76b01}.token.keyword{color:#a626a4}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e45649}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#50a14f}.token.function,.token.operator,.token.variable{color:#4078f2}.token.url{color:#0184bc}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#383a42}.language-css .token.selector{color:#e45649}.language-css .token.property{color:#383a42}.language-css .token.function,.language-css .token.url>.token.function{color:#0184bc}.language-css .token.url>.token.string.url{color:#50a14f}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#a626a4}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#ca1243}.language-json .token.operator{color:#383a42}.language-json .token.null.keyword{color:#b76b01}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#383a42}.language-markdown .token.url>.token.content{color:#4078f2}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#0184bc}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#a0a1a7;font-style:italic}.language-markdown .token.code-snippet{color:#50a14f}.language-markdown .token.bold .token.content{color:#b76b01}.language-markdown .token.italic .token.content{color:#a626a4}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e45649}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(56,58,66,.2)}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#e5e5e6;color:#696c77;padding:.1em .4em;border-radius:.3em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#c6c7c7;color:#383a42}.line-highlight.line-highlight{background:rgba(56,58,66,.05)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#e5e5e6;color:#383a42;padding:.1em .6em;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2)}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(56,58,66,.05)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(56,58,66,.2)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#9d9d9f}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e45649}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#50a14f}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#4078f2}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#a626a4}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(26,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(57,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(57,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(57,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:#f2f2f2}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:#f2f2f2}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:#f2f2f2}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#fff}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#383a42;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#383a42}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}div.code-toolbar{position:relative}div.code-toolbar>.toolbar{position:absolute;z-index:10;top:.3em;right:.2em;transition:opacity .3s ease-in-out;opacity:0}div.code-toolbar:hover>.toolbar{opacity:1}div.code-toolbar:focus-within>.toolbar{opacity:1}div.code-toolbar>.toolbar>.toolbar-item{display:inline-block}div.code-toolbar>.toolbar>.toolbar-item>a{cursor:pointer}div.code-toolbar>.toolbar>.toolbar-item>button{background:0 0;border:0;color:inherit;font:inherit;line-height:normal;overflow:visible;padding:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}div.code-toolbar>.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar>.toolbar-item>span{color:#bbb;font-size:.8em;padding:0 .5em;background:#f5f2f0;background:hsla(0,0%,87.8%,.2);box-shadow:0 2px 0 0 rgba(0,0,0,.2);border-radius:.5em}div.code-toolbar>.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar>.toolbar-item>span:hover{color:inherit;text-decoration:none}.token.treeview-part .entry-line{position:relative;text-indent:-99em;display:inline-block;vertical-align:top;width:1.2em}.token.treeview-part .entry-line:before,.token.treeview-part .line-h:after{content:"";position:absolute;top:0;left:50%;width:50%;height:100%}.token.treeview-part .line-h:before,.token.treeview-part .line-v:before{border-left:1px solid #ccc}.token.treeview-part .line-v-last:before{height:50%;border-left:1px solid #ccc;border-bottom:1px solid #ccc}.token.treeview-part .line-h:after{height:50%;border-bottom:1px solid #ccc}.token.treeview-part .entry-name{position:relative;display:inline-block;vertical-align:top}.token.treeview-part .entry-name.dotfile{opacity:.5}@font-face{font-family:PrismTreeview;src:url(data:application/font-woff;base64,d09GRgABAAAAAAgYAAsAAAAAEGAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAADsAAABUIIslek9TLzIAAAFEAAAAPwAAAFY1UkH9Y21hcAAAAYQAAAB/AAACCtvO7yxnbHlmAAACBAAAA+MAAAlACm1VqmhlYWQAAAXoAAAAKgAAADZfxj5jaGhlYQAABhQAAAAYAAAAJAFbAMFobXR4AAAGLAAAAA4AAAA0CGQAAGxvY2EAAAY8AAAAHAAAABwM9A9CbWF4cAAABlgAAAAfAAAAIAEgAHZuYW1lAAAGeAAAATcAAAJSfUrk+HBvc3QAAAewAAAAZgAAAIka0DSfeJxjYGRgYOBiMGCwY2BycfMJYeDLSSzJY5BiYGGAAJA8MpsxJzM9kYEDxgPKsYBpDiBmg4gCACY7BUgAeJxjYGRYyjiBgZWBgaGQoRZISkLpUAYOBj0GBiYGVmYGrCAgzTWFweEV4ysehs1ArgDDFgZGIA3CDAB2tQjAAHic7ZHLEcMwCESfLCz/VEoKSEE5parURxMOC4c0Ec283WGFdABgBXrwCAzam4bOK9KWeefM3Hhmjyn3ed+hTRq1pS7Ra/HjYGPniHcXMy4G/zNTP7/KW5HTXArkvdBW3ArN19dCG/NRIN8K5HuB/CiQn4U26VeBfBbML9NEH78AeJyVVc1u20YQ3pn905JcSgr/YsuSDTEg3cR1bFEkYyS1HQcQ2jQF2hot6vYSoECKnnPLA/SWUy9NTr31Bfp+6azsNI0SGiolzu7ODnfn+2Z2lnHG3rxhr9nfLGKbLGesncAYYnUHpsVnMG/uwyzNdFIVd6HI6twp8+R3LpT4TSglLoTHwwJgG2/dFvKrl9yI507/p5CCq4LTxB/PlPjkFaMHnWB/0S9je7RTPS+utnGtom1T2q5pk/e3H0M1S18rsXAL7wgpxQuhAmteGGvNjmcfGXuwnFNOPCXxeOGmnjrBLWNyBeNtVq2Hs03yus1aPS3mzSyNVSfu588iW1Q93x/4fjcHn+5EkS2tMxr4xIRa8ese+4L9uKZnxEqs8+ldyN9atU02a5t5uQ8hZGms1QTKpaKYqnipiNNOAIeIADC0JNEOYY+jtSgFoOchiAjRGFACpUTRje8bwIYWGCDEgENY8MEu9bnCYCdAxftoNg0KiSpUtPaHcanYwzXRu6T4r40b5npal3V7UHWCPJW9niyl1vIHgoujEXZjudBkeWkOeMQBRmbEPhKzij1i52t6/TadL+3q7H0U1eq4E8cG4gIIwQLx8VX7ToPXgPrehVc5QXHR7gMSmwjKfaYAP4KvZV+yn9bE18y2IY37LvtyrSg3i7ZK++B603ndlg/gBJpZRsfpBI6hyiaQ6FjlnThz8lAC3LgBIMnXDOAXxBQ4SIgiEhx2AcGCAwAhwjXRpCQms42bwAUt75BvAwgONzdgOfWEwzk4Ylzj4mz+5YEzzXzWX9aNlk7ot65y5QnBHsNlm6zDTu7sspRqG4V+fgJ1lVBZ07Nm7s5nemo3Lf3PO7iwtnroQ5/YDGwPRUip6fV6L+27p+wCHwSvPs85UnHqId8NAn5IBsKdv95KrL9m31Gsf2a/rluDslk1y1J9GE+LUmmVT/OyOHaFKGnapt2H5XeJTmKd6qYNoVVZOy+pWzr7rMip3ndG/4mQSoUcMbAqG/YNIAdXhkAqTVruXhocSKN0iS4Rwj7vSS4fcF/La07BfeQSuRAcFeW+9igjwPhhYPpGCBCBHhxiKMyFMFT7ziRH7RtfIWdiha+TdW+Rqs7bLHdN2ZJIKl0um0x3op9saYr0REeRdj09pl43pMzz4tjztrY8L4o8bzT+oLY27PR/eFtXs/YY5vtwB5Iqad14eYN0ujveMaGWqkdU3TKbQSC5Uvxaf4fA7SAQ3r2tEfIhd4duld91bwMisjqBw22orthNcroXl7KqO1329HBgAexgoCfGAwiDPoBnriki3lmNojrzvD0tjo6E3vPYP6E2BMIAeJxjYGRgYADiY8t3FsTz23xl4GbYzIAB/v9nWM6wBcjgYGAC8QH+QQhZAAB4nGNgZGBg2MzAACeXMzAyoAJeADPyAh14nGNgAILNpGEA0fgIZQAAAAAAAAA2AHIAvgE+AZgCCAKMAv4DlgPsBEYEoHicY2BkYGDgZchi4GQAASYg5gJCBob/YD4DABTSAZcAeJx9kU1uwjAQhV/4qwpqhdSqi67cTTeVEmBXDgBbhBD7AHYISuLUMSD2PUdP0HNwjp6i676k3qQS9Ujjb968mYUNoI8zPJTHw02Vy9PAFatfbpLuHbfIT47b6MF33KH+6riLF0wc93CHN27wWtdUHvHuuIFbfDhuUv903CKfHbfxgC/HHerfjrtYen3HPTx7ambiIl0YKQ+xPM5ltE9CU9NqxVKaItaZGPqDmj6VmTShlRuxOoniEI2sVUIZnYqJzqxMEi1yo3dybf2ttfk4CJTT/bVOMYNBjAIpFiTJOLCWOGLOHGGPBCE7l32XO0tmw04MjQwCQ7774B//lDmrZkJY3hvOrHBiLuiJMKJqoVgrejQ3CP5Yubt0JwxNJa96Oypr6j621VSOMQKG+uP36eKmHylcb0MAeJxtwdEOgjAMBdBeWEFR/Mdl7bTJtMsygc/nwVfPoYF+QP+tGDAigDFhxgVXLLjhjhUPCtmKTtmLaGN7x6dy/Io5bybqoevRQ3LRObb0sk3HKpn1SFqW6ru26vbpYfcmRCccJhqsAAA=) format("woff")}.token.treeview-part .entry-name:before{content:"\ea01";font-family:PrismTreeview;font-size:inherit;font-style:normal;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:2.5ex;display:inline-block}.token.treeview-part .entry-name.dir:before{content:"\ea02"}.token.treeview-part .entry-name.ext-bmp:before,.token.treeview-part .entry-name.ext-eps:before,.token.treeview-part .entry-name.ext-gif:before,.token.treeview-part .entry-name.ext-jpe:before,.token.treeview-part .entry-name.ext-jpeg:before,.token.treeview-part .entry-name.ext-jpg:before,.token.treeview-part .entry-name.ext-png:before,.token.treeview-part .entry-name.ext-svg:before,.token.treeview-part .entry-name.ext-tiff:before{content:"\ea03"}.token.treeview-part .entry-name.ext-cfg:before,.token.treeview-part .entry-name.ext-conf:before,.token.treeview-part .entry-name.ext-config:before,.token.treeview-part .entry-name.ext-csv:before,.token.treeview-part .entry-name.ext-ini:before,.token.treeview-part .entry-name.ext-log:before,.token.treeview-part .entry-name.ext-md:before,.token.treeview-part .entry-name.ext-nfo:before,.token.treeview-part .entry-name.ext-txt:before{content:"\ea06"}.token.treeview-part .entry-name.ext-asp:before,.token.treeview-part .entry-name.ext-aspx:before,.token.treeview-part .entry-name.ext-c:before,.token.treeview-part .entry-name.ext-cc:before,.token.treeview-part .entry-name.ext-cpp:before,.token.treeview-part .entry-name.ext-cs:before,.token.treeview-part .entry-name.ext-css:before,.token.treeview-part .entry-name.ext-h:before,.token.treeview-part .entry-name.ext-hh:before,.token.treeview-part .entry-name.ext-htm:before,.token.treeview-part .entry-name.ext-html:before,.token.treeview-part .entry-name.ext-jav:before,.token.treeview-part .entry-name.ext-java:before,.token.treeview-part .entry-name.ext-js:before,.token.treeview-part .entry-name.ext-php:before,.token.treeview-part .entry-name.ext-rb:before,.token.treeview-part .entry-name.ext-xml:before{content:"\ea07"}.token.treeview-part .entry-name.ext-7z:before,.token.treeview-part .entry-name.ext-bz2:before,.token.treeview-part .entry-name.ext-bz:before,.token.treeview-part .entry-name.ext-gz:before,.token.treeview-part .entry-name.ext-rar:before,.token.treeview-part .entry-name.ext-tar:before,.token.treeview-part .entry-name.ext-tgz:before,.token.treeview-part .entry-name.ext-zip:before{content:"\ea08"}.token.treeview-part .entry-name.ext-aac:before,.token.treeview-part .entry-name.ext-au:before,.token.treeview-part .entry-name.ext-cda:before,.token.treeview-part .entry-name.ext-flac:before,.token.treeview-part .entry-name.ext-mp3:before,.token.treeview-part .entry-name.ext-oga:before,.token.treeview-part .entry-name.ext-ogg:before,.token.treeview-part .entry-name.ext-wav:before,.token.treeview-part .entry-name.ext-wma:before{content:"\ea04"}.token.treeview-part .entry-name.ext-avi:before,.token.treeview-part .entry-name.ext-flv:before,.token.treeview-part .entry-name.ext-mkv:before,.token.treeview-part .entry-name.ext-mov:before,.token.treeview-part .entry-name.ext-mp4:before,.token.treeview-part .entry-name.ext-mpeg:before,.token.treeview-part .entry-name.ext-mpg:before,.token.treeview-part .entry-name.ext-ogv:before,.token.treeview-part .entry-name.ext-webm:before{content:"\ea05"}.token.treeview-part .entry-name.ext-pdf:before{content:"\ea09"}.token.treeview-part .entry-name.ext-xls:before,.token.treeview-part .entry-name.ext-xlsx:before{content:"\ea0a"}.token.treeview-part .entry-name.ext-doc:before,.token.treeview-part .entry-name.ext-docm:before,.token.treeview-part .entry-name.ext-docx:before{content:"\ea0c"}.token.treeview-part .entry-name.ext-pps:before,.token.treeview-part .entry-name.ext-ppt:before,.token.treeview-part .entry-name.ext-pptx:before{content:"\ea0b"}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.frame[data-v-32d9e426]{display:flex;flex-direction:column;min-height:100vh}.frame .header[data-v-32d9e426]{position:fixed;z-index:100;top:0;left:0}.frame main[data-v-32d9e426]{flex:1}.frame main .content[data-v-32d9e426]{max-inline-size:800px;margin:0 auto}@media screen and (max-width:800px){.frame main .content[data-v-32d9e426]{margin-left:10px;margin-right:10px}}.header-main[data-v-031b1d0e]{background-color:var(--strvdev-palette-1);box-shadow:0 0 3px 0 var(--strvdev-palette-3);inline-size:100%;transition-property:transform;transition-duration:.3s;transform:translateY(calc(var(--header-row-height)*-1*var(--header-row-count)))}.header-main.open[data-v-031b1d0e]{transform:translateY(0)}.site-content-list[data-v-031b1d0e]{display:flex;justify-content:center}.header-grid[data-v-031b1d0e]{block-size:var(--header-row-height);max-inline-size:800px;margin:0 auto;position:relative;display:grid;grid-template-columns:repeat(5,1fr);grid-template-areas:"a b c d e";align-items:start;justify-items:center}.header-grid>.strvdevlogo[data-v-031b1d0e]{background-color:inherit;border-style:none;grid-area:c;padding-top:5px}.header-grid>.strvdevlogo[data-v-031b1d0e]:hover{cursor:pointer}.header-grid>.sitenav[data-v-031b1d0e]{grid-area:c}ul[data-v-30c9cc4b]{display:flex;list-style:none;padding:0;margin:0;justify-content:space-around}ul li[data-v-30c9cc4b]{text-align:center;font-size:1.1rem;font-weight:900;transition-property:color,background-color;transition-duration:.5s}ul li a[data-v-30c9cc4b]{display:block;inline-size:100%;block-size:100%;color:#333c49}svg[data-v-bddbf348]{display:block;margin:0 auto}.giscus-wrapper[data-v-2f2c1355]{max-inline-size:820px;-webkit-padding-before:1rem;padding-block-start:1rem;margin:0 auto}@media screen and (max-width:820px){.giscus-wrapper[data-v-2f2c1355]{max-inline-size:800px}}.surround-menu[data-v-2f2c1355]{display:block;-webkit-margin-before:4rem;margin-block-start:4rem}.blogpost>header[data-v-2f2c1355]{position:relative;-webkit-margin-after:1.26em;margin-block-end:1.26em;z-index:10}.blogpost>header>.post-title[data-v-2f2c1355]{font-size:2rem;-webkit-margin-after:.56em;margin-block-end:.56em}.blogpost>header .advent-calendar-label[data-v-2f2c1355]{-webkit-margin-after:.4rem;margin-block-end:.4rem}.blogpost>header>.post-info-wrapper[data-v-2f2c1355]{display:flex;justify-content:space-between;align-items:center}.blogpost>header>.post-info-wrapper>.publish-time[data-v-2f2c1355]{font-size:.95rem;color:rgba(0,0,0,.5333333333333333);margin:0}.blogpost .content-slot[data-v-2f2c1355]{position:relative;z-index:5}.container-base[data-v-6f1598ec]{-webkit-margin-before:var(--default-margin-block-start);margin-block-start:var(--default-margin-block-start)}.list-wrapper[data-v-7e21c619]{display:flex;gap:.3em;align-items:flex-start}.list-wrapper>.material-icons[data-v-7e21c619]{color:inherit;font-size:1.3em}.list-wrapper>.tag-list[data-v-7e21c619]{display:flex;flex-wrap:wrap;list-style:none;margin:0;padding:0;gap:.7em}.list-wrapper>.tag-list li[data-v-7e21c619]{background-color:var(--strvdev-blogpost-tag);border-radius:4px;padding:0 .2em;font-size:.9em}h2[data-v-6bc0f40a]{display:none}.share-list[data-v-6bc0f40a]{list-style:none;padding:0;-webkit-margin-end:.5rem;margin-inline-end:.5rem;display:flex;gap:1rem;justify-content:flex-end}.share-list a[data-v-6bc0f40a]{color:var(--strvdev-palette-3)}.wrapper[data-v-08b63208]{display:grid;grid-auto-flow:column;justify-content:space-between;gap:.5rem;grid-template-columns:minmax(max-content,auto) auto minmax(max-content,auto);align-items:center}.wrapper .prev[data-v-08b63208]{justify-self:flex-start}.wrapper .seriesname[data-v-08b63208]{text-align:center}.wrapper .next[data-v-08b63208]{-webkit-margin-start:auto;margin-inline-start:auto;text-align:right}.button[data-v-08b63208]{display:block}.giscus-frame{width:100%}.footer-wrapper[data-v-194ed6b2]{box-shadow:0 0 3px 0 var(--strvdev-palette-3);-webkit-margin-before:5rem;margin-block-start:5rem;-webkit-padding-before:1.5rem;padding-block-start:1.5rem}.footer-wrapper .footer-main[data-v-194ed6b2]{position:relative;max-inline-size:800px;margin:0 auto;-webkit-padding-after:1rem;padding-block-end:1rem;color:rgba(0,0,0,.7333333333333333)}.footer-wrapper .footer-main .infos[data-v-194ed6b2]{display:flex;justify-content:space-between}.footer-wrapper .footer-main .infos .copyright[data-v-194ed6b2],.footer-wrapper .footer-main .infos .privacy[data-v-194ed6b2]{bottom:1em;left:0;font-size:.9rem;-webkit-margin-before:1em;margin-block-start:1em}@media screen and (min-width:800px){.footer-wrapper .footer-main .contact[data-v-194ed6b2]{position:relative;left:-1.2em;inline-size:50%}}@media screen and (max-width:820px){.footer-wrapper .footer-main[data-v-194ed6b2]{padding-left:10px;padding-right:10px}}h2[data-v-b716246c]{display:none}address[data-v-b716246c]{flex-wrap:wrap;justify-content:space-around;margin:0 1em;gap:1em}address p[data-v-b716246c],address[data-v-b716246c]{display:flex;align-items:center}address p[data-v-b716246c]{margin:0;gap:.2em}address p .icon[data-v-b716246c]{position:relative;top:.095em;font-size:inherit}address p .display[data-v-b716246c]{font-size:1em;font-style:normal}.tail[data-v-4e732b52]:before{content:"@"}.msgbox[data-v-753eb174]{cursor:pointer}@media screen and (min-width:800px){.content[data-v-753eb174]:hover{border-radius:4px;background-color:rgba(0,0,0,.1)}}.container[data-v-e0d516b2]{position:relative}.container .msgbox[data-v-e0d516b2]{display:flex;justify-content:center;align-items:center;position:absolute;top:3px;left:50%;transform:translateY(-100%) translateX(-50%);block-size:2.5rem;inline-size:auto;white-space:nowrap;background:var(--strvdev-blogpost-code);border-radius:5px;transition-property:opacity;transition-duration:.1s;padding:.3rem}.container .msgbox span[data-v-e0d516b2]{margin:0;font-size:1.1rem}.container .msgbox.hide[data-v-e0d516b2]{opacity:0}</style><link rel="preload" href="/_nuxt/static/1712758369/blog/unrealengine--lets-implement-a-single-mesh-renderer-3/state.js" as="script"><link rel="preload" href="/_nuxt/static/1712758369/blog/unrealengine--lets-implement-a-single-mesh-renderer-3/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1712758369/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="frame" data-v-32d9e426><div class="header-main header" style="--header-row-height:44px;--header-row-count:1" data-v-031b1d0e data-v-32d9e426><div class="site-content-list" data-v-031b1d0e><nav class="sitenav" data-v-031b1d0e><ul style="flex-direction:row" data-v-30c9cc4b data-v-031b1d0e><li style="line-height:44px;inline-size:200px" data-v-30c9cc4b><a href="/" class="nuxt-link-active" data-v-30c9cc4b>
      HOME
    </a></li><li style="line-height:44px;inline-size:200px" data-v-30c9cc4b><a href="/blog" class="nuxt-link-active" data-v-30c9cc4b>
      BLOG
    </a></li><li style="line-height:44px;inline-size:200px" data-v-30c9cc4b><a href="/about" data-v-30c9cc4b>
      ABOUT
    </a></li></ul></nav></div> <div class="header-grid" data-v-031b1d0e><button name="show-navcontent" aria-label="show navigation menu content" class="strvdevlogo" data-v-031b1d0e><div data-v-bddbf348 data-v-031b1d0e><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 35.893 6.419" width="184.37099999999998" height="33" style="isolation:isolate" data-v-bddbf348><defs data-v-bddbf348><clipPath id="_clipPath_wRGPbw1kW50q8FvcamYb3Hxr115iy0Iy" data-v-bddbf348><rect width="35.893" height="6.419" data-v-bddbf348></rect></clipPath></defs> <g clip-path="url(#_clipPath_wRGPbw1kW50q8FvcamYb3Hxr115iy0Iy)" data-v-bddbf348><clipPath id="_clipPath_I8fUhl3gs6z6fOmYoJZCtzdbffHu72Ll" data-v-bddbf348><rect x="0" y="0" width="35.893" height="6.419" transform="matrix(1,0,0,1,0,0)" fill="rgb(255,255,255)" data-v-bddbf348></rect></clipPath> <g clip-path="url(#_clipPath_I8fUhl3gs6z6fOmYoJZCtzdbffHu72Ll)" data-v-bddbf348><g class="characters" data-v-bddbf348><path d=" M 35.059 1.474 L 35.017 1.474 L 33.893 5.978 C 33.853 6.139 33.686 6.269 33.52 6.269 L 31.39 6.269 C 31.225 6.269 31.058 6.139 31.018 5.978 L 29.892 1.469 L 29.892 1.469 L 31.726 1.474 L 31.647 1.474 L 32.339 4.298 C 32.378 4.459 32.431 4.589 32.455 4.589 L 32.455 4.589 C 32.48 4.589 32.532 4.459 32.572 4.298 L 33.265 1.469 L 35.059 1.474 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 27.535 1.469 L 27.56 1.469 L 27.535 1.469 L 27.535 2.199 C 27.535 2.365 27.669 2.499 27.835 2.499 L 29.315 2.499 C 29.48 2.499 29.615 2.634 29.615 2.799 L 29.615 3.489 C 29.615 3.655 29.48 3.789 29.315 3.789 L 27.835 3.789 C 27.669 3.789 27.535 3.924 27.535 4.089 L 27.535 4.519 C 27.535 4.685 27.669 4.819 27.835 4.819 L 29.675 4.819 C 29.84 4.819 29.975 4.954 29.975 5.119 L 29.975 5.969 C 29.975 6.135 29.84 6.269 29.675 6.269 L 26.075 6.269 C 25.909 6.269 25.775 6.135 25.775 5.969 L 25.775 1.469 L 25.775 1.469 L 27.535 1.469 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 25.396 1.469 Q 25.414 1.537 25.43 1.609 L 25.43 1.609 L 25.43 1.609 Q 25.56 2.219 25.56 3.149 L 25.56 3.149 L 25.56 3.149 Q 25.56 4.069 25.43 4.679 L 25.43 4.679 L 25.43 4.679 Q 25.3 5.289 24.985 5.639 L 24.985 5.639 L 24.985 5.639 Q 24.67 5.989 24.12 6.129 L 24.12 6.129 L 24.12 6.129 Q 23.57 6.269 22.72 6.269 L 22.72 6.269 L 20.37 6.269 C 20.204 6.269 20.07 6.135 20.07 5.969 L 20.07 1.474 L 20.07 1.474 L 20.07 1.474 L 20.07 1.474 L 21.83 1.469 L 21.83 4.589 C 21.83 4.755 21.964 4.889 22.13 4.889 L 22.89 4.889 L 22.89 4.889 Q 23.33 4.889 23.5 4.744 L 23.5 4.744 L 23.5 4.744 Q 23.67 4.599 23.67 4.229 L 23.67 4.229 L 23.67 2.059 L 23.67 2.059 Q 23.67 1.689 23.5 1.544 L 23.5 1.544 L 23.5 1.544 Q 23.452 1.503 23.382 1.474 L 23.317 1.474 L 23.317 1.474 L 25.396 1.469 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 19.15 5.008 L 19.411 5.008 C 19.687 5.008 19.911 5.232 19.911 5.508 L 19.911 5.769 C 19.911 6.045 19.687 6.269 19.411 6.269 L 19.15 6.269 C 18.874 6.269 18.65 6.045 18.65 5.769 L 18.65 5.508 C 18.65 5.232 18.874 5.008 19.15 5.008 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 19.49 1.474 L 18.365 5.978 C 18.325 6.139 18.158 6.269 17.993 6.269 L 15.863 6.269 C 15.697 6.269 15.53 6.139 15.49 5.978 L 14.366 1.474 L 16.118 1.469 L 16.811 4.298 C 16.851 4.459 16.903 4.589 16.928 4.589 L 16.928 4.589 C 16.952 4.589 17.005 4.459 17.044 4.298 L 17.737 1.469 L 19.49 1.474 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 14.014 1.469 Q 14.082 1.826 14.096 2.276 L 14.096 2.276 L 14.096 2.276 Q 14.017 3.359 13.517 3.859 L 13.517 3.859 L 13.517 3.859 Q 13.396 3.981 13.376 3.994 C 13.24 4.088 13.194 4.281 13.273 4.426 L 14.143 6.006 C 14.223 6.151 14.153 6.269 13.987 6.269 L 12.677 6.269 C 12.512 6.269 12.32 6.148 12.249 5.998 L 11.602 4.63 C 11.531 4.481 11.339 4.359 11.173 4.359 L 11.037 4.359 C 10.872 4.359 10.737 4.494 10.737 4.659 L 10.737 5.969 C 10.737 6.135 10.603 6.269 10.437 6.269 L 9.277 6.269 C 9.112 6.269 8.977 6.135 8.976 5.969 L 8.946 1.469 L 10.737 1.469 L 10.737 2.769 C 10.737 2.935 10.872 3.069 11.037 3.069 L 11.707 3.069 L 11.707 3.069 Q 11.977 3.069 12.077 2.979 L 12.077 2.979 L 12.077 2.979 Q 12.177 2.889 12.177 2.649 L 12.177 2.649 L 12.177 1.889 L 12.177 1.889 Q 12.177 1.649 12.077 1.559 L 12.077 1.559 L 12.077 1.559 L 11.859 1.469 L 14.014 1.469 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 7.663 1.469 L 7.663 5.969 C 7.663 6.135 7.529 6.269 7.363 6.269 L 6.203 6.269 C 6.038 6.269 5.903 6.135 5.903 5.969 L 5.903 1.469 L 7.663 1.469 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 2.033 1.474 C 1.978 1.474 1.933 1.519 1.933 1.574 L 1.933 2.169 C 1.933 2.224 1.978 2.273 2.033 2.278 L 2.753 2.339 L 2.753 2.339 Q 3.553 2.409 4.048 2.639 L 4.048 2.639 L 4.048 2.639 Q 4.543 2.869 4.768 3.284 L 4.768 3.284 L 4.768 3.284 Q 4.993 3.699 4.993 4.349 L 4.993 4.349 L 4.993 4.349 Q 4.993 5.079 4.728 5.534 L 4.728 5.534 L 4.728 5.534 Q 4.463 5.989 3.898 6.204 L 3.898 6.204 L 3.898 6.204 Q 3.333 6.419 2.423 6.419 L 2.423 6.419 L 2.423 6.419 Q 1.753 6.419 1.138 6.339 L 1.138 6.339 L 1.138 6.339 L 0.247 6.151 C 0.085 6.117 -0.024 5.957 0.004 5.793 L 0.152 4.935 C 0.181 4.772 0.332 4.678 0.49 4.727 Q 0.693 4.789 1.203 4.864 L 1.203 4.864 L 1.203 4.864 Q 1.713 4.939 2.213 4.939 L 2.213 4.939 L 2.213 4.939 Q 2.473 4.939 2.673 4.929 L 2.673 4.929 L 2.673 4.929 L 2.805 4.914 C 2.97 4.895 3.103 4.745 3.103 4.579 L 3.103 4.319 C 3.103 4.154 2.97 4.007 2.805 3.993 L 2.193 3.939 L 2.193 3.939 Q 1.593 3.889 1.178 3.764 L 1.178 3.764 L 1.178 3.764 Q 0.763 3.639 0.513 3.414 L 0.513 3.414 L 0.513 3.414 Q 0.263 3.189 0.153 2.854 L 0.153 2.854 L 0.153 2.854 Q 0.043 2.519 0.043 2.039 L 0.043 2.039 L 0.043 2.039 Q 0.043 1.239 0.263 0.764 L 0.263 0.764 L 0.263 0.764 Q 0.521 0.163 1.036 0.019 L 1.036 0.019 L 1.036 0.019 L 1.036 0.019 L 1.036 1.469 L 1.728 1.469 L 2.033 1.474 L 2.033 1.474 Z " fill="rgb(51,60,73)" data-v-bddbf348></path></g> <g class="barcode" data-v-bddbf348><path d=" M 23.116 1.48 L 23.116 0 L 23.393 0 L 23.393 1.48 L 23.116 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 25.06 1.48 L 25.06 0 L 24.782 0 L 24.782 1.48 L 25.06 1.48 L 25.06 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 24.227 1.48 L 24.227 0 L 23.671 0 L 23.671 1.48 L 24.227 1.48 L 24.227 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 27.282 1.48 L 27.282 0 L 26.171 0 L 26.171 1.48 L 27.282 1.48 L 27.282 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 27.838 0 L 27.838 1.475 L 27.838 1.48 L 27.56 1.48 L 27.56 1.475 L 27.56 0 L 27.838 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 28.671 0 L 28.671 1.475 L 28.671 1.48 L 28.393 1.48 L 28.393 1.475 L 28.393 0 L 28.671 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 29.226 1.475 L 29.226 1.48 L 29.782 1.48 L 29.782 1.475 L 29.782 0 L 29.226 0 L 29.226 1.475 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 35.059 1.48 L 35.059 0 L 34.782 0 L 34.782 1.48 L 35.059 1.48 L 35.059 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 34.504 1.48 L 34.504 0 L 33.671 0 L 33.671 1.48 L 34.504 1.48 L 34.504 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 31.726 1.48 L 31.726 0 L 30.893 0 L 30.893 1.48 L 31.726 1.48 L 31.726 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 30.615 1.48 L 30.615 0 L 30.337 0 L 30.337 1.48 L 30.615 1.48 L 30.615 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 32.837 0 L 32.837 1.48 L 32.282 1.48 L 32.282 0 L 32.837 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 35.893 0.201 L 35.893 1.28 C 35.893 1.39 35.803 1.48 35.693 1.48 L 35.337 1.48 L 35.337 0 L 35.693 0 C 35.803 0 35.893 0.089 35.893 0.201 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 2.283 1.48 L 2.283 1.48 L 2.283 1.48 L 2.283 1.48 L 2.283 0 L 1.728 0 L 1.728 1.48 L 2.283 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 2.839 0 L 2.839 1.48 L 2.561 1.48 L 2.561 0 L 2.839 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 3.672 0 L 3.672 1.48 L 3.394 1.48 L 3.394 0 L 3.672 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 5.061 0 L 5.061 1.48 L 4.783 1.48 L 4.783 0 L 5.061 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 6.45 1.475 L 6.45 0 L 5.339 0 L 5.339 1.48 L 6.45 1.48 L 6.45 1.475 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 7.283 1.48 L 7.283 0.777 L 7.283 0 L 7.005 0 L 7.005 1.48 L 7.283 1.48 L 7.283 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 10.338 1.48 L 10.338 0 L 10.061 0 L 10.061 1.478 L 10.338 1.48 L 10.338 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 9.783 1.48 L 9.783 0 L 8.672 0 L 8.672 1.475 L 8.672 1.475 L 8.672 1.475 L 8.672 1.475 L 8.672 1.48 L 9.783 1.475 L 9.783 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 8.116 1.475 L 8.116 0 L 7.839 0 L 7.839 0.918 L 7.839 1.475 L 8.116 1.475 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 21.727 1.475 L 21.727 0 L 21.449 0 L 21.449 1.475 L 21.727 1.475 L 21.727 1.475 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 20.338 1.48 L 20.338 0 L 20.06 0 L 20.06 1.48 L 20.338 1.48 L 20.338 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 13.949 1.48 L 13.949 0 L 15.06 0 L 15.06 1.48 L 13.949 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 19.782 1.48 L 19.782 0 L 18.949 0 L 18.949 1.48 L 19.782 1.48 L 19.782 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 18.394 1.48 L 18.394 0 L 17.838 0 L 17.838 1.48 L 18.394 1.48 L 18.394 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 15.616 1.48 L 15.616 0 L 15.338 0 L 15.338 1.48 L 15.616 1.48 L 15.616 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 13.672 1.48 L 13.672 0 L 12.561 0 L 12.561 1.48 L 13.672 1.48 L 13.672 1.48 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 12.005 0 L 11.727 0 L 11.727 1.48 L 12.005 1.48 L 12.005 0 Z " fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 11.172 0 L 11.172 1.48 L 10.894 1.48 L 10.894 0 L 11.172 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 16.449 0 L 16.449 1.48 L 16.172 1.48 L 16.172 0 L 16.449 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 17.283 0 L 17.283 1.48 L 17.005 1.48 L 17.005 0 L 17.283 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path> <path d=" M 22.838 0 L 22.838 1.48 L 22.282 1.48 L 22.282 0 L 22.838 0 Z " fill-rule="evenodd" fill="rgb(51,60,73)" data-v-bddbf348></path></g></g></g></svg></div></button></div></div> <main data-v-32d9e426><div class="content" data-v-32d9e426><div class="outer"><div data-v-2f2c1355><div class="container-base" data-v-6f1598ec data-v-2f2c1355><article data-v-6f1598ec data-v-2f2c1355><div class="blogpost" data-v-6f1598ec data-v-2f2c1355><header data-v-6f1598ec data-v-2f2c1355><h1 class="post-title" data-v-6f1598ec data-v-2f2c1355>単一Static Meshレンダラを独自メッシュパスで実装する</h1> <!----> <div class="post-info-wrapper" data-v-6f1598ec data-v-2f2c1355><div class="tag-list" data-v-6f1598ec data-v-2f2c1355><div class="list-wrapper" data-v-7e21c619 data-v-2f2c1355><span class="material-icons" data-v-7e21c619>local_offer</span> <ul class="tag-list" data-v-7e21c619><li data-v-7e21c619><a href="/blog/search?t=Unreal%20Engine" data-v-7e21c619>Unreal Engine</a></li><li data-v-7e21c619><a href="/blog/search?t=Unreal%20C%2B%2B" data-v-7e21c619>Unreal C++</a></li><li data-v-7e21c619><a href="/blog/search?t=RHI" data-v-7e21c619>RHI</a></li><li data-v-7e21c619><a href="/blog/search?t=RDG" data-v-7e21c619>RDG</a></li><li data-v-7e21c619><a href="/blog/search?t=Advent%20Calendar" data-v-7e21c619>Advent Calendar</a></li></ul></div></div> <p class="publish-time" data-v-6f1598ec data-v-2f2c1355><time datetime="2024.04.10" data-v-6f1598ec data-v-2f2c1355>2024.04.10</time>に公開
            </p></div></header> <div class="content-slot" data-v-6f1598ec data-v-2f2c1355><div class="nuxt-content" data-v-6f1598ec><h1 id="introduction" data-v-6f1598ec><a href="#introduction" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>Introduction</h1>
<p data-v-6f1598ec>この記事では、UE5 上でメインの World とは別の空間・ビューポートを対象とした軽量なレンダリング機能を実装してみるものです。
想定用途は、アイテムのプレビュー表示など、高度なレンダリング機能を必要としないが、軽量に個別のメッシュを描画したい場合などです。</p>
<p data-v-6f1598ec>この記事は、以下の記事の続編になります。</p>
<ol data-v-6f1598ec>
<li data-v-6f1598ec><a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>単一 Static Mesh レンダラを FPreviewScene で実装する</a></li>
<li data-v-6f1598ec><a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-2" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>単一 Static Mesh レンダラを独自メッシュパスで実装する...ための前提知識編</a></li>
</ol>
<p data-v-6f1598ec>1 の記事では、FPreviewScene というユーティリティを使って、メインの World とは別の UWorld インスタンスを作成し、その内部のカメラにレンダリングさせることで、単一の Static Mesh を専用ビューポートに描画する方法を紹介しました。</p>
<p data-v-6f1598ec>しかし、この方法には課題もありました。たとえば、</p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>単一メッシュをレンダリングしたいだけなのに専用の UWorld インスタンスが必要</li>
<li data-v-6f1598ec>レンダリング機能についても多数のメッシュを描画する前提で設計されていたりするために、速度やメモリ資源の面で無駄が多い</li>
</ul>
<p data-v-6f1598ec>などです。
本記事では、 2 の記事で紹介した前提知識を元に、実際に単一メッシュを描画するためのレンダラを実装していきます。</p>
<p data-v-6f1598ec><strong data-v-6f1598ec>StaticMesh から出発して独自のメッシュ描画パスを実装してみることは、UE のレンダリング機能を知る入口としても適しています。</strong></p>
<h1 id="プラグインの公開" data-v-6f1598ec><a href="#%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%AE%E5%85%AC%E9%96%8B" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>プラグインの公開</h1>
<p data-v-6f1598ec>この記事の執筆にあたっては、TinyRenderer というプラグインとして機能を実装しました。プラグインのソースコードは <a href="https://github.com/strvert/TinyRenderer" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>GitHub</a> で公開しています。
なお、実験的な実装であり、きちんとした検証は行っていないので、あくまでも手法の参考としてご利用ください。</p>
<h2 id="簡単な使い方" data-v-6f1598ec><a href="#%E7%B0%A1%E5%8D%98%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>簡単な使い方</h2>
<p data-v-6f1598ec>以下のように、BP から簡単にメッシュを指定して RenderTarget に描画させることができます。
<img alt="" src="/article-assets/unrealengine/lets-implement-a-single-mesh-renderer-3//sample.png" data-v-6f1598ec>
これは UMG 上の Image Widget に配置した例です。
<img alt="" src="/article-assets/unrealengine/lets-implement-a-single-mesh-renderer-3//lamp.png" data-v-6f1598ec></p>
<p data-v-6f1598ec>背景色は RenderTarget の ClearColor で指定したものになるので、背景抜きのことを考えなくても透明に設定するだけではじめから背景無しで描画できます。</p>
<p data-v-6f1598ec>試した方は、動いたとか動かなかったとか、もしよければ @strvert までおしえてください。</p>
<h2 id="パフォーマンス" data-v-6f1598ec><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>パフォーマンス</h2>
<p data-v-6f1598ec>詳しくは <a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E6%A4%9C%E8%A8%BC" data-v-6f1598ec>パフォーマンスの検証</a> に記載していますが、単一メッシュの描画においては、 SceneCapture2D や FPreviewScene といった手段よりもかなり高速に動作します。</p>
<p data-v-6f1598ec>参考として、 同一フレームに 500x500 の RenderTarget に 19382 三角ポリゴンのメッシュを描画して計測すると、フレーム内に占める時間は以下のような結果になりました。</p>
<p data-v-6f1598ec><img alt="" src="/article-assets/unrealengine/lets-implement-a-single-mesh-renderer-3//compare.png" data-v-6f1598ec></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>SceneCapture2D: 4.12ms</li>
<li data-v-6f1598ec><a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>FPreviewScene</a>: 1.11ms</li>
<li data-v-6f1598ec><b data-v-6f1598ec>Tiny Renderer (本プラグイン): 0.02ms</b></li>
</ul>
<p data-v-6f1598ec>はやい。いや、むしろ SceneCapture2D などが単純なメッシュ描画には不要な機能が多すぎるということかもしれません。</p>
<h2 id="このプラグインでできないこと" data-v-6f1598ec><a href="#%E3%81%93%E3%81%AE%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%A7%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>このプラグインでできないこと</h2>
<p data-v-6f1598ec>このプラグインは、単一 StaticMesh を軽量に描画したいという目的に特化しています。そのため、以下のような機能は提供していません。</p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>多数のメッシュからなるシーンの描画</li>
<li data-v-6f1598ec>複雑な照明環境の描画</li>
<li data-v-6f1598ec>エフェクトやポストプロセスの適用</li>
</ul>
<p data-v-6f1598ec>また、以下のような機能は技術的には(たぶん)可能ですが、実装には含まれていません。</p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>不透明 (Opaque) 以外のマテリアルの描画</li>
<li data-v-6f1598ec>Nanite メッシュの描画</li>
<li data-v-6f1598ec>etc...</li>
</ul>
<p data-v-6f1598ec>Nanite メッシュの描画については、Nanite を使った描画はできませんが、Fallback Mesh の LOD を指定して描画することは可能です。</p>
<p data-v-6f1598ec>さて、以降はこのプラグインの実装と関連する UE のグラフィックス機能について解説していきます。</p>
<h1 id="目次" data-v-6f1598ec><a href="#%E7%9B%AE%E6%AC%A1" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>目次</h1>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E3%81%8A%E3%81%8A%E3%81%BE%E3%81%8B%E3%81%AA%E4%BB%95%E7%B5%84%E3%81%BF%E3%81%A8%E3%82%B3%E3%83%B3%E3%82%BB%E3%83%97%E3%83%88" data-v-6f1598ec>おおまかな仕組みとコンセプト</a></p>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E8%BB%BD%E9%87%8F%E3%81%AA%E5%8D%98%E4%B8%80-staticmesh-%E3%83%AC%E3%83%B3%E3%83%80%E3%83%A9%E3%81%AE%E5%AE%9F%E8%A3%85" data-v-6f1598ec>軽量な単一 StaticMesh レンダラの実装</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E3%83%AC%E3%83%B3%E3%83%80%E3%83%A9%E3%82%AF%E3%83%A9%E3%82%B9-ftinyrenderer-%E3%81%AE%E5%AE%9A%E7%BE%A9" data-v-6f1598ec>レンダラクラス FTinyRenderer の定義</a></p>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E6%B5%81%E3%82%8C" data-v-6f1598ec>レンダリング呼び出しの流れ</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#ftinyrenderersetupscenetextures" data-v-6f1598ec>FTinyRenderer::SetupSceneTextures</a></li>
<li data-v-6f1598ec><a href="#ftinyrendererrenderbasepass" data-v-6f1598ec>FTinyRenderer::RenderBasePass</a></li>
</ul>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#staticmesh-%E3%81%8B%E3%82%89%E7%9B%B4%E6%8E%A5-meshbatch-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B" data-v-6f1598ec>StaticMesh から直接 MeshBatch を作成する</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#ftinyrenderercreatemeshbatch" data-v-6f1598ec>FTinyRenderer::CreateMeshBatch</a></li>
</ul>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#gpuscene-%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B" data-v-6f1598ec>GPUScene のためのパラメータをセットアップする</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#ftinyrenderersetupgpusceneresourceparameters" data-v-6f1598ec>FTinyRenderer::SetupGPUSceneResourceParameters</a></li>
<li data-v-6f1598ec><a href="#ftinyrenderersetgpusceneresourceparameters" data-v-6f1598ec>FTinyRenderer::SetGPUSceneResourceParameters</a></li>
</ul>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E6%8F%8F%E7%94%BB%E5%87%A6%E7%90%86%E3%82%92%E8%A1%8C%E3%81%88%E3%82%8B%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90" data-v-6f1598ec>マテリアルを利用した描画処理を行えるシェーダーの作成</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#ftinyrenderershader-vsps-%E3%81%AE-c-%E5%AE%9A%E7%BE%A9" data-v-6f1598ec>FTinyRendererShader (VS/PS) の C++ 定義</a></li>
<li data-v-6f1598ec><a href="#%E7%8B%AC%E8%87%AA%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E6%8F%8F%E7%94%BB%E3%83%91%E3%82%B9%E5%87%A6%E7%90%86%E3%81%AE%E9%A0%82%E7%82%B9%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E5%AE%9F%E8%A3%85" data-v-6f1598ec>独自メッシュ描画パス処理の頂点シェーダー実装</a></li>
<li data-v-6f1598ec><a href="#%E7%8B%AC%E8%87%AA%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E6%8F%8F%E7%94%BB%E3%83%91%E3%82%B9%E5%87%A6%E7%90%86%E3%81%AE%E3%83%94%E3%82%AF%E3%82%BB%E3%83%AB%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E5%AE%9F%E8%A3%85" data-v-6f1598ec>独自メッシュ描画パス処理のピクセルシェーダー実装</a></li>
<li data-v-6f1598ec><a href="#%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AE%E7%99%BB%E9%8C%B2%E3%81%A8-rdg-%E3%81%AB%E3%82%88%E3%82%8B%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E5%AE%9A%E7%BE%A9" data-v-6f1598ec>シェーダーの登録と RDG によるパラメータ定義</a></li>
</ul>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#meshbatch-%E3%81%AE%E6%8F%8F%E7%94%BB%E5%91%BD%E4%BB%A4%E3%82%92%E7%99%BA%E8%A1%8C%E3%81%99%E3%82%8B-meshpassprocessor" data-v-6f1598ec>MeshBatch の描画命令を発行する MeshPassProcessor</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#ftinyrendererbasepassmeshprocessor" data-v-6f1598ec>FTinyRendererBasePassMeshProcessor</a></li>
</ul>
</li>
</ul>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#bp-%E3%83%A9%E3%83%83%E3%83%91%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90" data-v-6f1598ec>BP ラッパーの作成</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#api-%E3%81%AE%E5%AE%9A%E7%BE%A9" data-v-6f1598ec>API の定義</a></p>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E3%82%AB%E3%83%A1%E3%83%A9%E8%A8%AD%E5%AE%9A-fminimalviewinfo-%E3%81%8B%E3%82%89-viewfamily-%E3%81%AE%E6%A7%8B%E7%AF%89" data-v-6f1598ec>カメラ設定 (FMinimalViewInfo) から ViewFamily の構築</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#utinyrendererrenderer" data-v-6f1598ec>UTinyRenderer::Renderer</a></li>
</ul>
</li>
</ul>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E6%A4%9C%E8%A8%BC" data-v-6f1598ec>パフォーマンスの検証</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E6%AF%94%E8%BC%83" data-v-6f1598ec>比較</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#nsight-graphics-%E3%81%AE-scrubber-%E3%82%92%E7%9C%BA%E3%82%81%E3%82%8B" data-v-6f1598ec>Nsight Graphics の Scrubber を眺める</a></li>
<li data-v-6f1598ec><a href="#%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E5%86%85%E5%87%A6%E7%90%86%E6%99%82%E9%96%93%E3%81%AE%E6%AF%94%E8%BC%83" data-v-6f1598ec>フレーム内処理時間の比較</a></li>
<li data-v-6f1598ec><a href="#%E3%81%84%E3%81%A3%E3%81%B1%E3%81%84%E6%8F%8F%E7%94%BB%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE-fps-%E3%81%AE%E6%AF%94%E8%BC%83" data-v-6f1598ec>いっぱい描画したときの FPS の比較</a></li>
</ul>
</li>
</ul>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E3%81%95%E3%82%89%E3%81%AA%E3%82%8B%E6%94%B9%E5%96%84%E5%8F%AF%E8%83%BD%E6%80%A7" data-v-6f1598ec>さらなる改善可能性</a></p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#opaque-%E4%BB%A5%E5%A4%96%E3%81%AE-blendmode-%E3%81%AE%E5%AF%BE%E5%BF%9C" data-v-6f1598ec>Opaque 以外の BlendMode の対応</a></li>
<li data-v-6f1598ec><a href="#%E3%83%A9%E3%82%A4%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E6%8B%A1%E5%BC%B5" data-v-6f1598ec>ライティングの拡張</a></li>
<li data-v-6f1598ec><a href="#shader-permutaion-%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96" data-v-6f1598ec>Shader Permutaion の最適化</a></li>
<li data-v-6f1598ec><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E6%94%B9%E5%96%84" data-v-6f1598ec>パフォーマンスの改善</a></li>
</ul>
</li>
<li data-v-6f1598ec>
<p data-v-6f1598ec><a href="#%E3%81%BE%E3%81%A8%E3%82%81" data-v-6f1598ec>まとめ</a></p>
</li>
</ul>
<h1 id="おおまかな仕組みとコンセプト" data-v-6f1598ec><a href="#%E3%81%8A%E3%81%8A%E3%81%BE%E3%81%8B%E3%81%AA%E4%BB%95%E7%B5%84%E3%81%BF%E3%81%A8%E3%82%B3%E3%83%B3%E3%82%BB%E3%83%97%E3%83%88" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>おおまかな仕組みとコンセプト</h1>
<p data-v-6f1598ec>長い記事になるので、まずはどんなコンセプトで実装されたものかをざっくりとまとめておきます。</p>
<p data-v-6f1598ec>UE の デスクトップやハイエンドコンソール向けのレンダリング機能は、Diferred Rendering による高度な機能を提供します。Deferred Rendering は多数のメッシュや光源を描画したり、高度なポストプロセスを適用したりするのには有益ですが、シンプルな単一メッシュの描画には不要です。</p>
<p data-v-6f1598ec>たとえば、ゲームのインベントリ画面にアイテムの 3D モデルをたくさん並べて表示したいとか、そんなときには高度な機能は不要で、小さな RenderTarget に単一のメッシュを高速に描画できることが重要です。</p>
<p data-v-6f1598ec>また、UE のレンダリング機能には AO や GI などの高度な機能のためのパスが多数含まれており、これらのパスは特定の Viewport だけで ON / OFF したりできない (CVars で一括管理されてしまう)ため、シンプルな Viewport 描画を行いにくいです。
利用される Shader についても複雑な構造になっており、単一メッシュの描画にはオーバースペックです。</p>
<p data-v-6f1598ec>そこで、単一のパスでライティングまでを行う Forward Rendering によるレンダラを UE の RHI / RDG を使って実装してみることにしました。また、 UWorld や FScene といったシーン表現や Actor, Component といったものも単一メッシュでは不要(ローカルのTransformしかない)なので利用せず、StaticMesh アセットを直接処理して描画することにします。</p>
<p data-v-6f1598ec>独自のシェーダーで描画を行いますが、アセットの互換性のため、きちんとUEのマテリアルアセットを利用して描画を行えるようにもしました。</p>
<p data-v-6f1598ec><strong data-v-6f1598ec>TinyRenderer は軽量で高速ですが、すごいことをしているわけではありません。むしろ、単一メッシュを描画するにはいらないことをなにもしてないないだけです。</strong></p>
<h1 id="軽量な単一-staticmesh-レンダラの実装" data-v-6f1598ec><a href="#%E8%BB%BD%E9%87%8F%E3%81%AA%E5%8D%98%E4%B8%80-staticmesh-%E3%83%AC%E3%83%B3%E3%83%80%E3%83%A9%E3%81%AE%E5%AE%9F%E8%A3%85" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>軽量な単一 StaticMesh レンダラの実装</h1>
<p data-v-6f1598ec>すべてのコードを示すと長くなるため、面白い部分のみを抜粋して説明します。
全体のコードは <a href="https://github.com/strvert/TinyRenderer" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>GitHub</a> を参照してください。プラグインのソースを読みながら、その解説として記事を読むのが理解しやすいかもしれません。</p>
<h2 id="レンダラクラス-ftinyrenderer-の定義" data-v-6f1598ec><a href="#%E3%83%AC%E3%83%B3%E3%83%80%E3%83%A9%E3%82%AF%E3%83%A9%E3%82%B9-ftinyrenderer-%E3%81%AE%E5%AE%9A%E7%BE%A9" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>レンダラクラス FTinyRenderer の定義</h2>
<p data-v-6f1598ec>レンダラを表すクラスは <code data-v-6f1598ec>FTinyRenderer</code> であり、以下のように定義されています。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>class</span> <span class="token class-name" data-v-6f1598ec>FTinyRenderer</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
<span class="token keyword" data-v-6f1598ec>public</span><span class="token operator" data-v-6f1598ec>:</span>
	<span class="token comment" data-v-6f1598ec>// コンストラクタ。FSceneViewFamilyを受け取る</span>
	<span class="token keyword" data-v-6f1598ec>explicit</span> <span class="token function" data-v-6f1598ec>FTinyRenderer</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FSceneViewFamily<span class="token operator" data-v-6f1598ec>&</span> InViewFamily<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token comment" data-v-6f1598ec>// StaticMesh およびその変換行列を設定する</span>
	<span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>SetStaticMesh</span><span class="token punctuation" data-v-6f1598ec>(</span>UStaticMesh<span class="token operator" data-v-6f1598ec>*</span> InStaticMesh<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>const</span> int32 InLODIndex<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>const</span> FMatrix<span class="token operator" data-v-6f1598ec>&</span> InTransform<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token comment" data-v-6f1598ec>// 描画命令を発行する</span>
	<span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>Render</span><span class="token punctuation" data-v-6f1598ec>(</span>FRDGBuilder<span class="token operator" data-v-6f1598ec>&</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

<span class="token keyword" data-v-6f1598ec>private</span><span class="token operator" data-v-6f1598ec>:</span>
	<span class="token keyword" data-v-6f1598ec>struct</span> <span class="token class-name" data-v-6f1598ec>FTinySceneTextures</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		FRDGTextureRef SceneColorTexture<span class="token punctuation" data-v-6f1598ec>;</span>
		FRDGTextureRef SceneDepthTexture<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>
	
	<span class="token keyword" data-v-6f1598ec>struct</span> <span class="token class-name" data-v-6f1598ec>FMeshBatchesRequiredFeatures</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>bool</span> bWorldPositionOffset <span class="token operator" data-v-6f1598ec>=</span> <span class="token boolean" data-v-6f1598ec>false</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>

	FTinySceneTextures <span class="token function" data-v-6f1598ec>SetupSceneTextures</span><span class="token punctuation" data-v-6f1598ec>(</span>FRDGBuilder<span class="token operator" data-v-6f1598ec>&</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>)</span> <span class="token keyword" data-v-6f1598ec>const</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>RenderBasePass</span><span class="token punctuation" data-v-6f1598ec>(</span>FRDGBuilder<span class="token operator" data-v-6f1598ec>&</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>const</span> FTinySceneTextures<span class="token operator" data-v-6f1598ec>&</span> SceneTextures<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token keyword" data-v-6f1598ec>bool</span> <span class="token function" data-v-6f1598ec>CreateMeshBatch</span><span class="token punctuation" data-v-6f1598ec>(</span>UStaticMesh<span class="token operator" data-v-6f1598ec>*</span> InStaticMesh<span class="token punctuation" data-v-6f1598ec>,</span>
	                     <span class="token keyword" data-v-6f1598ec>const</span> int32 InLODIndex<span class="token punctuation" data-v-6f1598ec>,</span>
	                     TArray<span class="token operator" data-v-6f1598ec>&lt;</span>FMeshBatch<span class="token operator" data-v-6f1598ec>></span><span class="token operator" data-v-6f1598ec>&</span> InMeshBatches<span class="token punctuation" data-v-6f1598ec>,</span>
	                     FMeshBatchesRequiredFeatures<span class="token operator" data-v-6f1598ec>&</span> RequiredFeatures<span class="token punctuation" data-v-6f1598ec>)</span> <span class="token keyword" data-v-6f1598ec>const</span><span class="token punctuation" data-v-6f1598ec>;</span>
	
	FGPUSceneResourceParameters <span class="token function" data-v-6f1598ec>SetupGPUSceneResourceParameters</span><span class="token punctuation" data-v-6f1598ec>(</span>FRDGBuilder<span class="token operator" data-v-6f1598ec>&</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                            <span class="token keyword" data-v-6f1598ec>const</span> FMeshBatchesRequiredFeatures<span class="token operator" data-v-6f1598ec>&</span> RequiredFeatures<span class="token punctuation" data-v-6f1598ec>)</span> <span class="token keyword" data-v-6f1598ec>const</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>SetGPUSceneResourceParameters</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FGPUSceneResourceParameters<span class="token operator" data-v-6f1598ec>&</span> Parameters<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	ERHIFeatureLevel<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Type FeatureLevel<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FSceneViewFamily<span class="token operator" data-v-6f1598ec>&</span> ViewFamily<span class="token punctuation" data-v-6f1598ec>;</span>
	FSceneUniformBuffer SceneUniforms<span class="token punctuation" data-v-6f1598ec>;</span>
	TWeakObjectPtr<span class="token operator" data-v-6f1598ec>&lt;</span>UStaticMesh<span class="token operator" data-v-6f1598ec>></span> StaticMesh<span class="token punctuation" data-v-6f1598ec>;</span>
	FMatrix LocalToWorld<span class="token punctuation" data-v-6f1598ec>;</span>
	int32 LODIndex<span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>
</code></pre></div>
<p data-v-6f1598ec>UE の他の機能との相互利用性を考慮して、 コンストラクタでは <code data-v-6f1598ec>FSceneViewFamily</code> を受け取って利用します。また、描画するメッシュや変換行列は <code data-v-6f1598ec>SetStaticMesh</code> で設定し、描画の実行は <code data-v-6f1598ec>Render</code> で行います。</p>
<p data-v-6f1598ec><code data-v-6f1598ec>FSceneViewFamily</code> については<a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer/#ue-%E3%81%AE%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AE%E7%99%BB%E5%A0%B4%E4%BA%BA%E7%89%A9%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>こちら</a>を参照してください。</p>
<h2 id="レンダリング呼び出しの流れ" data-v-6f1598ec><a href="#%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E6%B5%81%E3%82%8C" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>レンダリング呼び出しの流れ</h2>
<p data-v-6f1598ec><code data-v-6f1598ec>FTinyRenderer::Render</code> は、呼び出し元から RDGBuilder を受け取り、 RDG を使ってリソースやパスの登録を行います。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>void</span> <span class="token class-name" data-v-6f1598ec>FTinyRenderer</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>Render</span><span class="token punctuation" data-v-6f1598ec>(</span>FRDGBuilder<span class="token operator" data-v-6f1598ec>&</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>)</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token comment" data-v-6f1598ec>// レンダリング対象の SceneTextures を作成</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FTinySceneTextures SceneTextures <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>SetupSceneTextures</span><span class="token punctuation" data-v-6f1598ec>(</span>GraphBuilder<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token comment" data-v-6f1598ec>// BasePass をレンダリング</span>
	<span class="token function" data-v-6f1598ec>RenderBasePass</span><span class="token punctuation" data-v-6f1598ec>(</span>GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span> SceneTextures<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<p data-v-6f1598ec>流れとしては、 <code data-v-6f1598ec>SetupSceneTextures</code> でレンダリングに利用するのテクスチャリソースを登録し、そこに <code data-v-6f1598ec>RenderBasePass</code> でパスの登録確保したリソースのパラメータのセットアップを実行するというものです。
RDG についての詳細は <a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-2#rdg-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E6%8F%8F%E7%94%BB%E5%91%BD%E4%BB%A4%E7%99%BA%E8%A1%8C%E3%81%AE%E3%83%9C%E3%82%A4%E3%83%A9%E3%83%BC%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>前回の記事</a> を参照してください。</p>
<p data-v-6f1598ec>呼び出している関数の実装は次節以降で解説します。</p>
<h3 id="ftinyrenderersetupscenetextures" data-v-6f1598ec><a href="#ftinyrenderersetupscenetextures" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>FTinyRenderer::SetupSceneTextures</h3>
<p data-v-6f1598ec>まずは、 <code data-v-6f1598ec>SetupSceneTextures</code> の実装を見ていきます。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec>FTinyRenderer<span class="token punctuation double-colon" data-v-6f1598ec>::</span>FTinySceneTextures <span class="token class-name" data-v-6f1598ec>FTinyRenderer</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>SetupSceneTextures</span><span class="token punctuation" data-v-6f1598ec>(</span>FRDGBuilder<span class="token operator" data-v-6f1598ec>&</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>)</span> <span class="token keyword" data-v-6f1598ec>const</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token comment" data-v-6f1598ec>// 描画先の FRenderTarget を取得。これが SceneColor の出力先になる</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FRenderTarget<span class="token operator" data-v-6f1598ec>*</span> RenderTarget <span class="token operator" data-v-6f1598ec>=</span> ViewFamily<span class="token punctuation" data-v-6f1598ec>.</span>RenderTarget<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token comment" data-v-6f1598ec>// RDG のリソース管理に外部の RenderTarget を登録し、RDG のテクスチャリソースを表す FRDGTextureRef を取得</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FRDGTextureRef TinyRendererOutputRef <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>RegisterExternalTexture</span><span class="token punctuation" data-v-6f1598ec>(</span>
		<span class="token function" data-v-6f1598ec>CreateRenderTarget</span><span class="token punctuation" data-v-6f1598ec>(</span>RenderTarget<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetRenderTargetTexture</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"TinyRendererOutput"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>// SceneDepth 用のテクスチャを作成。今回は外部から参照しないので、ここで作成して利用する。</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FRDGTextureDesc Desc <span class="token operator" data-v-6f1598ec>=</span> <span class="token class-name" data-v-6f1598ec>FRDGTextureDesc</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>Create2D</span><span class="token punctuation" data-v-6f1598ec>(</span>RenderTarget<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetSizeXY</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> PF_DepthStencil<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                       FClearValueBinding<span class="token punctuation double-colon" data-v-6f1598ec>::</span>DepthFar<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                       TexCreate_DepthStencilTargetable <span class="token operator" data-v-6f1598ec>|</span> TexCreate_ShaderResource<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FRDGTextureRef SceneDepth <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>CreateTexture</span><span class="token punctuation" data-v-6f1598ec>(</span>Desc<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"SceneDepthZ"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token keyword" data-v-6f1598ec>return</span> FTinySceneTextures<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token punctuation" data-v-6f1598ec>.</span>SceneColorTexture <span class="token operator" data-v-6f1598ec>=</span> TinyRendererOutputRef<span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token punctuation" data-v-6f1598ec>.</span>SceneDepthTexture <span class="token operator" data-v-6f1598ec>=</span> SceneDepth
	<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<p data-v-6f1598ec>ここでは、 RDG のリソース管理機能を利用して、レンダリングに利用するテクスチャリソースを定義しています。SceneColor には、外部の RenderTarget を利用し、SceneDepth は RDG のリソースとして作成しています。
RDG を使った実装では、 RDG がリソースのライフタイムを管理するため、外部化のリソースを利用するには登録を行って RDG のリソースとして扱う必要があります。別の場所で作成した RenderTarget を渡したい場合や、フレームをまたいで利用したいリソースがある場合には、このような方法を使うことになります。</p>
<h3 id="ftinyrendererrenderbasepass" data-v-6f1598ec><a href="#ftinyrendererrenderbasepass" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>FTinyRenderer::RenderBasePass</h3>
<p data-v-6f1598ec>次に、 <code data-v-6f1598ec>RenderBasePass</code> の実装を見ていきます。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>void</span> <span class="token class-name" data-v-6f1598ec>FTinyRenderer</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>RenderBasePass</span><span class="token punctuation" data-v-6f1598ec>(</span>FRDGBuilder<span class="token operator" data-v-6f1598ec>&</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>const</span> FTinySceneTextures<span class="token operator" data-v-6f1598ec>&</span> SceneTextures<span class="token punctuation" data-v-6f1598ec>)</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token function" data-v-6f1598ec>SCOPED_NAMED_EVENT</span><span class="token punctuation" data-v-6f1598ec>(</span>FTinyRenderer_RenderBasePass<span class="token punctuation" data-v-6f1598ec>,</span> FColor<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Emerald<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>// レンダリング対象の StaticMesh を取得</span>
	UStaticMesh<span class="token operator" data-v-6f1598ec>*</span> Mesh <span class="token operator" data-v-6f1598ec>=</span> StaticMesh<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>IsValid</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span> <span class="token operator" data-v-6f1598ec>?</span> StaticMesh<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Get</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span> <span class="token operator" data-v-6f1598ec>:</span> <span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span><span class="token operator" data-v-6f1598ec>!</span>Mesh<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token function" data-v-6f1598ec>UE_LOG</span><span class="token punctuation" data-v-6f1598ec>(</span>LogTinyRenderer<span class="token punctuation" data-v-6f1598ec>,</span> Warning<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"StaticMesh is not valid"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>return</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>// StaticMesh から MeshBatch を作成</span>
	TArray<span class="token operator" data-v-6f1598ec>&lt;</span>FMeshBatch<span class="token operator" data-v-6f1598ec>></span> MeshBatches<span class="token punctuation" data-v-6f1598ec>;</span>
	FMeshBatchesRequiredFeatures RequiredFeatures<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span><span class="token operator" data-v-6f1598ec>!</span><span class="token function" data-v-6f1598ec>CreateMeshBatch</span><span class="token punctuation" data-v-6f1598ec>(</span>Mesh<span class="token punctuation" data-v-6f1598ec>,</span> LODIndex<span class="token punctuation" data-v-6f1598ec>,</span> MeshBatches<span class="token punctuation" data-v-6f1598ec>,</span> RequiredFeatures<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token function" data-v-6f1598ec>UE_LOG</span><span class="token punctuation" data-v-6f1598ec>(</span>LogTinyRenderer<span class="token punctuation" data-v-6f1598ec>,</span> Warning<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"Failed to create mesh batch"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>return</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>// GPUScene のためのパラメータをセットアップ</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FGPUSceneResourceParameters GPUSceneResourceParameters <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>SetupGPUSceneResourceParameters</span><span class="token punctuation" data-v-6f1598ec>(</span>GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span> RequiredFeatures<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token function" data-v-6f1598ec>SetGPUSceneResourceParameters</span><span class="token punctuation" data-v-6f1598ec>(</span>GPUSceneResourceParameters<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>// レンダリング対象の View を取得	</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FViewInfo<span class="token operator" data-v-6f1598ec>*</span> View <span class="token operator" data-v-6f1598ec>=</span> <span class="token generic-function" data-v-6f1598ec><span class="token function" data-v-6f1598ec>static_cast</span><span class="token class-name generic" data-v-6f1598ec><span class="token operator" data-v-6f1598ec>&lt;</span><span class="token keyword" data-v-6f1598ec>const</span> FViewInfo<span class="token operator" data-v-6f1598ec>*</span><span class="token operator" data-v-6f1598ec>></span></span></span><span class="token punctuation" data-v-6f1598ec>(</span>ViewFamily<span class="token punctuation" data-v-6f1598ec>.</span>Views<span class="token punctuation" data-v-6f1598ec>[</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>// レンダリングに利用する Shader のパラメータを構築</span>
	FTinyRendererShaderParameters<span class="token operator" data-v-6f1598ec>*</span> PassParameters <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token generic-function" data-v-6f1598ec><span class="token function" data-v-6f1598ec>AllocParameters</span><span class="token class-name generic" data-v-6f1598ec><span class="token operator" data-v-6f1598ec>&lt;</span>FTinyRendererShaderParameters<span class="token operator" data-v-6f1598ec>></span></span></span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	PassParameters<span class="token operator" data-v-6f1598ec>-></span>View <span class="token operator" data-v-6f1598ec>=</span> View<span class="token operator" data-v-6f1598ec>-></span>ViewUniformBuffer<span class="token punctuation" data-v-6f1598ec>;</span>
	PassParameters<span class="token operator" data-v-6f1598ec>-></span>Scene <span class="token operator" data-v-6f1598ec>=</span> SceneUniforms<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>GetBuffer</span><span class="token punctuation" data-v-6f1598ec>(</span>GraphBuilder<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token comment" data-v-6f1598ec>// レンダリング結果の出力先を設定</span>
	PassParameters<span class="token operator" data-v-6f1598ec>-></span>RenderTargets<span class="token punctuation" data-v-6f1598ec>[</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>]</span> <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>FRenderTargetBinding</span><span class="token punctuation" data-v-6f1598ec>(</span>SceneTextures<span class="token punctuation" data-v-6f1598ec>.</span>SceneColorTexture<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                        ERenderTargetLoadAction<span class="token punctuation double-colon" data-v-6f1598ec>::</span>EClear<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token comment" data-v-6f1598ec>// DepthStencil の設定</span>
	PassParameters<span class="token operator" data-v-6f1598ec>-></span>RenderTargets<span class="token punctuation" data-v-6f1598ec>.</span>DepthStencil <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>FDepthStencilBinding</span><span class="token punctuation" data-v-6f1598ec>(</span>SceneTextures<span class="token punctuation" data-v-6f1598ec>.</span>SceneDepthTexture<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                                  ERenderTargetLoadAction<span class="token punctuation double-colon" data-v-6f1598ec>::</span>EClear<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                                  ERenderTargetLoadAction<span class="token punctuation double-colon" data-v-6f1598ec>::</span>ELoad<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                                  FExclusiveDepthStencil<span class="token punctuation double-colon" data-v-6f1598ec>::</span>DepthWrite_StencilWrite<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>// メッシュ描画用のパスを RDG に登録</span>
	<span class="token function" data-v-6f1598ec>AddSimpleMeshPass</span><span class="token punctuation" data-v-6f1598ec>(</span>
		GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span> PassParameters<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token operator" data-v-6f1598ec>*</span>View<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token function" data-v-6f1598ec>RDG_EVENT_NAME</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"TinyRendererBasePass"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span>
		View<span class="token operator" data-v-6f1598ec>-></span>UnscaledViewRect<span class="token punctuation" data-v-6f1598ec>,</span> ERDGPassFlags<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Raster<span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token punctuation" data-v-6f1598ec>[</span>View<span class="token punctuation" data-v-6f1598ec>,</span> MeshBatches<span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>(</span>FDynamicPassMeshDrawListContext<span class="token operator" data-v-6f1598ec>*</span> DynamicMeshPassContext<span class="token punctuation" data-v-6f1598ec>)</span>
		<span class="token punctuation" data-v-6f1598ec>{</span>
			<span class="token keyword" data-v-6f1598ec>for</span> <span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMeshBatch<span class="token operator" data-v-6f1598ec>&</span> MeshBatch <span class="token operator" data-v-6f1598ec>:</span> MeshBatches<span class="token punctuation" data-v-6f1598ec>)</span>
			<span class="token punctuation" data-v-6f1598ec>{</span>
				<span class="token comment" data-v-6f1598ec>// マテリアルから ShaderBinding を取得するために、必要に応じて UniformExpression を更新</span>
				MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>MaterialRenderProxy<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>UpdateUniformExpressionCacheIfNeeded</span><span class="token punctuation" data-v-6f1598ec>(</span>View<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetFeatureLevel</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
				<span class="token comment" data-v-6f1598ec>// MeshBatch を TinyRenderer 用の BasePassMeshProcessor に追加</span>
				FTinyRendererBasePassMeshProcessor <span class="token function" data-v-6f1598ec>TinyRendererBasePassMeshProcessor</span><span class="token punctuation" data-v-6f1598ec>(</span>View<span class="token punctuation" data-v-6f1598ec>,</span> DynamicMeshPassContext<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
				TinyRendererBasePassMeshProcessor<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>AddMeshBatch</span><span class="token punctuation" data-v-6f1598ec>(</span>MeshBatch<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token operator" data-v-6f1598ec>~</span><span class="token number" data-v-6f1598ec>0ull</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
			<span class="token punctuation" data-v-6f1598ec>}</span>
		<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<p data-v-6f1598ec>ここでは、レンダリングに必要なパラメータのセットアップから描画パスの登録までを行っています。具体的には、以下のような処理に分けられます。</p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>StaticMesh から MeshBatch を作成する。 MeshBatch はメッシュのレンダリングに必要な情報をまとめた構造体で、あらゆる描画可能なメッシュは MeshBatch に変換してから描画に使われる。
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#staticmesh-%E3%81%8B%E3%82%89%E7%9B%B4%E6%8E%A5-meshbatch-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B" data-v-6f1598ec>CreateMeshBatch()</a></li>
</ul>
</li>
<li data-v-6f1598ec>パスパラメータをセットアップする。ここでは描画先のテクスチャやビュー情報、シーン情報など基本的な要素のほか、 GPUScene に必要なパラメータもセットアップしている。
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#gpuscene-%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B" data-v-6f1598ec>SetupGPUSceneResourceParameters() </a></li>
</ul>
</li>
<li data-v-6f1598ec>パスを RDG に登録する。 RDG には描画パスを登録するための関数が用意されており、ここでは <code data-v-6f1598ec>AddSimpleMeshPass</code> を使って MeshBatch を RDG に登録している。</li>
<li data-v-6f1598ec>パス内部では、MeshPassProcessor を使って MeshBatch の描画命令を登録する。
<ul data-v-6f1598ec>
<li data-v-6f1598ec><a href="#meshbatch-%E3%81%AE%E6%8F%8F%E7%94%BB%E5%91%BD%E4%BB%A4%E3%82%92%E7%99%BA%E8%A1%8C%E3%81%99%E3%82%8B-meshpassprocessor" data-v-6f1598ec>FTinyRendererBasePassMeshProcessor</a></li>
</ul>
</li>
</ul>
<p data-v-6f1598ec><code data-v-6f1598ec>AddSimpleMeshPass</code> は RDG 向けに提供されている便利な関数で、 MeshPassProcessor を使ったメッシュ描画パスに必要なコンテキストのセットアップを行ってくれます。</p>
<h2 id="staticmesh-から直接-meshbatch-を作成する" data-v-6f1598ec><a href="#staticmesh-%E3%81%8B%E3%82%89%E7%9B%B4%E6%8E%A5-meshbatch-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>StaticMesh から直接 MeshBatch を作成する</h2>
<p data-v-6f1598ec>通常の UE のシーンでは、 StaticMesh などのアセットが直接シーンに配置されることはありません(できません)。シーンに存在するすべての可視存在は、 <code data-v-6f1598ec>UStaticMeshComponent</code> など <code data-v-6f1598ec>UPrimitiveComponent</code> を継承したコンポーネントとして配置されます。StaticMesh などのアセットは、コンポーネントに設定されることで間接的に利用されることになります。
レンダリングプロセスとしても、ゲームスレッドの <code data-v-6f1598ec>UPrimitiveComponent</code> の持つメソッドをもとに <code data-v-6f1598ec>FPrimitiveSceneProxy</code> が作成され、それをもとに <code data-v-6f1598ec>FMeshBatch</code> が作成されるという流れになります。 <code data-v-6f1598ec>FMeshBatch</code> が作成できれば、あとは <code data-v-6f1598ec>MeshPassProcessor</code> を使って描画命令を登録するだけで描画が行えます。</p>
<h3 id="ftinyrenderercreatemeshbatch" data-v-6f1598ec><a href="#ftinyrenderercreatemeshbatch" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>FTinyRenderer::CreateMeshBatch</h3>
<p data-v-6f1598ec>しかし、今回のような単一メッシュの描画には、コンポーネントはオーバースペックです。そこで、コンポーネントを介さずに StaticMesh から直接 MeshBatch を作成する方法を考えます。
これを実装したのが <code data-v-6f1598ec>CreateMeshBatch()</code> 関数です。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token comment" data-v-6f1598ec>/**</span>
<span class="token comment" data-v-6f1598ec> * @param InStaticMesh MeshBatch を作成する StaticMesh</span>
<span class="token comment" data-v-6f1598ec> * @param InLODIndex MeshBatch を作成する StaticMesh の LODIndex</span>
<span class="token comment" data-v-6f1598ec> * @param InMeshBatches 作成した MeshBatch を格納する配列</span>
<span class="token comment" data-v-6f1598ec> * @param RequiredFeatures MeshBatch が描画時に必要とする機能</span>
<span class="token comment" data-v-6f1598ec> * @return MeshBatch が作成できた場合は true、それ以外は false</span>
<span class="token comment" data-v-6f1598ec> */</span>
<span class="token keyword" data-v-6f1598ec>bool</span> <span class="token class-name" data-v-6f1598ec>FTinyRenderer</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>CreateMeshBatch</span><span class="token punctuation" data-v-6f1598ec>(</span>UStaticMesh<span class="token operator" data-v-6f1598ec>*</span> InStaticMesh<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>const</span> int32 InLODIndex<span class="token punctuation" data-v-6f1598ec>,</span>
                                    TArray<span class="token operator" data-v-6f1598ec>&lt;</span>FMeshBatch<span class="token operator" data-v-6f1598ec>></span><span class="token operator" data-v-6f1598ec>&</span> InMeshBatches<span class="token punctuation" data-v-6f1598ec>,</span>
                                    FMeshBatchesRequiredFeatures<span class="token operator" data-v-6f1598ec>&</span> RequiredFeatures<span class="token punctuation" data-v-6f1598ec>)</span> <span class="token keyword" data-v-6f1598ec>const</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token function" data-v-6f1598ec>SCOPED_NAMED_EVENT_F</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"FTinyRenderer::CreateMeshBatch - %s"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> FColor<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Emerald<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token operator" data-v-6f1598ec>*</span>InStaticMesh<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetName</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>// StaticMesh がコンパイル中の場合は MeshBatch を作成しない</span>
	<span class="token comment" data-v-6f1598ec>// Editor 用チェックであり、非 Editor ビルドでは定数化するので、最適化で消える</span>
	<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span>InStaticMesh<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>IsCompiling</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>return</span> <span class="token boolean" data-v-6f1598ec>false</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>// StaticMesh から RenderData を取得。ここに StaticMesh のメッシュデータが格納されている</span>
	FStaticMeshRenderData<span class="token operator" data-v-6f1598ec>*</span> RenderData <span class="token operator" data-v-6f1598ec>=</span> InStaticMesh<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetRenderData</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token keyword" data-v-6f1598ec>const</span> int32 LODResourceIndex <span class="token operator" data-v-6f1598ec>=</span> <span class="token class-name" data-v-6f1598ec>FMath</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>Min</span><span class="token punctuation" data-v-6f1598ec>(</span>InLODIndex<span class="token punctuation" data-v-6f1598ec>,</span> RenderData<span class="token operator" data-v-6f1598ec>-></span>LODResources<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Num</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span> <span class="token operator" data-v-6f1598ec>-</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span>LODResourceIndex <span class="token operator" data-v-6f1598ec>&lt;</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>return</span> <span class="token boolean" data-v-6f1598ec>false</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>// 以下、LODResources から指定の LODIndex のメッシュデータを読み出し、MeshBatch を作成する</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FStaticMeshSectionArray<span class="token operator" data-v-6f1598ec>&</span> Sections <span class="token operator" data-v-6f1598ec>=</span> RenderData<span class="token operator" data-v-6f1598ec>-></span>LODResources<span class="token punctuation" data-v-6f1598ec>[</span>LODResourceIndex<span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>.</span>Sections<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>// セクションの数だけ MeshBatch を作成。一般的に、StaticMesh に割り当てられているマテリアルの数と対応している</span>
	<span class="token keyword" data-v-6f1598ec>for</span> <span class="token punctuation" data-v-6f1598ec>(</span>int32 SectionIndex <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>;</span> SectionIndex <span class="token operator" data-v-6f1598ec>&lt;</span> Sections<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Num</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span> SectionIndex<span class="token operator" data-v-6f1598ec>++</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FStaticMeshSection<span class="token operator" data-v-6f1598ec>&</span> Section <span class="token operator" data-v-6f1598ec>=</span> Sections<span class="token punctuation" data-v-6f1598ec>[</span>SectionIndex<span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span>Section<span class="token punctuation" data-v-6f1598ec>.</span>NumTriangles <span class="token operator" data-v-6f1598ec>==</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>)</span>
		<span class="token punctuation" data-v-6f1598ec>{</span>
			<span class="token keyword" data-v-6f1598ec>continue</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token punctuation" data-v-6f1598ec>}</span>

		<span class="token keyword" data-v-6f1598ec>const</span> FStaticMeshLODResources<span class="token operator" data-v-6f1598ec>&</span> LODResource <span class="token operator" data-v-6f1598ec>=</span> RenderData<span class="token operator" data-v-6f1598ec>-></span>LODResources<span class="token punctuation" data-v-6f1598ec>[</span>LODResourceIndex<span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>// データを MeshBatch に格納していく</span>
		FMeshBatch MeshBatch<span class="token punctuation" data-v-6f1598ec>;</span>
		MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>VertexFactory <span class="token operator" data-v-6f1598ec>=</span> <span class="token operator" data-v-6f1598ec>&</span>RenderData<span class="token operator" data-v-6f1598ec>-></span>LODVertexFactories<span class="token punctuation" data-v-6f1598ec>[</span>LODResourceIndex<span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>.</span>VertexFactory<span class="token punctuation" data-v-6f1598ec>;</span>
		MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>Type <span class="token operator" data-v-6f1598ec>=</span> PT_TriangleList<span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>// MeshBatch の Element に IndexBuffer などを格納。MeshBatch は複数の Element を持つことができるが、エンジンでも多くの場合は 1 つの Element しか使われていない</span>
		FMeshBatchElement<span class="token operator" data-v-6f1598ec>&</span> BatchElement <span class="token operator" data-v-6f1598ec>=</span> MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>Elements<span class="token punctuation" data-v-6f1598ec>[</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FLocalVertexFactory<span class="token operator" data-v-6f1598ec>*</span> VertexFactory <span class="token operator" data-v-6f1598ec>=</span> <span class="token generic-function" data-v-6f1598ec><span class="token function" data-v-6f1598ec>static_cast</span><span class="token class-name generic" data-v-6f1598ec><span class="token operator" data-v-6f1598ec>&lt;</span><span class="token keyword" data-v-6f1598ec>const</span> FLocalVertexFactory<span class="token operator" data-v-6f1598ec>*</span><span class="token operator" data-v-6f1598ec>></span></span></span><span class="token punctuation" data-v-6f1598ec>(</span>MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>VertexFactory<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		BatchElement<span class="token punctuation" data-v-6f1598ec>.</span>VertexFactoryUserData <span class="token operator" data-v-6f1598ec>=</span> VertexFactory<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetUniformBuffer</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		BatchElement<span class="token punctuation" data-v-6f1598ec>.</span>IndexBuffer <span class="token operator" data-v-6f1598ec>=</span> <span class="token operator" data-v-6f1598ec>&</span>LODResource<span class="token punctuation" data-v-6f1598ec>.</span>IndexBuffer<span class="token punctuation" data-v-6f1598ec>;</span>
		BatchElement<span class="token punctuation" data-v-6f1598ec>.</span>FirstIndex <span class="token operator" data-v-6f1598ec>=</span> Section<span class="token punctuation" data-v-6f1598ec>.</span>FirstIndex<span class="token punctuation" data-v-6f1598ec>;</span>
		BatchElement<span class="token punctuation" data-v-6f1598ec>.</span>NumPrimitives <span class="token operator" data-v-6f1598ec>=</span> Section<span class="token punctuation" data-v-6f1598ec>.</span>NumTriangles<span class="token punctuation" data-v-6f1598ec>;</span>
		BatchElement<span class="token punctuation" data-v-6f1598ec>.</span>MinVertexIndex <span class="token operator" data-v-6f1598ec>=</span> Section<span class="token punctuation" data-v-6f1598ec>.</span>MinVertexIndex<span class="token punctuation" data-v-6f1598ec>;</span>
		BatchElement<span class="token punctuation" data-v-6f1598ec>.</span>MaxVertexIndex <span class="token operator" data-v-6f1598ec>=</span> Section<span class="token punctuation" data-v-6f1598ec>.</span>MaxVertexIndex<span class="token punctuation" data-v-6f1598ec>;</span>
		BatchElement<span class="token punctuation" data-v-6f1598ec>.</span>PrimitiveIdMode <span class="token operator" data-v-6f1598ec>=</span> PrimID_DynamicPrimitiveShaderData<span class="token punctuation" data-v-6f1598ec>;</span>

		MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>LODIndex <span class="token operator" data-v-6f1598ec>=</span> LODResourceIndex<span class="token punctuation" data-v-6f1598ec>;</span>
		MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>SegmentIndex <span class="token operator" data-v-6f1598ec>=</span> SectionIndex<span class="token punctuation" data-v-6f1598ec>;</span>
		MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>CastShadow <span class="token operator" data-v-6f1598ec>=</span> <span class="token boolean" data-v-6f1598ec>false</span><span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>// マテリアルを取得</span>
		<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> UMaterialInterface<span class="token operator" data-v-6f1598ec>*</span> MaterialInterface <span class="token operator" data-v-6f1598ec>=</span> InStaticMesh<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetMaterial</span><span class="token punctuation" data-v-6f1598ec>(</span>Section<span class="token punctuation" data-v-6f1598ec>.</span>MaterialIndex<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
			BatchElement<span class="token punctuation" data-v-6f1598ec>.</span>NumPrimitives <span class="token operator" data-v-6f1598ec>></span> <span class="token number" data-v-6f1598ec>0</span> <span class="token operator" data-v-6f1598ec>&&</span> MaterialInterface <span class="token operator" data-v-6f1598ec>!=</span> <span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>)</span>
		<span class="token punctuation" data-v-6f1598ec>{</span>
			<span class="token keyword" data-v-6f1598ec>const</span> <span class="token keyword" data-v-6f1598ec>auto</span> MaterialProxy <span class="token operator" data-v-6f1598ec>=</span> MaterialInterface<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetRenderProxy</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
			<span class="token comment" data-v-6f1598ec>// マテリアルのレンダースレッド表現である MaterialRenderProxy を MeshBatch に MaterialRenderProxy を格納</span>
			MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>MaterialRenderProxy <span class="token operator" data-v-6f1598ec>=</span> MaterialProxy<span class="token punctuation" data-v-6f1598ec>;</span>
			InMeshBatches<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Add</span><span class="token punctuation" data-v-6f1598ec>(</span>MeshBatch<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

			<span class="token keyword" data-v-6f1598ec>const</span> FMaterialRelevance<span class="token operator" data-v-6f1598ec>&</span> MaterialRelevance <span class="token operator" data-v-6f1598ec>=</span> MaterialInterface<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetRelevance_Concurrent</span><span class="token punctuation" data-v-6f1598ec>(</span>FeatureLevel<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
			<span class="token comment" data-v-6f1598ec>// マテリアルが利用を要求しているレンダリング機能を RequiredFeatures に格納</span>
			<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span>MaterialRelevance<span class="token punctuation" data-v-6f1598ec>.</span>bUsesWorldPositionOffset<span class="token punctuation" data-v-6f1598ec>)</span>
			<span class="token punctuation" data-v-6f1598ec>{</span>
				RequiredFeatures<span class="token punctuation" data-v-6f1598ec>.</span>bWorldPositionOffset <span class="token operator" data-v-6f1598ec>=</span> <span class="token boolean" data-v-6f1598ec>true</span><span class="token punctuation" data-v-6f1598ec>;</span>
			<span class="token punctuation" data-v-6f1598ec>}</span>
		<span class="token punctuation" data-v-6f1598ec>}</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span>InMeshBatches<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>IsEmpty</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>return</span> <span class="token boolean" data-v-6f1598ec>false</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token keyword" data-v-6f1598ec>return</span> <span class="token boolean" data-v-6f1598ec>true</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<p data-v-6f1598ec>StaticMesh には LOD で分割されたメッシュデータが格納されており、更にその中に複数のセクションが存在します。セクションは、メッシュデータの一部を表すもので、一般的にはマテリアルごとに分割されています。
MeshBatch 一つあたり１つのマテリアルが割り当てられるため、セクションごとに MeshBatch を作成しています。
マテリアルのレンダースレッド表現については前回の <a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-2/#%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB%E3%81%A8%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%83%AC%E3%83%B3%E3%83%80%E3%83%BC%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E8%A1%A8%E7%8F%BE" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>マテリアルとシェーダーレンダースレッド表現</a> を参照してください。</p>
<p data-v-6f1598ec>UE のマテリアルはビジュアルシェーダー言語であるため、その設定によって要求されるレンダリング機能が変わります。ここでは例として、 MeshBatches の作成とともに、それらを描画するために WorldPositionOffset が必要かどうかを取得する処理を加えています。
取得した情報は後のシェーダーパラメータ作成に利用されます。</p>
<p data-v-6f1598ec>また、頂点ファクトリ(Vertex Factory)は独自パスを書くうえで非常に重要です。頂点ファクトリはメッシュの種別に紐づく形で様々な種類が存在しており、紐づくメッシュタイプの頂点データを処理して Vertex Shader に提供する役割を果たします。詳細は前回記事の <a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-2#%E9%A0%82%E7%82%B9%E3%83%95%E3%82%A1%E3%82%AF%E3%83%88%E3%83%AA" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>頂点データの受け渡し</a> を参照してください。
ここでは StaticMesh が利用する頂点ファクトリである <code data-v-6f1598ec>FLocalVertexFactory</code> を前提として MeshBatch を作成しています。</p>
<h2 id="gpuscene-のためのパラメータをセットアップする" data-v-6f1598ec><a href="#gpuscene-%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%82%92%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>GPUScene のためのパラメータをセットアップする</h2>
<p data-v-6f1598ec>GPUScene は、GPU 側にプリミティブやそのインスタンスの配置情報を表すバッファを持つことで、プリミティブの GPU への送信回数を最適化したり、一度のドローコールで複数のメッシュを描画したりできるようにする機能です。
StaticMesh のキャッシングや、いわゆる GPU Instancing と呼ばれるものなどはこれによって実現されています。</p>
<p data-v-6f1598ec>今回のレンダラはキャッシュ等を行わないし単一メッシュなのに、どうして GPUScene をセットアップするんだ？　という疑問はごもっともです。実際、機能としては必要ありません。ただ、UE の StaticMesh 描画実装をうまく流用して実装を行おうとすると GPUScene を利用しないほうが複雑になるため、 1 プリミティブ 1 インスタンスの GPUScene をセットアップすることにしました。</p>
<p data-v-6f1598ec>なお、FLocalVertexFactory の派生ファクトリを作成し、Shader のコンパイルパラメータを変更してから利用させることで、 GPUScene を利用しないようにすることも可能ではあります。FLocalVertexFactory をそのまま利用する場合には、GPUScene の利用がプラットフォームと Feature Level で自動的に決定されてしまいます。</p>
<h3 id="ftinyrenderersetupgpusceneresourceparameters" data-v-6f1598ec><a href="#ftinyrenderersetupgpusceneresourceparameters" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>FTinyRenderer::SetupGPUSceneResourceParameters</h3>
<p data-v-6f1598ec>GPUScene の基本的な仕組みは、Vertex Shader にわたす頂点情報に、プリミティブ ID などの情報を追加することで、GPU 側でプリミティブごとの情報を取得できるようにすることです。プリミティブごとの情報は別途バッファとして GPU に渡され、シェーダー側で利用されます。
この構築を行うのが <code data-v-6f1598ec>SetupGPUSceneResourceParameters</code> 関数です。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token comment" data-v-6f1598ec>/**</span>
<span class="token comment" data-v-6f1598ec> * @param GraphBuilder RDGBuilder</span>
<span class="token comment" data-v-6f1598ec> * @param RequiredFeatures 対象の MeshBatch の描画時に必要とする機能</span>
<span class="token comment" data-v-6f1598ec> * @return GPUScene のためのパラメータ</span>
<span class="token comment" data-v-6f1598ec> */</span>
FGPUSceneResourceParameters <span class="token class-name" data-v-6f1598ec>FTinyRenderer</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>SetupGPUSceneResourceParameters</span><span class="token punctuation" data-v-6f1598ec>(</span>FRDGBuilder<span class="token operator" data-v-6f1598ec>&</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span>
                                                                           <span class="token keyword" data-v-6f1598ec>const</span> FMeshBatchesRequiredFeatures<span class="token operator" data-v-6f1598ec>&</span> RequiredFeatures<span class="token punctuation" data-v-6f1598ec>)</span> <span class="token keyword" data-v-6f1598ec>const</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token comment" data-v-6f1598ec>/* PrimitiveData として使うパラメータを構築 */</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FPrimitiveUniformShaderParameters PrimitiveParams <span class="token operator" data-v-6f1598ec>=</span> FPrimitiveUniformShaderParametersBuilder<span class="token punctuation" data-v-6f1598ec>{</span><span class="token punctuation" data-v-6f1598ec>}</span>
	                                                          <span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Defaults</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span>
	                                                          <span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>LocalToWorld</span><span class="token punctuation" data-v-6f1598ec>(</span>LocalToWorld<span class="token punctuation" data-v-6f1598ec>)</span>
	                                                          <span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>ActorWorldPosition</span><span class="token punctuation" data-v-6f1598ec>(</span>LocalToWorld<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>GetOrigin</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span>
	                                                          <span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>EvaluateWorldPositionOffset</span><span class="token punctuation" data-v-6f1598ec>(</span>RequiredFeatures<span class="token punctuation" data-v-6f1598ec>.</span>bWorldPositionOffset<span class="token punctuation" data-v-6f1598ec>)</span>
	                                                          <span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Build</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FPrimitiveSceneShaderData <span class="token function" data-v-6f1598ec>PrimitiveSceneData</span><span class="token punctuation" data-v-6f1598ec>(</span>PrimitiveParams<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	FGPUSceneResourceParameters GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>/* Primitive Data のバッファを作成 */</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FRDGBufferRef RDGPrimitiveSceneDataBuffer <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>CreateStructuredBuffer</span><span class="token punctuation" data-v-6f1598ec>(</span>GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span>
			<span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"PrimitiveSceneDataBuffer"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> TArray<span class="token punctuation" data-v-6f1598ec>{</span>PrimitiveSceneData<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>.</span>GPUScenePrimitiveSceneData <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>CreateSRV</span><span class="token punctuation" data-v-6f1598ec>(</span>RDGPrimitiveSceneDataBuffer<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>.</span>NumScenePrimitives <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		FInstanceSceneShaderData InstanceSceneData<span class="token punctuation" data-v-6f1598ec>{</span><span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>
		InstanceSceneData<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Build</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token comment" data-v-6f1598ec>/* PrimitiveId */</span>
		                        <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token comment" data-v-6f1598ec>/* RelativeId */</span>
		                        <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token comment" data-v-6f1598ec>/* InstanceFlags */</span>
		                        INVALID_LAST_UPDATE_FRAME<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token comment" data-v-6f1598ec>/* LastUpdateFrame */</span>
		                        <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token comment" data-v-6f1598ec>/* CustomDataCount */</span>
		                        <span class="token number" data-v-6f1598ec>0.0f</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token comment" data-v-6f1598ec>/* RandomID */</span>
		                        FRenderTransform<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Identity<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token comment" data-v-6f1598ec>/* LocalToPrimitive */</span>
		                        PrimitiveParams<span class="token punctuation" data-v-6f1598ec>.</span>LocalToRelativeWorld<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span> <span class="token comment" data-v-6f1598ec>/* PrimitiveToWorld */</span>

		<span class="token comment" data-v-6f1598ec>/* Instance Data のバッファを作成 */</span>
		TArray<span class="token operator" data-v-6f1598ec>&lt;</span>FVector4f<span class="token operator" data-v-6f1598ec>></span> InstanceSceneDataSOA<span class="token punctuation" data-v-6f1598ec>;</span>
		InstanceSceneDataSOA<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>AddZeroed</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token class-name" data-v-6f1598ec>FInstanceSceneShaderData</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>GetDataStrideInFloat4s</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>for</span> <span class="token punctuation" data-v-6f1598ec>(</span>uint32 ArrayIndex <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>;</span> ArrayIndex <span class="token operator" data-v-6f1598ec>&lt;</span> <span class="token class-name" data-v-6f1598ec>FInstanceSceneShaderData</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>GetDataStrideInFloat4s</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span> ArrayIndex<span class="token operator" data-v-6f1598ec>++</span><span class="token punctuation" data-v-6f1598ec>)</span>
		<span class="token punctuation" data-v-6f1598ec>{</span>
			InstanceSceneDataSOA<span class="token punctuation" data-v-6f1598ec>[</span>ArrayIndex<span class="token punctuation" data-v-6f1598ec>]</span> <span class="token operator" data-v-6f1598ec>=</span> InstanceSceneData<span class="token punctuation" data-v-6f1598ec>.</span>Data<span class="token punctuation" data-v-6f1598ec>[</span>ArrayIndex<span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token punctuation" data-v-6f1598ec>}</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FRDGBufferRef RDGInstanceSceneDataBuffer <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>CreateStructuredBuffer</span><span class="token punctuation" data-v-6f1598ec>(</span>GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span>
			<span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"InstanceSceneDataBuffer"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> InstanceSceneDataSOA<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>.</span>GPUSceneInstanceSceneData <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>CreateSRV</span><span class="token punctuation" data-v-6f1598ec>(</span>RDGInstanceSceneDataBuffer<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>.</span>InstanceDataSOAStride <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>;</span>
		GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>.</span>NumInstances <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>/* ダミーのバッファで不要なパラメータを埋める */</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FRDGBufferRef DummyBufferVec4 <span class="token operator" data-v-6f1598ec>=</span> GSystemTextures<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>GetDefaultStructuredBuffer</span><span class="token punctuation" data-v-6f1598ec>(</span>
			GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>sizeof</span><span class="token punctuation" data-v-6f1598ec>(</span>FVector4f<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FRDGBufferRef DummyBufferLight <span class="token operator" data-v-6f1598ec>=</span> GSystemTextures<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>GetDefaultStructuredBuffer</span><span class="token punctuation" data-v-6f1598ec>(</span>
			GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>sizeof</span><span class="token punctuation" data-v-6f1598ec>(</span>FLightSceneData<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>.</span>GPUSceneInstancePayloadData <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>CreateSRV</span><span class="token punctuation" data-v-6f1598ec>(</span>DummyBufferVec4<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>.</span>GPUSceneLightmapData <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>CreateSRV</span><span class="token punctuation" data-v-6f1598ec>(</span>DummyBufferVec4<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>.</span>GPUSceneLightData <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>CreateSRV</span><span class="token punctuation" data-v-6f1598ec>(</span>DummyBufferLight<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>/* たぶん NRVO が効くのでそのまま返しちゃいましょう */</span>
	<span class="token keyword" data-v-6f1598ec>return</span> GPUSceneParameters<span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<p data-v-6f1598ec><code data-v-6f1598ec>FPrimitiveUniformShaderParametersBuilder</code> を通して作成している <code data-v-6f1598ec>FPrimitiveSceneShaderData</code> は、プリミティブごとの情報を表す構造体です。一方 <code data-v-6f1598ec>FInstanceSceneShaderData</code> は、インスタンスごとの情報を表す構造体で、きちんと GPUScene を使うときには 1 つのプリミティブに対して複数のインスタンスが存在することを考慮して設計されています。
ここでは単一メッシュの描画を行うためどちらも１つで十分で、必要最低限の情報しか設定していません。高度な GPUScene の構築についてはエンジンの <code data-v-6f1598ec>Engine\UE5\Source\Runtime\Renderer\Private\GPUScene.cpp:FGPUScene::UploadGeneral()</code> が参考になります。</p>
<h3 id="ftinyrenderersetgpusceneresourceparameters" data-v-6f1598ec><a href="#ftinyrenderersetgpusceneresourceparameters" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>FTinyRenderer::SetGPUSceneResourceParameters</h3>
<p data-v-6f1598ec>これは単に、構築した GPUScene のパラメータを RDG のリソースとしてセットアップする関数です。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>void</span> <span class="token class-name" data-v-6f1598ec>FTinyRenderer</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>SetGPUSceneResourceParameters</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FGPUSceneResourceParameters<span class="token operator" data-v-6f1598ec>&</span> Parameters<span class="token punctuation" data-v-6f1598ec>)</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	SceneUniforms<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Set</span><span class="token punctuation" data-v-6f1598ec>(</span>SceneUB<span class="token punctuation double-colon" data-v-6f1598ec>::</span>GPUScene<span class="token punctuation" data-v-6f1598ec>,</span> Parameters<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<h2 id="マテリアルを利用した描画処理を行えるシェーダーの作成" data-v-6f1598ec><a href="#%E3%83%9E%E3%83%86%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E6%8F%8F%E7%94%BB%E5%87%A6%E7%90%86%E3%82%92%E8%A1%8C%E3%81%88%E3%82%8B%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>マテリアルを利用した描画処理を行えるシェーダーの作成</h2>
<p data-v-6f1598ec>以上の内容で描画したいメッシュのセットアップは概ね完了しました。次に、描画処理を行うシェーダーを作成します。今回のシェーダーは以下のような要件を満たす必要があります。</p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>StaticMesh に割り当てられたマテリアルを使って描画することができる</li>
<li data-v-6f1598ec>UE の標準レンダリング機能と近い見た目を提供する</li>
<li data-v-6f1598ec>軽量である</li>
</ul>
<p data-v-6f1598ec>特に、マテリアルアセットと組み合わせて利用できるシェーダーの定義にはいくつか考慮すべきポイントがあるため、それについても解説します。</p>
<h3 id="ftinyrenderershader-vsps-の-c-定義" data-v-6f1598ec><a href="#ftinyrenderershader-vsps-%E3%81%AE-c-%E5%AE%9A%E7%BE%A9" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>FTinyRendererShader (VS/PS) の C++ 定義</h3>
<p data-v-6f1598ec>まずは Shader の C++ 定義です。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token comment" data-v-6f1598ec>/* TinyRenderer の VS/PS 共通で利用する機能を定義 */</span>
<span class="token keyword" data-v-6f1598ec>namespace</span> TinyRendererShader
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token comment" data-v-6f1598ec>/* シェーダーのコンパイル環境を変更 */</span>
	<span class="token keyword" data-v-6f1598ec>static</span> <span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>ModifyCompilationEnvironment</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMaterialShaderPermutationParameters<span class="token operator" data-v-6f1598ec>&</span> Parameters<span class="token punctuation" data-v-6f1598ec>,</span>
	                                         FShaderCompilerEnvironment<span class="token operator" data-v-6f1598ec>&</span> OutEnvironment<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>/* GPUScene は利用するが、InstanceCulling は不要 */</span>
		OutEnvironment<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetDefine</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"USE_INSTANCE_CULLING_DATA"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		OutEnvironment<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetDefine</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"USE_INSTANCE_CULLING"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>/* 任意の ShaderPermutation に対してコンパイルを行うかどうかを判定 */</span>
	<span class="token keyword" data-v-6f1598ec>static</span> <span class="token keyword" data-v-6f1598ec>bool</span> <span class="token function" data-v-6f1598ec>ShouldCompilePermutation</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMeshMaterialShaderPermutationParameters<span class="token operator" data-v-6f1598ec>&</span> Parameters<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>static</span> FName <span class="token function" data-v-6f1598ec>NAME_LocalVertexFactory</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"FLocalVertexFactory"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>return</span> <span class="token punctuation" data-v-6f1598ec>(</span>Parameters<span class="token punctuation" data-v-6f1598ec>.</span>MaterialParameters<span class="token punctuation" data-v-6f1598ec>.</span>MaterialDomain <span class="token operator" data-v-6f1598ec>==</span> MD_Surface<span class="token punctuation" data-v-6f1598ec>)</span> <span class="token operator" data-v-6f1598ec>&&</span>
			Parameters<span class="token punctuation" data-v-6f1598ec>.</span>VertexFactoryType <span class="token operator" data-v-6f1598ec>==</span> <span class="token function" data-v-6f1598ec>FindVertexFactoryType</span><span class="token punctuation" data-v-6f1598ec>(</span>NAME_LocalVertexFactory<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>
<span class="token punctuation" data-v-6f1598ec>}</span>

<span class="token comment" data-v-6f1598ec>/* TinyRenderer の頂点シェーダー C++ 定義 */</span>
<span class="token keyword" data-v-6f1598ec>class</span> <span class="token class-name" data-v-6f1598ec>FTinyRendererShaderVS</span> <span class="token operator" data-v-6f1598ec>:</span> <span class="token base-clause" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>public</span> <span class="token class-name" data-v-6f1598ec>FMeshMaterialShader</span></span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token function" data-v-6f1598ec>DECLARE_SHADER_TYPE</span><span class="token punctuation" data-v-6f1598ec>(</span>FTinyRendererShaderVS<span class="token punctuation" data-v-6f1598ec>,</span> MeshMaterial<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token keyword" data-v-6f1598ec>static</span> <span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>ModifyCompilationEnvironment</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMaterialShaderPermutationParameters<span class="token operator" data-v-6f1598ec>&</span> Parameters<span class="token punctuation" data-v-6f1598ec>,</span>
	                                         FShaderCompilerEnvironment<span class="token operator" data-v-6f1598ec>&</span> OutEnvironment<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>/* 親の環境定義を引き継ぎつつ、TinyRenderer 用の環境定義を追加 */</span>
		<span class="token class-name" data-v-6f1598ec>FMeshMaterialShader</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>ModifyCompilationEnvironment</span><span class="token punctuation" data-v-6f1598ec>(</span>Parameters<span class="token punctuation" data-v-6f1598ec>,</span> OutEnvironment<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token class-name" data-v-6f1598ec>TinyRendererShader</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>ModifyCompilationEnvironment</span><span class="token punctuation" data-v-6f1598ec>(</span>Parameters<span class="token punctuation" data-v-6f1598ec>,</span> OutEnvironment<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token keyword" data-v-6f1598ec>static</span> <span class="token keyword" data-v-6f1598ec>bool</span> <span class="token function" data-v-6f1598ec>ShouldCompilePermutation</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMeshMaterialShaderPermutationParameters<span class="token operator" data-v-6f1598ec>&</span> Parameters<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>return</span> <span class="token class-name" data-v-6f1598ec>TinyRendererShader</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>ShouldCompilePermutation</span><span class="token punctuation" data-v-6f1598ec>(</span>Parameters<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>
<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>

<span class="token comment" data-v-6f1598ec>/* TinyRenderer のピクセルシェーダー C++ 定義 */</span>
<span class="token keyword" data-v-6f1598ec>class</span> <span class="token class-name" data-v-6f1598ec>FTinyRendererShaderPS</span> <span class="token operator" data-v-6f1598ec>:</span> <span class="token base-clause" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>public</span> <span class="token class-name" data-v-6f1598ec>FMeshMaterialShader</span></span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token function" data-v-6f1598ec>DECLARE_SHADER_TYPE</span><span class="token punctuation" data-v-6f1598ec>(</span>FTinyRendererShaderPS<span class="token punctuation" data-v-6f1598ec>,</span> MeshMaterial<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token keyword" data-v-6f1598ec>static</span> <span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>ModifyCompilationEnvironment</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMaterialShaderPermutationParameters<span class="token operator" data-v-6f1598ec>&</span> Parameters<span class="token punctuation" data-v-6f1598ec>,</span>
	                                         FShaderCompilerEnvironment<span class="token operator" data-v-6f1598ec>&</span> OutEnvironment<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>/* 親の環境定義を引き継ぎつつ、TinyRenderer 用の環境定義を追加 */</span>
		<span class="token class-name" data-v-6f1598ec>FMeshMaterialShader</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>ModifyCompilationEnvironment</span><span class="token punctuation" data-v-6f1598ec>(</span>Parameters<span class="token punctuation" data-v-6f1598ec>,</span> OutEnvironment<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token class-name" data-v-6f1598ec>TinyRendererShader</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>ModifyCompilationEnvironment</span><span class="token punctuation" data-v-6f1598ec>(</span>Parameters<span class="token punctuation" data-v-6f1598ec>,</span> OutEnvironment<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>/* PixelShader 特有の環境定義を追加 */</span>
		<span class="token comment" data-v-6f1598ec>/* ライトベイクは行わないので、ライトマップ系機能は不要 */</span>
		OutEnvironment<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetDefine</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"NEEDS_LIGHTMAP_COORDINATE"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token comment" data-v-6f1598ec>/* 独自の出力を行うため、通常の SceneTexture は不要 */</span>
		OutEnvironment<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetDefine</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"SCENE_TEXTURES_DISABLED"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token keyword" data-v-6f1598ec>static</span> <span class="token keyword" data-v-6f1598ec>bool</span> <span class="token function" data-v-6f1598ec>ShouldCompilePermutation</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMeshMaterialShaderPermutationParameters<span class="token operator" data-v-6f1598ec>&</span> Parameters<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>return</span> <span class="token class-name" data-v-6f1598ec>TinyRendererShader</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>ShouldCompilePermutation</span><span class="token punctuation" data-v-6f1598ec>(</span>Parameters<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>
<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>
</code></pre></div>
<p data-v-6f1598ec><a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-2#shader-%E3%81%AF%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E6%89%B1%E3%82%8F%E3%82%8C%E3%82%8B%E3%81%AE%E3%81%8B" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>前回の記事</a> でも説明しましたが、UE のシェーダーは C++ 側の定義クラスと USF(HLSLもどき) 実装のペアで構成されます。
C++定義クラスの派生元としては、よく <code data-v-6f1598ec>FGlobalShader</code> が使われますが、これをマテリアルと組み合わせて利用するのは少し面倒です。
マテリアルと組み合わせて利用する場合には <code data-v-6f1598ec>FMaterialShader</code> もしくは <code data-v-6f1598ec>FMeshMaterialShader</code> の派生を定義することになり、特にメッシュ描画においては <code data-v-6f1598ec>FMeshMaterialShader</code> を使うと便利です。</p>
<p data-v-6f1598ec>UE のマテリアルアセットは、背後でシェーダーコードを生成します。しかし、このコードはそれ単体で動作するものではなく、別のテキストで実装されたシェーダーからコードの断片として利用されてはじめて機能します。
つまり UE のマテリアルとは、テキストのシェーダーが公開したカスタマイゼーションポイントを埋めるコードを生成するためのツールなのです。</p>
<p data-v-6f1598ec>このため、マテリアルとそれを利用するシェーダーは、常に組み合わせて合わせてコンパイルされる必要があります。組み合わせは 1対1 ではなく多対多の関係になり、このあらゆる組み合わせのことを ShaderPermutation と呼びます。
しかし、すべてのシェーダーとマテリアルに互換性があるわけではありません。たとえば、材質のマテリアルと組み合わせるシェーダーはポスプロのマテリアルとは互換性がありません。
また、互換性があっても、目的として利用しない組み合わせまでコンパイルしてしまうと、組み合わせ爆発によって長大なシェーダーコンパイルを引き起こす可能性があります。</p>
<p data-v-6f1598ec>そこで上記のコードのように、 <code data-v-6f1598ec>ShouldCompilePermutation</code> という関数を使ってシェーダーのコンパイル環境に対してフィルタリングを行います。今回のケースでは、 StaticMesh のレンダリングにさえ対応していればよいため、 組み合わせるマテリアルのドメインが <code data-v-6f1598ec>MD_Surface</code> であることと、適応するメッシュの頂点ファクトリが <code data-v-6f1598ec>FLocalVertexFactory</code> であることを条件としています。</p>
<p data-v-6f1598ec>より詳しくは <a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-2/#%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E8%A8%AD%E5%AE%9A" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>前回記事のシェーダーのコンパイル設定のセクション</a> を参照してください。</p>
<h3 id="独自メッシュ描画パス処理の頂点シェーダー実装" data-v-6f1598ec><a href="#%E7%8B%AC%E8%87%AA%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E6%8F%8F%E7%94%BB%E3%83%91%E3%82%B9%E5%87%A6%E7%90%86%E3%81%AE%E9%A0%82%E7%82%B9%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E5%AE%9F%E8%A3%85" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>独自メッシュ描画パス処理の頂点シェーダー実装</h3>
<p data-v-6f1598ec>UE では、HLSL をベースにした USF というファイル形式でシェーダーコードを記述します。USF をもとに各プラットフォーム向けのシェーダーコードが生成され、コンパイルされるため、共通のコードでクロスプラットフォームのシェーダーを記述することができます。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-hlsl" data-v-6f1598ec><code class="language-hlsl" data-v-6f1598ec><span class="token macro property" data-v-6f1598ec><span class="token directive-hash" data-v-6f1598ec>#</span><span class="token keyword directive" data-v-6f1598ec>include</span> <span class="token string" data-v-6f1598ec>"/Engine/Generated/Material.ush"</span></span>
<span class="token macro property" data-v-6f1598ec><span class="token directive-hash" data-v-6f1598ec>#</span><span class="token keyword directive" data-v-6f1598ec>include</span> <span class="token string" data-v-6f1598ec>"/Engine/Generated/VertexFactory.ush"</span></span>

<span class="token comment" data-v-6f1598ec>/* Vertex Shader から Pixel Shader へ受け渡すデータ */</span>
<span class="token keyword" data-v-6f1598ec>struct</span> <span class="token class-name" data-v-6f1598ec>FTinyRendererVSToPS</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token keyword" data-v-6f1598ec>float4</span> Position <span class="token operator" data-v-6f1598ec>:</span> SV_POSITION<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>float4</span> PixelPosition <span class="token operator" data-v-6f1598ec>:</span> POSITION8<span class="token punctuation" data-v-6f1598ec>;</span>
	FVertexFactoryInterpolantsVSToPS FactoryInterpolants<span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>

<span class="token comment" data-v-6f1598ec>/* Vertex Shader */</span>
<span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>MainVS</span><span class="token punctuation" data-v-6f1598ec>(</span>FVertexFactoryInput Input<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>out</span> FTinyRendererVSToPS Output<span class="token punctuation" data-v-6f1598ec>)</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	ResolvedView <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>ResolveView</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	

	<span class="token comment" data-v-6f1598ec>/* GPUScene から現在の処理対象のインスタンスの情報を取得 */</span>
	FVertexFactoryIntermediates VFIntermediates <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetVertexFactoryIntermediates</span><span class="token punctuation" data-v-6f1598ec>(</span>Input<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	
	<span class="token comment" data-v-6f1598ec>/* InstanceCullingData を Off にしていると、以下のフラグが常に false になってしまい、マテリアルが要求しても WPO が評価されない */</span>
	<span class="token comment" data-v-6f1598ec>/* このフラグが true でも、マテリアルが要求していない場合は WPO は評価されないので負荷の心配は不要 */</span>
	VFIntermediates<span class="token punctuation" data-v-6f1598ec>.</span>bEvaluateWorldPositionOffset <span class="token operator" data-v-6f1598ec>=</span> <span class="token boolean" data-v-6f1598ec>true</span><span class="token punctuation" data-v-6f1598ec>;</span>
	
	<span class="token keyword" data-v-6f1598ec>const</span> <span class="token keyword" data-v-6f1598ec>float4</span> WorldPositionExcludingWPO <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>VertexFactoryGetWorldPosition</span><span class="token punctuation" data-v-6f1598ec>(</span>Input<span class="token punctuation" data-v-6f1598ec>,</span> VFIntermediates<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>float4</span> WorldPos <span class="token operator" data-v-6f1598ec>=</span> WorldPositionExcludingWPO<span class="token punctuation" data-v-6f1598ec>;</span>
	
	<span class="token keyword" data-v-6f1598ec>const</span> <span class="token keyword" data-v-6f1598ec>float3x3</span> TangentToLocal <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>VertexFactoryGetTangentToLocal</span><span class="token punctuation" data-v-6f1598ec>(</span>Input<span class="token punctuation" data-v-6f1598ec>,</span> VFIntermediates<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* マテリアルが生成した VertexShader 用のコードを呼び出し、結果を取得 */</span>
	FMaterialVertexParameters VertexParameters <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialVertexParameters</span><span class="token punctuation" data-v-6f1598ec>(</span>Input<span class="token punctuation" data-v-6f1598ec>,</span> VFIntermediates<span class="token punctuation" data-v-6f1598ec>,</span> WorldPos<span class="token punctuation" data-v-6f1598ec>.</span>xyz<span class="token punctuation" data-v-6f1598ec>,</span> TangentToLocal<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* マテリアルが生成した WorldPositionOffset を適用 */</span>
	WorldPos<span class="token punctuation" data-v-6f1598ec>.</span>xyz <span class="token operator" data-v-6f1598ec>+=</span> <span class="token function" data-v-6f1598ec>GetMaterialWorldPositionOffset</span><span class="token punctuation" data-v-6f1598ec>(</span>VertexParameters<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* PixelShader に渡すデータを設定 */</span>
	Output<span class="token punctuation" data-v-6f1598ec>.</span>Position <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>INVARIANT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token function" data-v-6f1598ec>mul</span><span class="token punctuation" data-v-6f1598ec>(</span>WorldPos<span class="token punctuation" data-v-6f1598ec>,</span> ResolvedView<span class="token punctuation" data-v-6f1598ec>.</span>TranslatedWorldToClip<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	Output<span class="token punctuation" data-v-6f1598ec>.</span>PixelPosition <span class="token operator" data-v-6f1598ec>=</span> WorldPos<span class="token punctuation" data-v-6f1598ec>;</span>
	Output<span class="token punctuation" data-v-6f1598ec>.</span>FactoryInterpolants <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>VertexFactoryGetInterpolantsVSToPS</span><span class="token punctuation" data-v-6f1598ec>(</span>Input<span class="token punctuation" data-v-6f1598ec>,</span> VFIntermediates<span class="token punctuation" data-v-6f1598ec>,</span> VertexParameters<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<p data-v-6f1598ec>このシェーダーは、UE の標準頂点シェーダーを簡略化したような実装になっています。 重要なのは、 <code data-v-6f1598ec>GetMaterialVertexParameters</code> や <code data-v-6f1598ec>GetMaterialWorldPositionOffset</code> などの関数呼び出しです。これらは、マテリアルが生成したシェーダーコードを呼び出し、その結果を取得するための関数です。
どのマテリアルと組み合わせてコンパイルされるかの制御は C++ 側で行われるので、シェーダー側では <code data-v-6f1598ec>/Engine/Generated/Material.ush</code> などのヘッダーファイルをインクルードすることで、任意のマテリアルと組み合わせたときのシェーダーコードを取得することができます。</p>
<p data-v-6f1598ec>有り体に言えば、 <code data-v-6f1598ec>GetMaterialWorldPositionOffset</code> の値はマテリアルグラフで <code data-v-6f1598ec>WorldPositionOffset</code> に繋いだワイヤーの値がそのまま出てくるということです。</p>
<p data-v-6f1598ec>また、 GPUScene を有効にしているにもかかわらず InstanceCulling 機能を Off にしていると、 Primitive の InstanceCulling フラグが常に 0 になってしまい、マテリアルが要求しても WorldPositionOffset が評価されないという問題があります。
このため、シェーダー側で bEvaluateWorldPositionOffset を強制的に true にしています。ただし、マテリアルが要求していない場合は WPO は評価されないため、負荷の心配は不要です。</p>
<h3 id="独自メッシュ描画パス処理のピクセルシェーダー実装" data-v-6f1598ec><a href="#%E7%8B%AC%E8%87%AA%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E6%8F%8F%E7%94%BB%E3%83%91%E3%82%B9%E5%87%A6%E7%90%86%E3%81%AE%E3%83%94%E3%82%AF%E3%82%BB%E3%83%AB%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E5%AE%9F%E8%A3%85" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>独自メッシュ描画パス処理のピクセルシェーダー実装</h3>
<p data-v-6f1598ec>続いて、ピクセルシェーダーの実装です。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-hlsl" data-v-6f1598ec><code class="language-hlsl" data-v-6f1598ec><span class="token macro property" data-v-6f1598ec><span class="token directive-hash" data-v-6f1598ec>#</span><span class="token keyword directive" data-v-6f1598ec>define</span> <span class="token macro-name" data-v-6f1598ec>SUPPORT_CONTACT_SHADOWS</span> <span class="token expression" data-v-6f1598ec><span class="token number" data-v-6f1598ec>0</span></span></span>

<span class="token macro property" data-v-6f1598ec><span class="token directive-hash" data-v-6f1598ec>#</span><span class="token keyword directive" data-v-6f1598ec>include</span> <span class="token string" data-v-6f1598ec>"/Engine/Private/BasePassCommon.ush"</span></span>
<span class="token macro property" data-v-6f1598ec><span class="token directive-hash" data-v-6f1598ec>#</span><span class="token keyword directive" data-v-6f1598ec>include</span> <span class="token string" data-v-6f1598ec>"/Engine/Generated/Material.ush"</span></span>
<span class="token macro property" data-v-6f1598ec><span class="token directive-hash" data-v-6f1598ec>#</span><span class="token keyword directive" data-v-6f1598ec>include</span> <span class="token string" data-v-6f1598ec>"/Engine/Private/ShadingModelsMaterial.ush"</span></span>
<span class="token macro property" data-v-6f1598ec><span class="token directive-hash" data-v-6f1598ec>#</span><span class="token keyword directive" data-v-6f1598ec>include</span> <span class="token string" data-v-6f1598ec>"/Engine/Generated/VertexFactory.ush"</span></span>
<span class="token macro property" data-v-6f1598ec><span class="token directive-hash" data-v-6f1598ec>#</span><span class="token keyword directive" data-v-6f1598ec>include</span> <span class="token string" data-v-6f1598ec>"/Engine/Private/DeferredLightingCommon.ush"</span></span>

<span class="token comment" data-v-6f1598ec>/* Pixel Shader */</span>
<span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>MainPS</span><span class="token punctuation" data-v-6f1598ec>(</span>
	<span class="token keyword" data-v-6f1598ec>in</span> FTinyRendererVSToPS Interpolants<span class="token punctuation" data-v-6f1598ec>,</span>
	<span class="token keyword" data-v-6f1598ec>out</span> <span class="token keyword" data-v-6f1598ec>float4</span> OutColor <span class="token operator" data-v-6f1598ec>:</span> SV_Target0
	OPTIONAL_IsFrontFace<span class="token punctuation" data-v-6f1598ec>)</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	ResolvedView <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>ResolveView</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token keyword" data-v-6f1598ec>float3</span> WorldPosition <span class="token operator" data-v-6f1598ec>=</span> Interpolants<span class="token punctuation" data-v-6f1598ec>.</span>PixelPosition<span class="token punctuation" data-v-6f1598ec>.</span>xyz<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* マテリアルが生成した PixelShader 用のコードを呼び出し、結果を取得 */</span>
	FMaterialPixelParameters MaterialParameters <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialPixelParameters</span><span class="token punctuation" data-v-6f1598ec>(</span>
		Interpolants<span class="token punctuation" data-v-6f1598ec>.</span>FactoryInterpolants<span class="token punctuation" data-v-6f1598ec>,</span> Interpolants<span class="token punctuation" data-v-6f1598ec>.</span>Position<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	FPixelMaterialInputs PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>/* スクリーン座標系の位置を取得 */</span>
		<span class="token keyword" data-v-6f1598ec>float4</span> ScreenPosition <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>SvPositionToResolvedScreenPosition</span><span class="token punctuation" data-v-6f1598ec>(</span>Interpolants<span class="token punctuation" data-v-6f1598ec>.</span>Position<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token comment" data-v-6f1598ec>/* マテリアルから更に追加のパラメータを取得 */</span>
		<span class="token function" data-v-6f1598ec>CalcMaterialParametersEx</span><span class="token punctuation" data-v-6f1598ec>(</span>MaterialParameters<span class="token punctuation" data-v-6f1598ec>,</span> PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>,</span> Interpolants<span class="token punctuation" data-v-6f1598ec>.</span>Position<span class="token punctuation" data-v-6f1598ec>,</span> ScreenPosition<span class="token punctuation" data-v-6f1598ec>,</span> bIsFrontFace<span class="token punctuation" data-v-6f1598ec>,</span>
		                         WorldPosition<span class="token punctuation" data-v-6f1598ec>,</span> WorldPosition<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>/* マテリアルの各種出力を取得 */</span>
	<span class="token function" data-v-6f1598ec>GetMaterialCoverageAndClipping</span><span class="token punctuation" data-v-6f1598ec>(</span>MaterialParameters<span class="token punctuation" data-v-6f1598ec>,</span> PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>half</span> Opacity <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialOpacity</span><span class="token punctuation" data-v-6f1598ec>(</span>PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>half3</span> BaseColor <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialBaseColor</span><span class="token punctuation" data-v-6f1598ec>(</span>PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>half</span> Metallic <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialMetallic</span><span class="token punctuation" data-v-6f1598ec>(</span>PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>half</span> Specular <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialSpecular</span><span class="token punctuation" data-v-6f1598ec>(</span>PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>half</span> Roughness <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>max</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token number" data-v-6f1598ec>0.015625f</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token function" data-v-6f1598ec>GetMaterialRoughness</span><span class="token punctuation" data-v-6f1598ec>(</span>PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>float</span> Anisotropy <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialAnisotropy</span><span class="token punctuation" data-v-6f1598ec>(</span>PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>uint</span> ShadingModelID <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialShadingModel</span><span class="token punctuation" data-v-6f1598ec>(</span>PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* GBuffer (という名前の構造体) にマテリアルの各種出力を設定。テクスチャリソースとしての GBuffer はここでは使われていないので注意 */</span>
	FGBufferData GBuffer <span class="token operator" data-v-6f1598ec>=</span> <span class="token punctuation" data-v-6f1598ec>(</span>FGBufferData<span class="token punctuation" data-v-6f1598ec>)</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>;</span>
	GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>Depth <span class="token operator" data-v-6f1598ec>=</span> MaterialParameters<span class="token punctuation" data-v-6f1598ec>.</span>ScreenPosition<span class="token punctuation" data-v-6f1598ec>.</span>w<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token function" data-v-6f1598ec>SetGBufferForShadingModel</span><span class="token punctuation" data-v-6f1598ec>(</span>
		GBuffer<span class="token punctuation" data-v-6f1598ec>,</span>
		MaterialParameters<span class="token punctuation" data-v-6f1598ec>,</span>
		Opacity<span class="token punctuation" data-v-6f1598ec>,</span>
		BaseColor<span class="token punctuation" data-v-6f1598ec>,</span>
		Metallic<span class="token punctuation" data-v-6f1598ec>,</span>
		Specular<span class="token punctuation" data-v-6f1598ec>,</span>
		Roughness<span class="token punctuation" data-v-6f1598ec>,</span>
		Anisotropy<span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token number" data-v-6f1598ec>0.0f</span><span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token number" data-v-6f1598ec>0.0f</span><span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token number" data-v-6f1598ec>0.0f</span><span class="token punctuation" data-v-6f1598ec>,</span>
		ShadingModelID<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* スペキュラカラーやディフューズカラーを計算 */</span>
	GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>SpecularColor <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>ComputeF0</span><span class="token punctuation" data-v-6f1598ec>(</span>GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>Specular<span class="token punctuation" data-v-6f1598ec>,</span> GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>BaseColor<span class="token punctuation" data-v-6f1598ec>,</span> GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>Metallic<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>DiffuseColor <span class="token operator" data-v-6f1598ec>=</span> GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>BaseColor <span class="token operator" data-v-6f1598ec>-</span> GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>BaseColor <span class="token operator" data-v-6f1598ec>*</span> GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>Metallic<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>DiffuseColor <span class="token operator" data-v-6f1598ec>=</span> GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>DiffuseColor <span class="token operator" data-v-6f1598ec>*</span> ResolvedView<span class="token punctuation" data-v-6f1598ec>.</span>DiffuseOverrideParameter<span class="token punctuation" data-v-6f1598ec>.</span>w <span class="token operator" data-v-6f1598ec>+</span> ResolvedView<span class="token punctuation" data-v-6f1598ec>.</span>
			DiffuseOverrideParameter<span class="token punctuation" data-v-6f1598ec>.</span>xyz<span class="token punctuation" data-v-6f1598ec>;</span>
		GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>SpecularColor <span class="token operator" data-v-6f1598ec>=</span> GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>SpecularColor <span class="token operator" data-v-6f1598ec>*</span> ResolvedView<span class="token punctuation" data-v-6f1598ec>.</span>SpecularOverrideParameter<span class="token punctuation" data-v-6f1598ec>.</span>w <span class="token operator" data-v-6f1598ec>+</span> ResolvedView<span class="token punctuation" data-v-6f1598ec>.</span>
			SpecularOverrideParameter<span class="token punctuation" data-v-6f1598ec>.</span>xyz<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>
	<span class="token keyword" data-v-6f1598ec>half3</span> DiffuseColor <span class="token operator" data-v-6f1598ec>=</span> GBuffer<span class="token punctuation" data-v-6f1598ec>.</span>DiffuseColor <span class="token operator" data-v-6f1598ec>*</span> <span class="token number" data-v-6f1598ec>0.05f</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token keyword" data-v-6f1598ec>half3</span> CameraVector <span class="token operator" data-v-6f1598ec>=</span> <span class="token operator" data-v-6f1598ec>-</span>MaterialParameters<span class="token punctuation" data-v-6f1598ec>.</span>CameraVector<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>float</span> DirectionalLightShadow <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>1.0f</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* Directional Light の設定 */</span>
	FDeferredLightData LightData <span class="token operator" data-v-6f1598ec>=</span> <span class="token punctuation" data-v-6f1598ec>(</span>FDeferredLightData<span class="token punctuation" data-v-6f1598ec>)</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		LightData<span class="token punctuation" data-v-6f1598ec>.</span>Color <span class="token operator" data-v-6f1598ec>=</span> <span class="token keyword" data-v-6f1598ec>float3</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		LightData<span class="token punctuation" data-v-6f1598ec>.</span>FalloffExponent <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>;</span>
		LightData<span class="token punctuation" data-v-6f1598ec>.</span>Direction <span class="token operator" data-v-6f1598ec>=</span> <span class="token keyword" data-v-6f1598ec>float3</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token operator" data-v-6f1598ec>-</span><span class="token number" data-v-6f1598ec>0.5</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token operator" data-v-6f1598ec>-</span><span class="token number" data-v-6f1598ec>0.5</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0.5</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		LightData<span class="token punctuation" data-v-6f1598ec>.</span>bRadialLight <span class="token operator" data-v-6f1598ec>=</span> <span class="token boolean" data-v-6f1598ec>false</span><span class="token punctuation" data-v-6f1598ec>;</span>
		LightData<span class="token punctuation" data-v-6f1598ec>.</span>SpecularScale <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>1.0f</span><span class="token punctuation" data-v-6f1598ec>;</span>
		LightData<span class="token punctuation" data-v-6f1598ec>.</span>ShadowedBits <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>;</span>
		LightData<span class="token punctuation" data-v-6f1598ec>.</span>HairTransmittance <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>InitHairTransmittanceData</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>
	<span class="token keyword" data-v-6f1598ec>half4</span> LightAttenuation <span class="token operator" data-v-6f1598ec>=</span> <span class="token number" data-v-6f1598ec>1.0f</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token comment" data-v-6f1598ec>/* ライティングを計算 */</span>
	FLightAccumulator DirectionalLighting <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>AccumulateDynamicLighting</span><span class="token punctuation" data-v-6f1598ec>(</span>WorldPosition<span class="token punctuation" data-v-6f1598ec>,</span> CameraVector<span class="token punctuation" data-v-6f1598ec>,</span> GBuffer<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                          <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>,</span> ShadingModelID<span class="token punctuation" data-v-6f1598ec>,</span> LightData<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                          LightAttenuation<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>uint2</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span>
	                                                          DirectionalLightShadow<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token keyword" data-v-6f1598ec>half3</span> Color <span class="token operator" data-v-6f1598ec>=</span> DirectionalLighting<span class="token punctuation" data-v-6f1598ec>.</span>TotalLight<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* 最後にエミッシブカラーを加算 */</span>
	<span class="token keyword" data-v-6f1598ec>half3</span> Emissive <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>GetMaterialEmissive</span><span class="token punctuation" data-v-6f1598ec>(</span>PixelMaterialInputs<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	Color <span class="token operator" data-v-6f1598ec>+=</span> Emissive<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* 最終的な色を出力 */</span>
	OutColor <span class="token operator" data-v-6f1598ec>=</span> <span class="token keyword" data-v-6f1598ec>float4</span><span class="token punctuation" data-v-6f1598ec>(</span>Color<span class="token punctuation" data-v-6f1598ec>.</span>rgb<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>1.0f</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<p data-v-6f1598ec>このピクセルシェーダーは、UE のモバイル向け BasePass を参考に、固定された DirectionalLight による照明のみを行うようにしたシンプルなものです。単一メッシュであるため、反射や GI などの機能も無視することができます。
エンジンのために便利なユーティリティが多数用意されているため、照明計算やマテリアルのパラメータ取得なども比較的簡単に行うことができます。シェーディングモデルなども流用可能です。また、そのようにすることで、UE の標準レンダリング機能と近い見た目を提供することができます。</p>
<p data-v-6f1598ec><code data-v-6f1598ec>GetMaterialPixelParameters</code> は、頂点シェーダーで取得した情報をもとに、マテリアルが生成したピクセルシェーダー用のコードを呼び出し、その結果を取得するための関数です。これにより、マテリアルのピクセルシェーダー向け出力を取得することができます。
ほかにもいくつかマテリアルからの出力を取得して利用しています。</p>
<h3 id="シェーダーの登録と-rdg-によるパラメータ定義" data-v-6f1598ec><a href="#%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AE%E7%99%BB%E9%8C%B2%E3%81%A8-rdg-%E3%81%AB%E3%82%88%E3%82%8B%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E5%AE%9A%E7%BE%A9" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>シェーダーの登録と RDG によるパラメータ定義</h3>
<p data-v-6f1598ec>作成したシェーダーの C++ 定義と USF 実装を関連付けて登録します。また、シェーダーが利用するパラメータ構造体を RDG が提供するマクロを使って定義します。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token comment" data-v-6f1598ec>/* TinyRenderer の頂点シェーダーとピクセルシェーダーの実装 (.usf ファイル) と C++ 定義を関連付けて登録 */</span>
<span class="token function" data-v-6f1598ec>IMPLEMENT_MATERIAL_SHADER_TYPE</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>,</span> FTinyRendererShaderVS<span class="token punctuation" data-v-6f1598ec>,</span>
                                 <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"/StaticMeshRenderer/Private/TinyRendererShader.usf"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span>
                                 <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"MainVS"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> SF_Vertex<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token function" data-v-6f1598ec>IMPLEMENT_MATERIAL_SHADER_TYPE</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>,</span> FTinyRendererShaderPS<span class="token punctuation" data-v-6f1598ec>,</span>
                                 <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"/StaticMeshRenderer/Private/TinyRendererShader.usf"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span>
                                 <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"MainPS"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> SF_Pixel<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

<span class="token comment" data-v-6f1598ec>/* TinyRenderer のシェーダーが利用するパラメータ構造体を定義 */</span>
<span class="token function" data-v-6f1598ec>BEGIN_SHADER_PARAMETER_STRUCT</span><span class="token punctuation" data-v-6f1598ec>(</span>FTinyRendererShaderParameters<span class="token punctuation" data-v-6f1598ec>,</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token function" data-v-6f1598ec>SHADER_PARAMETER_STRUCT_REF</span><span class="token punctuation" data-v-6f1598ec>(</span>FViewUniformShaderParameters<span class="token punctuation" data-v-6f1598ec>,</span> View<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token function" data-v-6f1598ec>SHADER_PARAMETER_RDG_UNIFORM_BUFFER</span><span class="token punctuation" data-v-6f1598ec>(</span>FSceneUniformParameters<span class="token punctuation" data-v-6f1598ec>,</span> Scene<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token function" data-v-6f1598ec>SHADER_PARAMETER_STRUCT_INCLUDE</span><span class="token punctuation" data-v-6f1598ec>(</span>FInstanceCullingDrawParams<span class="token punctuation" data-v-6f1598ec>,</span> InstanceCullingDrawParams<span class="token punctuation" data-v-6f1598ec>)</span>

	<span class="token function" data-v-6f1598ec>RENDER_TARGET_BINDING_SLOTS</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span>
<span class="token function" data-v-6f1598ec>END_SHADER_PARAMETER_STRUCT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span>
</code></pre></div>
<p data-v-6f1598ec>これにより、C++ の定義クラスと USF の実装が関連付けられるため、 C++ 定義クラスを使ってシェーダーを指定したり、 RDG のパラメータ構造体を使ってシェーダーにパラメータを渡すことができるようになります。
特に RDG のマクロによるパラメータ定義は便利です。主機能としては C++ 構造体を定義するマクロなのですが、同時にパラメータの名前やシェーダー側での参照名などのメタデータを定義してくれます。
手動でシェーダーへのパラメータのバインディングを書かなくても、RDG パスへパラメータ構造体として渡すだけで、名前や型をもとにバインディングやライフタイム管理を行ってくれます。</p>
<p data-v-6f1598ec>上で一度みたコードですが、パラメータ構造体を RDG のパスにわたしている部分のコードを再度見てみます。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token comment" data-v-6f1598ec>// パラメータ構造体の確保を行う</span>
FTinyRendererShaderParameters<span class="token operator" data-v-6f1598ec>*</span> PassParameters <span class="token operator" data-v-6f1598ec>=</span> GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token generic-function" data-v-6f1598ec><span class="token function" data-v-6f1598ec>AllocParameters</span><span class="token class-name generic" data-v-6f1598ec><span class="token operator" data-v-6f1598ec>&lt;</span>FTinyRendererShaderParameters<span class="token operator" data-v-6f1598ec>></span></span></span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token comment" data-v-6f1598ec>// パラメータ構造体にパラメータをセット</span>
PassParameters<span class="token operator" data-v-6f1598ec>-></span>View <span class="token operator" data-v-6f1598ec>=</span> View<span class="token operator" data-v-6f1598ec>-></span>ViewUniformBuffer<span class="token punctuation" data-v-6f1598ec>;</span>
PassParameters<span class="token operator" data-v-6f1598ec>-></span>Scene <span class="token operator" data-v-6f1598ec>=</span> SceneUniforms<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>GetBuffer</span><span class="token punctuation" data-v-6f1598ec>(</span>GraphBuilder<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token comment" data-v-6f1598ec>// RenderTargets は RENDER_TARGET_BINDING_SLOTS マクロで定義されたスロットを指している。</span>
PassParameters<span class="token operator" data-v-6f1598ec>-></span>RenderTargets<span class="token punctuation" data-v-6f1598ec>[</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>]</span> <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>FRenderTargetBinding</span><span class="token punctuation" data-v-6f1598ec>(</span>SceneTextures<span class="token punctuation" data-v-6f1598ec>.</span>SceneColorTexture<span class="token punctuation" data-v-6f1598ec>,</span>
														ERenderTargetLoadAction<span class="token punctuation double-colon" data-v-6f1598ec>::</span>EClear<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
PassParameters<span class="token operator" data-v-6f1598ec>-></span>RenderTargets<span class="token punctuation" data-v-6f1598ec>.</span>DepthStencil <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>FDepthStencilBinding</span><span class="token punctuation" data-v-6f1598ec>(</span>SceneTextures<span class="token punctuation" data-v-6f1598ec>.</span>SceneDepthTexture<span class="token punctuation" data-v-6f1598ec>,</span>
																	ERenderTargetLoadAction<span class="token punctuation double-colon" data-v-6f1598ec>::</span>EClear<span class="token punctuation" data-v-6f1598ec>,</span>
																	ERenderTargetLoadAction<span class="token punctuation double-colon" data-v-6f1598ec>::</span>ELoad<span class="token punctuation" data-v-6f1598ec>,</span>
																	FExclusiveDepthStencil<span class="token punctuation double-colon" data-v-6f1598ec>::</span>DepthWrite_StencilWrite<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token comment" data-v-6f1598ec>// パラメータ構造体 (PassParameters) を RDG のパスに渡す。これだけで RDG がシェーダーへのパラメータのバインディングやライフタイム管理を行ってくれる</span>
<span class="token function" data-v-6f1598ec>AddSimpleMeshPass</span><span class="token punctuation" data-v-6f1598ec>(</span>
	GraphBuilder<span class="token punctuation" data-v-6f1598ec>,</span> PassParameters<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token operator" data-v-6f1598ec>*</span>View<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>,</span>
	<span class="token function" data-v-6f1598ec>RDG_EVENT_NAME</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"TinyRendererBasePass"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span>
	View<span class="token operator" data-v-6f1598ec>-></span>UnscaledViewRect<span class="token punctuation" data-v-6f1598ec>,</span> ERDGPassFlags<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Raster<span class="token punctuation" data-v-6f1598ec>,</span>
	<span class="token punctuation" data-v-6f1598ec>[</span>View<span class="token punctuation" data-v-6f1598ec>,</span> MeshBatches<span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>(</span>FDynamicPassMeshDrawListContext<span class="token operator" data-v-6f1598ec>*</span> DynamicMeshPassContext<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>// 省略。パスの実装</span>
	<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
</code></pre></div>
<p data-v-6f1598ec>特にリソース管理を人間が書かなくていいのは大きな利点と言えるでしょう。 注意点として、RDG が管理しているリソース(特に ~Ref みたいな型のリソース)はパスの外側ではまだ確保されていないことが普通です。そのため、リソースの実体にアクセスするためには AddPass や AddSimpleMeshPass などのパス実装の中で行う必要があります。
RDG はパスとそれが必要とするリソースを紐づけて管理することで、リソースを最適化するため、。</p>
<p data-v-6f1598ec>つまり、RDG で定義したパラメータ構造体を RDG パスに渡すというのは、構造体に含まれるリソースをメタデータをもとに列挙させ、必要に応じてリソースを確保・解放してもらうということになります。</p>
<h2 id="meshbatch-の描画命令を発行する-meshpassprocessor" data-v-6f1598ec><a href="#meshbatch-%E3%81%AE%E6%8F%8F%E7%94%BB%E5%91%BD%E4%BB%A4%E3%82%92%E7%99%BA%E8%A1%8C%E3%81%99%E3%82%8B-meshpassprocessor" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>MeshBatch の描画命令を発行する MeshPassProcessor</h2>
<p data-v-6f1598ec>さて、CPU 側でのメッシュの準備と、GPU 側でそれを処理するシェーダーが準備できたので、それらを使って描画パスを発行する MeshPassProcessor を作成します。</p>
<h3 id="ftinyrendererbasepassmeshprocessor" data-v-6f1598ec><a href="#ftinyrendererbasepassmeshprocessor" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>FTinyRendererBasePassMeshProcessor</h3>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>class</span> <span class="token class-name" data-v-6f1598ec>FTinyRendererBasePassMeshProcessor</span> <span class="token operator" data-v-6f1598ec>:</span> <span class="token base-clause" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>public</span> <span class="token class-name" data-v-6f1598ec>FMeshPassProcessor</span></span>
<span class="token punctuation" data-v-6f1598ec>{</span>
<span class="token keyword" data-v-6f1598ec>public</span><span class="token operator" data-v-6f1598ec>:</span>
	<span class="token function" data-v-6f1598ec>FTinyRendererBasePassMeshProcessor</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FSceneView<span class="token operator" data-v-6f1598ec>*</span> InView<span class="token punctuation" data-v-6f1598ec>,</span>
	                                   FMeshPassDrawListContext<span class="token operator" data-v-6f1598ec>*</span> InDrawListContext<span class="token punctuation" data-v-6f1598ec>)</span>
		<span class="token operator" data-v-6f1598ec>:</span> <span class="token function" data-v-6f1598ec>FMeshPassProcessor</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>,</span> InView<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetFeatureLevel</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> InView<span class="token punctuation" data-v-6f1598ec>,</span> InDrawListContext<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span>
		  <span class="token function" data-v-6f1598ec>FeatureLevel</span><span class="token punctuation" data-v-6f1598ec>(</span>InView<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetFeatureLevel</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>/* メッシュ描画時の RenderState を設定。パイプラインの挙動を制御することになる */</span>
		PassDrawRenderState<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetBlendState</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token class-name" data-v-6f1598ec>TStaticBlendState</span><span class="token operator" data-v-6f1598ec>&lt;</span><span class="token operator" data-v-6f1598ec>></span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>GetRHI</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		PassDrawRenderState<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetDepthStencilAccess</span><span class="token punctuation" data-v-6f1598ec>(</span>FExclusiveDepthStencil<span class="token punctuation double-colon" data-v-6f1598ec>::</span>DepthWrite_StencilWrite<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		PassDrawRenderState<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetDepthStencilState</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token class-name" data-v-6f1598ec>TStaticDepthStencilState</span><span class="token operator" data-v-6f1598ec>&lt;</span><span class="token operator" data-v-6f1598ec>></span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>GetRHI</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>/* この MeshPassProcessor を通じて指定された MeshBatch のメッシュ描画コマンドをコマンドリストに追加する処理 */</span>
	<span class="token keyword" data-v-6f1598ec>bool</span> <span class="token function" data-v-6f1598ec>TryAddMeshBatch</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMeshBatch<span class="token operator" data-v-6f1598ec>&</span> MeshBatch<span class="token punctuation" data-v-6f1598ec>,</span>
	                     <span class="token keyword" data-v-6f1598ec>const</span> uint64 BatchElementMask<span class="token punctuation" data-v-6f1598ec>,</span>
	                     <span class="token keyword" data-v-6f1598ec>const</span> FPrimitiveSceneProxy<span class="token operator" data-v-6f1598ec>*</span> PrimitiveSceneProxy<span class="token punctuation" data-v-6f1598ec>,</span>
	                     <span class="token keyword" data-v-6f1598ec>const</span> FMaterial<span class="token operator" data-v-6f1598ec>&</span> MaterialResource<span class="token punctuation" data-v-6f1598ec>,</span>
	                     <span class="token keyword" data-v-6f1598ec>const</span> FMaterialRenderProxy<span class="token operator" data-v-6f1598ec>&</span> MaterialRenderProxy<span class="token punctuation" data-v-6f1598ec>,</span>
	                     <span class="token keyword" data-v-6f1598ec>const</span> int32 StaticMeshId<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token comment" data-v-6f1598ec>/* MeshBatch が利用する VertexFactory を取得 */</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FVertexFactory<span class="token operator" data-v-6f1598ec>*</span> VertexFactory <span class="token operator" data-v-6f1598ec>=</span> MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>VertexFactory<span class="token punctuation" data-v-6f1598ec>;</span>
		TMeshProcessorShaders<span class="token operator" data-v-6f1598ec>&lt;</span>FTinyRendererShaderVS<span class="token punctuation" data-v-6f1598ec>,</span> FTinyRendererShaderPS<span class="token operator" data-v-6f1598ec>></span> TinyRenderPassShaders<span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>/* MeshBatch が利用する ShaderType を登録 */</span>
		FMaterialShaderTypes ShaderTypes<span class="token punctuation" data-v-6f1598ec>;</span>
		ShaderTypes<span class="token punctuation" data-v-6f1598ec>.</span><span class="token generic-function" data-v-6f1598ec><span class="token function" data-v-6f1598ec>AddShaderType</span><span class="token class-name generic" data-v-6f1598ec><span class="token operator" data-v-6f1598ec>&lt;</span>FTinyRendererShaderVS<span class="token operator" data-v-6f1598ec>></span></span></span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		ShaderTypes<span class="token punctuation" data-v-6f1598ec>.</span><span class="token generic-function" data-v-6f1598ec><span class="token function" data-v-6f1598ec>AddShaderType</span><span class="token class-name generic" data-v-6f1598ec><span class="token operator" data-v-6f1598ec>&lt;</span>FTinyRendererShaderPS<span class="token operator" data-v-6f1598ec>></span></span></span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>/* 上で登録した ShaderType と MeshBatch に割り当てられたマテリアルをもとに、実際に利用するシェーダーコードたちを取得 */</span>
		FMaterialShaders Shaders<span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FVertexFactoryType<span class="token operator" data-v-6f1598ec>*</span> VertexFactoryType <span class="token operator" data-v-6f1598ec>=</span> VertexFactory<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetType</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
			<span class="token operator" data-v-6f1598ec>!</span>MaterialResource<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>TryGetShaders</span><span class="token punctuation" data-v-6f1598ec>(</span>ShaderTypes<span class="token punctuation" data-v-6f1598ec>,</span> VertexFactoryType<span class="token punctuation" data-v-6f1598ec>,</span> Shaders<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span>
		<span class="token punctuation" data-v-6f1598ec>{</span>
			<span class="token keyword" data-v-6f1598ec>return</span> <span class="token boolean" data-v-6f1598ec>false</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token punctuation" data-v-6f1598ec>}</span>

		<span class="token comment" data-v-6f1598ec>/* 頂点シェーダーとピクセルシェーダーを取得 */</span>
		Shaders<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>TryGetVertexShader</span><span class="token punctuation" data-v-6f1598ec>(</span>TinyRenderPassShaders<span class="token punctuation" data-v-6f1598ec>.</span>VertexShader<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		Shaders<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>TryGetPixelShader</span><span class="token punctuation" data-v-6f1598ec>(</span>TinyRenderPassShaders<span class="token punctuation" data-v-6f1598ec>.</span>PixelShader<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>/* メッシュ描画時の RenderState を設定 */</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FMeshPassProcessorRenderState <span class="token function" data-v-6f1598ec>DrawRenderState</span><span class="token punctuation" data-v-6f1598ec>(</span>PassDrawRenderState<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		FMeshMaterialShaderElementData ShaderElementData<span class="token punctuation" data-v-6f1598ec>;</span>
		ShaderElementData<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>InitializeMeshMaterialData</span><span class="token punctuation" data-v-6f1598ec>(</span>ViewIfDynamicMeshCommand<span class="token punctuation" data-v-6f1598ec>,</span> PrimitiveSceneProxy<span class="token punctuation" data-v-6f1598ec>,</span>
		                                             MeshBatch<span class="token punctuation" data-v-6f1598ec>,</span> StaticMeshId<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token boolean" data-v-6f1598ec>true</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token keyword" data-v-6f1598ec>const</span> FMeshDrawCommandSortKey SortKey <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>CalculateMeshStaticSortKey</span><span class="token punctuation" data-v-6f1598ec>(</span>
			TinyRenderPassShaders<span class="token punctuation" data-v-6f1598ec>.</span>VertexShader<span class="token punctuation" data-v-6f1598ec>,</span> TinyRenderPassShaders<span class="token punctuation" data-v-6f1598ec>.</span>PixelShader<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>/* ラスタライザの FillMode と CullMode を設定 */</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FMeshDrawingPolicyOverrideSettings OverrideSettings <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>ComputeMeshOverrideSettings</span><span class="token punctuation" data-v-6f1598ec>(</span>MeshBatch<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>const</span> ERasterizerFillMode MeshFillMode <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>ComputeMeshFillMode</span><span class="token punctuation" data-v-6f1598ec>(</span>MaterialResource<span class="token punctuation" data-v-6f1598ec>,</span> OverrideSettings<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>const</span> ERasterizerCullMode MeshCullMode <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>ComputeMeshCullMode</span><span class="token punctuation" data-v-6f1598ec>(</span>MaterialResource<span class="token punctuation" data-v-6f1598ec>,</span> OverrideSettings<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token comment" data-v-6f1598ec>/* MeshBatch に対応する描画コマンドを作成し、内部でコマンドリストに追加 */</span>
		<span class="token function" data-v-6f1598ec>BuildMeshDrawCommands</span><span class="token punctuation" data-v-6f1598ec>(</span>
			MeshBatch<span class="token punctuation" data-v-6f1598ec>,</span>
			BatchElementMask<span class="token punctuation" data-v-6f1598ec>,</span>
			PrimitiveSceneProxy<span class="token punctuation" data-v-6f1598ec>,</span>
			MaterialRenderProxy<span class="token punctuation" data-v-6f1598ec>,</span>
			MaterialResource<span class="token punctuation" data-v-6f1598ec>,</span>
			DrawRenderState<span class="token punctuation" data-v-6f1598ec>,</span>
			TinyRenderPassShaders<span class="token punctuation" data-v-6f1598ec>,</span>
			MeshFillMode<span class="token punctuation" data-v-6f1598ec>,</span>
			MeshCullMode<span class="token punctuation" data-v-6f1598ec>,</span>
			SortKey<span class="token punctuation" data-v-6f1598ec>,</span>
			EMeshPassFeatures<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Default<span class="token punctuation" data-v-6f1598ec>,</span>
			ShaderElementData<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>return</span> <span class="token boolean" data-v-6f1598ec>true</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token keyword" data-v-6f1598ec>virtual</span> <span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>AddMeshBatch</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMeshBatch<span class="token operator" data-v-6f1598ec>&</span> MeshBatch<span class="token punctuation" data-v-6f1598ec>,</span>
	                          <span class="token keyword" data-v-6f1598ec>const</span> uint64 BatchElementMask<span class="token punctuation" data-v-6f1598ec>,</span>
	                          <span class="token keyword" data-v-6f1598ec>const</span> FPrimitiveSceneProxy<span class="token operator" data-v-6f1598ec>*</span> PrimitiveSceneProxy<span class="token punctuation" data-v-6f1598ec>,</span>
	                          <span class="token keyword" data-v-6f1598ec>const</span> int32 StaticMeshId <span class="token operator" data-v-6f1598ec>=</span> <span class="token operator" data-v-6f1598ec>-</span><span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>)</span> <span class="token keyword" data-v-6f1598ec>override</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token keyword" data-v-6f1598ec>const</span> FMaterialRenderProxy<span class="token operator" data-v-6f1598ec>*</span> MaterialRenderProxy <span class="token operator" data-v-6f1598ec>=</span> MeshBatch<span class="token punctuation" data-v-6f1598ec>.</span>MaterialRenderProxy<span class="token punctuation" data-v-6f1598ec>;</span>

		<span class="token keyword" data-v-6f1598ec>while</span> <span class="token punctuation" data-v-6f1598ec>(</span>MaterialRenderProxy<span class="token punctuation" data-v-6f1598ec>)</span>
		<span class="token punctuation" data-v-6f1598ec>{</span>
			<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>const</span> FMaterial<span class="token operator" data-v-6f1598ec>*</span> MaterialResource <span class="token operator" data-v-6f1598ec>=</span> MaterialRenderProxy<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetMaterialNoFallback</span><span class="token punctuation" data-v-6f1598ec>(</span>FeatureLevel<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
				MaterialResource <span class="token operator" data-v-6f1598ec>&&</span> <span class="token function" data-v-6f1598ec>TryAddMeshBatch</span><span class="token punctuation" data-v-6f1598ec>(</span>MeshBatch<span class="token punctuation" data-v-6f1598ec>,</span> BatchElementMask<span class="token punctuation" data-v-6f1598ec>,</span> PrimitiveSceneProxy<span class="token punctuation" data-v-6f1598ec>,</span>
				                                    <span class="token operator" data-v-6f1598ec>*</span>MaterialResource<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token operator" data-v-6f1598ec>*</span>MaterialRenderProxy<span class="token punctuation" data-v-6f1598ec>,</span> StaticMeshId<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span>
			<span class="token punctuation" data-v-6f1598ec>{</span>
				<span class="token keyword" data-v-6f1598ec>break</span><span class="token punctuation" data-v-6f1598ec>;</span>
			<span class="token punctuation" data-v-6f1598ec>}</span>
			<span class="token comment" data-v-6f1598ec>/* 最初に取得したマテリアルが利用できなかったりコマンドの作成に失敗した場合は、Fallback のマテリアルを試す。</span>
<span class="token comment" data-v-6f1598ec>			   Fallback のマテリアルがない場合には nullptr が返るので、ループを抜ける */</span>
			MaterialRenderProxy <span class="token operator" data-v-6f1598ec>=</span> MaterialRenderProxy<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GetFallback</span><span class="token punctuation" data-v-6f1598ec>(</span>FeatureLevel<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token punctuation" data-v-6f1598ec>}</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

<span class="token keyword" data-v-6f1598ec>private</span><span class="token operator" data-v-6f1598ec>:</span>
	FMeshPassProcessorRenderState PassDrawRenderState<span class="token punctuation" data-v-6f1598ec>;</span>
	ERHIFeatureLevel<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Type FeatureLevel<span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>
</code></pre></div>
<p data-v-6f1598ec>MeshPassProcessor は、UE が提供する <code data-v-6f1598ec>FMeshPassProcessor</code> を継承して作成するもので、シェーダーとそのパラメータをもとにメッシュ描画コマンドを発行します。詳細は<a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-2/#%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>前回記事</a>および<a href="https://dev.epicgames.com/documentation/ja-jp/unreal-engine/mesh-drawing-pipeline-in-unreal-engine#fmeshpassprocessor" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>公式ドキュメント</a>を参考にしてください。
ここで発行されたメッシュ描画コマンドが、更に RHI コマンド、プラットフォーム API へと変換され GPU に送信されることで描画が行われます。</p>
<p data-v-6f1598ec><code data-v-6f1598ec>FMeshPassProcessor</code> には GPU のメッシュ描画バイプラインを設定するための便利な機能が多数用意されています。DepthStencil、BlendState、FillMode、CullMode などの設定を行うことで、描画の挙動を制御することができます。
また、上記の実装では、USF によるシェーダー実装とマテリアルをあわせて利用する方法も示されています。</p>
<h1 id="bp-ラッパーの作成" data-v-6f1598ec><a href="#bp-%E3%83%A9%E3%83%83%E3%83%91%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>BP ラッパーの作成</h1>
<p data-v-6f1598ec>作成したレンダラを BP から利用するためのラッパーを作成します。
基本的には単なる BP 向けクラスなのですべては解説しませんが、特に参考になりそうな部分のみ解説します。</p>
<h2 id="api-の定義" data-v-6f1598ec><a href="#api-%E3%81%AE%E5%AE%9A%E7%BE%A9" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>API の定義</h2>
<p data-v-6f1598ec>以下のような単純な API の BP クラスを作成しました。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token function" data-v-6f1598ec>UCLASS</span><span class="token punctuation" data-v-6f1598ec>(</span>BlueprintType<span class="token punctuation" data-v-6f1598ec>)</span>
<span class="token keyword" data-v-6f1598ec>class</span> <span class="token class-name" data-v-6f1598ec>STATICMESHRENDERER_API</span> UTinyRenderer <span class="token operator" data-v-6f1598ec>:</span> <span class="token keyword" data-v-6f1598ec>public</span> UObject
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token function" data-v-6f1598ec>GENERATED_BODY</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span>

<span class="token keyword" data-v-6f1598ec>public</span><span class="token operator" data-v-6f1598ec>:</span>
	<span class="token function" data-v-6f1598ec>UTinyRenderer</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* レンダーターゲットを指定して TinyRenderer を作成 */</span>
	<span class="token function" data-v-6f1598ec>UFUNCTION</span><span class="token punctuation" data-v-6f1598ec>(</span>BlueprintCallable<span class="token punctuation" data-v-6f1598ec>,</span> Category <span class="token operator" data-v-6f1598ec>=</span> <span class="token string" data-v-6f1598ec>"Tiny Renderer"</span><span class="token punctuation" data-v-6f1598ec>,</span>
		meta <span class="token operator" data-v-6f1598ec>=</span> <span class="token punctuation" data-v-6f1598ec>(</span>AutoCreateRefTerm <span class="token operator" data-v-6f1598ec>=</span> <span class="token string" data-v-6f1598ec>"BackgroundColor"</span><span class="token punctuation" data-v-6f1598ec>,</span> WorldContext <span class="token operator" data-v-6f1598ec>=</span> <span class="token string" data-v-6f1598ec>"WorldContextObject"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token keyword" data-v-6f1598ec>static</span> UTinyRenderer<span class="token operator" data-v-6f1598ec>*</span> <span class="token function" data-v-6f1598ec>CreateTinyRenderer</span><span class="token punctuation" data-v-6f1598ec>(</span>UObject<span class="token operator" data-v-6f1598ec>*</span> WorldContextObject<span class="token punctuation" data-v-6f1598ec>,</span>
	                                         UTextureRenderTarget2D<span class="token operator" data-v-6f1598ec>*</span> RenderTarget<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* 描画する StaticMesh をセット */</span>
	<span class="token function" data-v-6f1598ec>UFUNCTION</span><span class="token punctuation" data-v-6f1598ec>(</span>BlueprintCallable<span class="token punctuation" data-v-6f1598ec>,</span> Category <span class="token operator" data-v-6f1598ec>=</span> <span class="token string" data-v-6f1598ec>"Static Mesh Renderer"</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>SetStaticMesh</span><span class="token punctuation" data-v-6f1598ec>(</span>UStaticMesh<span class="token operator" data-v-6f1598ec>*</span> InStaticMesh<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>const</span> int32 LODIndex<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>const</span> FTransform<span class="token operator" data-v-6f1598ec>&</span> InTransform<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* 描画を行う */</span>
	<span class="token function" data-v-6f1598ec>UFUNCTION</span><span class="token punctuation" data-v-6f1598ec>(</span>BlueprintCallable<span class="token punctuation" data-v-6f1598ec>,</span> Category <span class="token operator" data-v-6f1598ec>=</span> <span class="token string" data-v-6f1598ec>"Static Mesh Renderer"</span><span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token keyword" data-v-6f1598ec>void</span> <span class="token function" data-v-6f1598ec>Render</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* カメラの設定 */</span>
	<span class="token function" data-v-6f1598ec>UPROPERTY</span><span class="token punctuation" data-v-6f1598ec>(</span>BlueprintReadWrite<span class="token punctuation" data-v-6f1598ec>,</span> Category <span class="token operator" data-v-6f1598ec>=</span> <span class="token string" data-v-6f1598ec>"Static Mesh Renderer"</span><span class="token punctuation" data-v-6f1598ec>)</span>
	FMinimalViewInfo ViewInfo<span class="token punctuation" data-v-6f1598ec>;</span>

<span class="token keyword" data-v-6f1598ec>private</span><span class="token operator" data-v-6f1598ec>:</span>
	<span class="token comment" data-v-6f1598ec>// 省略</span>
<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>;</span>
</code></pre></div>
<h2 id="カメラ設定-fminimalviewinfo-から-viewfamily-の構築" data-v-6f1598ec><a href="#%E3%82%AB%E3%83%A1%E3%83%A9%E8%A8%AD%E5%AE%9A-fminimalviewinfo-%E3%81%8B%E3%82%89-viewfamily-%E3%81%AE%E6%A7%8B%E7%AF%89" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>カメラ設定 (FMinimalViewInfo) から ViewFamily の構築</h2>
<p data-v-6f1598ec>UE では、描画には ViewFamily という構造体が必要です。今回作成したレンダラでも、共通した ViewFamily の設定に基づいて描画を行うように実装していました。
ViewFamily を構築するにあたっても、よく利用するカメラ設定と共通の項目で設定できたほうが便利です。そこで、 <code data-v-6f1598ec>FMinimalViewInfo</code> という構造体を設定項目として受け付けるようにしました。</p>
<p data-v-6f1598ec><code data-v-6f1598ec>FMimalViewInfo</code> も UE が提供している View 設定の構造体で、以下のような内容を持ちます。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>struct</span> <span class="token class-name" data-v-6f1598ec>FMinimalViewInfo</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token function" data-v-6f1598ec>GENERATED_USTRUCT_BODY</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span>

	<span class="token comment" data-v-6f1598ec>/** Location */</span>
	<span class="token function" data-v-6f1598ec>UPROPERTY</span><span class="token punctuation" data-v-6f1598ec>(</span>EditAnywhere<span class="token punctuation" data-v-6f1598ec>,</span> BlueprintReadWrite<span class="token punctuation" data-v-6f1598ec>,</span> Category<span class="token operator" data-v-6f1598ec>=</span>Camera<span class="token punctuation" data-v-6f1598ec>)</span>
	FVector Location<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/** Rotation */</span>
	<span class="token function" data-v-6f1598ec>UPROPERTY</span><span class="token punctuation" data-v-6f1598ec>(</span>EditAnywhere<span class="token punctuation" data-v-6f1598ec>,</span> BlueprintReadWrite<span class="token punctuation" data-v-6f1598ec>,</span> Category<span class="token operator" data-v-6f1598ec>=</span>Camera<span class="token punctuation" data-v-6f1598ec>)</span>
	FRotator Rotation<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/** The horizontal field of view (in degrees) in perspective mode (ignored in orthographic mode). */</span>
	<span class="token function" data-v-6f1598ec>UPROPERTY</span><span class="token punctuation" data-v-6f1598ec>(</span>EditAnywhere<span class="token punctuation" data-v-6f1598ec>,</span> BlueprintReadWrite<span class="token punctuation" data-v-6f1598ec>,</span> Category<span class="token operator" data-v-6f1598ec>=</span>Camera<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token keyword" data-v-6f1598ec>float</span> FOV<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/** The originally desired horizontal field of view before any adjustments to account for different aspect ratios */</span>
	<span class="token function" data-v-6f1598ec>UPROPERTY</span><span class="token punctuation" data-v-6f1598ec>(</span>Transient<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token keyword" data-v-6f1598ec>float</span> DesiredFOV<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/** The desired width (in world units) of the orthographic view (ignored in Perspective mode) */</span>
	<span class="token function" data-v-6f1598ec>UPROPERTY</span><span class="token punctuation" data-v-6f1598ec>(</span>EditAnywhere<span class="token punctuation" data-v-6f1598ec>,</span> BlueprintReadWrite<span class="token punctuation" data-v-6f1598ec>,</span> Category<span class="token operator" data-v-6f1598ec>=</span>Camera<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token keyword" data-v-6f1598ec>float</span> OrthoWidth<span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token punctuation" data-v-6f1598ec>.</span><span class="token punctuation" data-v-6f1598ec>.</span><span class="token punctuation" data-v-6f1598ec>.</span> 以下省略
</code></pre></div>
<p data-v-6f1598ec>このように、よく見る UE のカメラ設定と同じような項目を持っていることがわかります。</p>
<h3 id="utinyrendererrenderer" data-v-6f1598ec><a href="#utinyrendererrenderer" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>UTinyRenderer::Renderer</h3>
<p data-v-6f1598ec>UTinyRenderer は、内部で FTinyRenderer オブジェクトを保持しています。 UTinyRenderer::Renderer では FTinyRenderer の Render を呼び出すことで描画を行いますが、それ以外にも ViewFamily の初期化や RDGBuilder の作成と実行といった重要な処理を行っています。</p>
<div class="remark-highlight" data-v-6f1598ec><pre class="language-cpp" data-v-6f1598ec><code class="language-cpp" data-v-6f1598ec><span class="token keyword" data-v-6f1598ec>void</span> <span class="token class-name" data-v-6f1598ec>UTinyRenderer</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>Render</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span>
<span class="token punctuation" data-v-6f1598ec>{</span>
	<span class="token function" data-v-6f1598ec>SCOPED_NAMED_EVENT</span><span class="token punctuation" data-v-6f1598ec>(</span>UTinyRenderer_Render<span class="token punctuation" data-v-6f1598ec>,</span> FColor<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Green<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	
	<span class="token keyword" data-v-6f1598ec>if</span> <span class="token punctuation" data-v-6f1598ec>(</span><span class="token operator" data-v-6f1598ec>!</span>StaticMesh <span class="token operator" data-v-6f1598ec>||</span> <span class="token operator" data-v-6f1598ec>!</span>RenderTarget<span class="token punctuation" data-v-6f1598ec>)</span>
	<span class="token punctuation" data-v-6f1598ec>{</span>
		<span class="token function" data-v-6f1598ec>UE_LOG</span><span class="token punctuation" data-v-6f1598ec>(</span>LogTemp<span class="token punctuation" data-v-6f1598ec>,</span> Warning<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token function" data-v-6f1598ec>TEXT</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"UStaticMeshRenderBP::RenderStaticMesh: Invalid parameters"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token keyword" data-v-6f1598ec>return</span><span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token punctuation" data-v-6f1598ec>}</span>

	<span class="token comment" data-v-6f1598ec>/* RenderTaget から 描画リソースを取得 */</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FTextureRenderTargetResource<span class="token operator" data-v-6f1598ec>*</span> RenderTargetResource <span class="token operator" data-v-6f1598ec>=</span> RenderTarget<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>GameThread_GetRenderTargetResource</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>


	<span class="token comment" data-v-6f1598ec>/* ViewFamily オブジェクトの作成 */</span>
	FSceneViewFamily<span class="token punctuation double-colon" data-v-6f1598ec>::</span>ConstructionValues <span class="token function" data-v-6f1598ec>ConstructionValues</span><span class="token punctuation" data-v-6f1598ec>(</span>RenderTargetResource<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token keyword" data-v-6f1598ec>nullptr</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token function" data-v-6f1598ec>FEngineShowFlags</span><span class="token punctuation" data-v-6f1598ec>(</span>ESFIM_Game<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	ConstructionValues<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetTime</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token class-name" data-v-6f1598ec>FGameTime</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>GetTimeSinceAppStart</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	TUniquePtr<span class="token operator" data-v-6f1598ec>&lt;</span>FSceneViewFamilyContext<span class="token operator" data-v-6f1598ec>></span> ViewFamily <span class="token operator" data-v-6f1598ec>=</span> <span class="token generic-function" data-v-6f1598ec><span class="token function" data-v-6f1598ec>MakeUnique</span><span class="token class-name generic" data-v-6f1598ec><span class="token operator" data-v-6f1598ec>&lt;</span>FSceneViewFamilyContext<span class="token operator" data-v-6f1598ec>></span></span></span><span class="token punctuation" data-v-6f1598ec>(</span>ConstructionValues<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* ScreenPercentage の無効化 */</span>
	ViewFamily<span class="token operator" data-v-6f1598ec>-></span>EngineShowFlags<span class="token punctuation" data-v-6f1598ec>.</span>ScreenPercentage <span class="token operator" data-v-6f1598ec>=</span> <span class="token boolean" data-v-6f1598ec>false</span><span class="token punctuation" data-v-6f1598ec>;</span>
	ViewFamily<span class="token operator" data-v-6f1598ec>-></span><span class="token function" data-v-6f1598ec>SetScreenPercentageInterface</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token keyword" data-v-6f1598ec>new</span> <span class="token function" data-v-6f1598ec>FLegacyScreenPercentageDriver</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token operator" data-v-6f1598ec>*</span>ViewFamily<span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>1.0f</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token comment" data-v-6f1598ec>/* MinimalViewInfo から ViewInitOptions を作成 */</span>
	<span class="token keyword" data-v-6f1598ec>const</span> FIntRect <span class="token function" data-v-6f1598ec>ViewRect</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> RenderTarget<span class="token operator" data-v-6f1598ec>-></span>SizeX<span class="token punctuation" data-v-6f1598ec>,</span> RenderTarget<span class="token operator" data-v-6f1598ec>-></span>SizeY<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	FSceneViewInitOptions ViewInitOptions<span class="token punctuation" data-v-6f1598ec>;</span>
	ViewInitOptions<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetViewRectangle</span><span class="token punctuation" data-v-6f1598ec>(</span>ViewRect<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	ViewInitOptions<span class="token punctuation" data-v-6f1598ec>.</span>ViewFamily <span class="token operator" data-v-6f1598ec>=</span> ViewFamily<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Get</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	ViewInitOptions<span class="token punctuation" data-v-6f1598ec>.</span>ViewOrigin <span class="token operator" data-v-6f1598ec>=</span> ViewInfo<span class="token punctuation" data-v-6f1598ec>.</span>Location<span class="token punctuation" data-v-6f1598ec>;</span>
	ViewInitOptions<span class="token punctuation" data-v-6f1598ec>.</span>ViewRotationMatrix <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>FMatrix</span><span class="token punctuation" data-v-6f1598ec>(</span>
		<span class="token punctuation" data-v-6f1598ec>{</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token punctuation" data-v-6f1598ec>{</span><span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token punctuation" data-v-6f1598ec>{</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>,</span>
		<span class="token punctuation" data-v-6f1598ec>{</span><span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>0</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token number" data-v-6f1598ec>1</span><span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
	ViewInitOptions<span class="token punctuation" data-v-6f1598ec>.</span>FOV <span class="token operator" data-v-6f1598ec>=</span> ViewInfo<span class="token punctuation" data-v-6f1598ec>.</span>FOV<span class="token punctuation" data-v-6f1598ec>;</span>
	ViewInitOptions<span class="token punctuation" data-v-6f1598ec>.</span>DesiredFOV <span class="token operator" data-v-6f1598ec>=</span> ViewInfo<span class="token punctuation" data-v-6f1598ec>.</span>FOV<span class="token punctuation" data-v-6f1598ec>;</span>
	<span class="token comment" data-v-6f1598ec>/* 投影行列を計算し、ViewInitOptions に設定 */</span>
	<span class="token class-name" data-v-6f1598ec>FMinimalViewInfo</span><span class="token punctuation double-colon" data-v-6f1598ec>::</span><span class="token function" data-v-6f1598ec>CalculateProjectionMatrixGivenViewRectangle</span><span class="token punctuation" data-v-6f1598ec>(</span>ViewInfo<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                              AspectRatio_MaintainYFOV<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                              ViewRect<span class="token punctuation" data-v-6f1598ec>,</span>
	                                                              ViewInitOptions<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

	<span class="token function" data-v-6f1598ec>ENQUEUE_RENDER_COMMAND</span><span class="token punctuation" data-v-6f1598ec>(</span>FStaticMeshRenderCommand<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>(</span>
		<span class="token punctuation" data-v-6f1598ec>[</span>ViewFamily <span class="token operator" data-v-6f1598ec>=</span> <span class="token function" data-v-6f1598ec>MoveTemp</span><span class="token punctuation" data-v-6f1598ec>(</span>ViewFamily<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> LODIndex <span class="token operator" data-v-6f1598ec>=</span> LODIndex<span class="token punctuation" data-v-6f1598ec>,</span> ViewInitOptions<span class="token punctuation" data-v-6f1598ec>,</span> StaticMesh <span class="token operator" data-v-6f1598ec>=</span> StaticMesh<span class="token punctuation" data-v-6f1598ec>,</span> MeshTransform <span class="token operator" data-v-6f1598ec>=</span> Transform<span class="token punctuation" data-v-6f1598ec>]</span><span class="token punctuation" data-v-6f1598ec>(</span>
		FRHICommandListImmediate<span class="token operator" data-v-6f1598ec>&</span> RHICmdList<span class="token punctuation" data-v-6f1598ec>)</span> <span class="token keyword" data-v-6f1598ec>mutable</span>
		<span class="token punctuation" data-v-6f1598ec>{</span>
			<span class="token function" data-v-6f1598ec>SCOPED_NAMED_EVENT</span><span class="token punctuation" data-v-6f1598ec>(</span>FStaticMeshRenderCommand_Render<span class="token punctuation" data-v-6f1598ec>,</span> FColor<span class="token punctuation double-colon" data-v-6f1598ec>::</span>Green<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

			<span class="token comment" data-v-6f1598ec>/* TinyRenderer オブジェクトの作成 */</span>
			FTinyRenderer <span class="token function" data-v-6f1598ec>Renderer</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token operator" data-v-6f1598ec>*</span>ViewFamily<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
			<span class="token comment" data-v-6f1598ec>/* RenderThread で ViewFamily の初期化を完了 */</span>
			<span class="token function" data-v-6f1598ec>GetRendererModule</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>CreateAndInitSingleView</span><span class="token punctuation" data-v-6f1598ec>(</span>RHICmdList<span class="token punctuation" data-v-6f1598ec>,</span> ViewFamily<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Get</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span> <span class="token operator" data-v-6f1598ec>&</span>ViewInitOptions<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

			<span class="token comment" data-v-6f1598ec>/* RDGBuilder の作成 */</span>
			FRDGBuilder <span class="token function" data-v-6f1598ec>GraphBuilder</span><span class="token punctuation" data-v-6f1598ec>(</span>RHICmdList<span class="token punctuation" data-v-6f1598ec>,</span>
			                         <span class="token function" data-v-6f1598ec>RDG_EVENT_NAME</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token string" data-v-6f1598ec>"StaticMeshRender"</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>,</span>
			                         ERDGBuilderFlags<span class="token punctuation double-colon" data-v-6f1598ec>::</span>AllowParallelExecute<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
			<span class="token comment" data-v-6f1598ec>/* StaticMesh の設定 */</span>
			Renderer<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>SetStaticMesh</span><span class="token punctuation" data-v-6f1598ec>(</span>StaticMesh<span class="token punctuation" data-v-6f1598ec>,</span> LODIndex<span class="token punctuation" data-v-6f1598ec>,</span> MeshTransform<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>ToMatrixWithScale</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
			
			<span class="token comment" data-v-6f1598ec>/* 作成したレンダラによる描画処理の登録 */</span>
			Renderer<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Render</span><span class="token punctuation" data-v-6f1598ec>(</span>GraphBuilder<span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>

			<span class="token comment" data-v-6f1598ec>/* RDGBuilder による RHI コマンドの発行と実行 */</span>
			GraphBuilder<span class="token punctuation" data-v-6f1598ec>.</span><span class="token function" data-v-6f1598ec>Execute</span><span class="token punctuation" data-v-6f1598ec>(</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
		<span class="token punctuation" data-v-6f1598ec>}</span><span class="token punctuation" data-v-6f1598ec>)</span><span class="token punctuation" data-v-6f1598ec>;</span>
<span class="token punctuation" data-v-6f1598ec>}</span>
</code></pre></div>
<p data-v-6f1598ec>BP から設定された MinimalViewInfo には、投影モードや FOV などの情報が含まれています。これをもとに、 FSceneViewInitOptions という View 初期化オプション構造体を作成します。一部は手動で設定する必要がありますが、投影行列の計算といった複雑な部分は <code data-v-6f1598ec>FMinimalViewInfo::CalculateProjectionMatrixGivenViewRectangle</code> を使って自動的に設定することができます。
また、これを利用することによって、UE のカメラと同じような挙動をさせることができます。</p>
<p data-v-6f1598ec><code data-v-6f1598ec>ENQUEUE_RENDER_COMMAND</code> マクロで囲まれた部分は、次の RenderThread 処理で実行するように予約される部分です。 ViewFamily の完全な初期化は RenderThread で行う必要があるため、こちらで書かれています。</p>
<p data-v-6f1598ec>また、RGDBuilder や FTinyRenderer のオブジェクトもここで作成しています。これらは毎フレーム作成され、フレームの終了で破棄されるということです。
最後には RDGBuilder に登録された描画処理を下に RHI コマンドの発行が行われます。
このように見ると、今回書いたレンダラは RDGBuilder に描画処理の登録を行うものであり、実際のコマンドの発行は RDGBuilder に任せていることがよくわかります。パスに関わるコマンドが一度 RDGBuilder に登録され、最後にまとめてコマンドを発行する仕組みになっていることで、不要な処理の最適化や、任意のリソースがどの期間存在していなければならないかの決定をすることができるのです。</p>
<h1 id="パフォーマンスの検証" data-v-6f1598ec><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E6%A4%9C%E8%A8%BC" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>パフォーマンスの検証</h1>
<p data-v-6f1598ec>簡単にですが、作成したレンダラのパフォーマンスを検証してみます。</p>
<p data-v-6f1598ec>以下の3つを比較してみます。</p>
<ol data-v-6f1598ec>
<li data-v-6f1598ec>SceneCaptureComponent2D による描画 (よくやるやつ)</li>
<li data-v-6f1598ec>以前作成した FPreviewScene による描画</li>
<li data-v-6f1598ec>今回作成した単一パスレンダラ(TinyRenderer)の描画</li>
</ol>
<p data-v-6f1598ec>その他詳細は以下のとおりです。</p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>Win64 Development Build</li>
<li data-v-6f1598ec>描画サイズは 500x500 で描画</li>
<li data-v-6f1598ec>サンプルのメッシュは
<ul data-v-6f1598ec>
<li data-v-6f1598ec>Triangles: 19382</li>
<li data-v-6f1598ec>Vertices: 11556</li>
<li data-v-6f1598ec>Materials: 1</li>
</ul>
</li>
<li data-v-6f1598ec>SceneCapture2D は SceneColor with SceneDepth をキャプチャし、マテリアルを使って深度で背景抜き。</li>
<li data-v-6f1598ec>FPreviewScene は FPreviewScene でレンダリング後、背景抜き。</li>
<li data-v-6f1598ec>TinyRenderer レンダリングしてそのまま表示 (RenderTarget の ClearColor を透明にしているので背景が描画されず、抜く必要がない)</li>
</ul>
<p data-v-6f1598ec>セットアップが雑で(特に SceneCapture2D は制御がしにくいため)少しずつ見た目が違いますが、調整すればほぼ同じ見た目にすることは可能と思われます。</p>
<h2 id="比較" data-v-6f1598ec><a href="#%E6%AF%94%E8%BC%83" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>比較</h2>
<p data-v-6f1598ec>検証環境は以下のとおりです。</p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec>CPU: Ryzen 9 3900X 12-Core Processor</li>
<li data-v-6f1598ec>RAM: 128GB</li>
<li data-v-6f1598ec>GPU: GeForce RTX 3080 10GB</li>
</ul>
<h3 id="nsight-graphics-の-scrubber-を眺める" data-v-6f1598ec><a href="#nsight-graphics-%E3%81%AE-scrubber-%E3%82%92%E7%9C%BA%E3%82%81%E3%82%8B" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>Nsight Graphics の Scrubber を眺める</h3>
<p data-v-6f1598ec>まずは、こんな比較画面のフレームを計測してみます。
<img alt="" src="/article-assets/unrealengine/lets-implement-a-single-mesh-renderer-3//compare.png" data-v-6f1598ec>
ViewportSize: 1920x1080</p>
<p data-v-6f1598ec>Nsight Graphics の Scrubber を使って、フレーム内の描画処理を見てみます。
<img alt="" src="/article-assets/unrealengine/lets-implement-a-single-mesh-renderer-3//nsight-scrubber.png" data-v-6f1598ec></p>
<p data-v-6f1598ec>注意: この横軸は時間ではありません。</p>
<ul data-v-6f1598ec>
<li data-v-6f1598ec><b style="color:#00f" data-v-6f1598ec>青領域</b>: メインのViewportの描画処理</li>
<li data-v-6f1598ec><b style="color:red" data-v-6f1598ec>赤領域</b>: SceneCapture2D による描画処理</li>
<li data-v-6f1598ec><b style="color:#ff0" data-v-6f1598ec>黃領域</b>: FPreviewScene による描画処理</li>
<li data-v-6f1598ec><b style="color:green" data-v-6f1598ec>緑領域</b>: TinyRenderer による描画処理</li>
</ul>
<p data-v-6f1598ec>なんというか、驚異的です。メインの Viewport が最も大きな部分を占めているのは当然として、SceneCaptrue2D と FPreviewScene もそれなりに目立つ大きさで表示されています。また、処理内容としてもメインの Viewport と類似していて、Scene に対する一通りの描画処理が行われていそうなことがわかります。</p>
<p data-v-6f1598ec>いっぽう、TinyRenderer はもはや Scrubber 上ではほとんど見えないほどに小さな処理で済んでいることが伺えます。</p>
<h3 id="フレーム内処理時間の比較" data-v-6f1598ec><a href="#%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E5%86%85%E5%87%A6%E7%90%86%E6%99%82%E9%96%93%E3%81%AE%E6%AF%94%E8%BC%83" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>フレーム内処理時間の比較</h3>
<p data-v-6f1598ec>次に、各描画処理の処理時間を比較してみます。</p>






























<table data-v-6f1598ec><thead data-v-6f1598ec><tr data-v-6f1598ec><th data-v-6f1598ec>描画手法</th><th data-v-6f1598ec>処理時間</th><th data-v-6f1598ec>フレーム内における割合</th></tr></thead><tbody data-v-6f1598ec><tr data-v-6f1598ec><td data-v-6f1598ec>SceneCapture2D</td><td data-v-6f1598ec>4.12 ms</td><td data-v-6f1598ec>17.4 %</td></tr><tr data-v-6f1598ec><td data-v-6f1598ec>FPreviewScene</td><td data-v-6f1598ec>1.11 ms</td><td data-v-6f1598ec>4.7 %</td></tr><tr data-v-6f1598ec><td data-v-6f1598ec>TinyRenderer</td><td data-v-6f1598ec>0.02 ms (16.38 μs)</td><td data-v-6f1598ec>0.1 %</td></tr><tr data-v-6f1598ec><td data-v-6f1598ec>メインの Viewport(参考)</td><td data-v-6f1598ec>約 13 ms</td><td data-v-6f1598ec>約 55 %</td></tr></tbody></table>
<p data-v-6f1598ec>処理速度の面でも TinyRenderer が優位に立っています。また、詳しく計測していませんが、TinyRenderer は描画先の RenderTarget と Depth しか利用しないので、リソース面の優位性もあると思われます。</p>
<p data-v-6f1598ec><strong data-v-6f1598ec>もちろん、他の描画手法も BasePass の該当メッシュの描画処理だけ抜き出せば TinyRenderer と同等程度の処理時間しかかかっていません。</strong> 冒頭の繰り返しになりますが、TinyRenderer は凄いことをしているわけではありません。 ただ、なにぶん標準の方法は単一メッシュ描画には不要な処理がほとんどすべてを占めてしまっており、それらを局所的に OFF にしたりすることにも限界があるため、全体としての処理時間が大きくなってしまっているのです。</p>
<h3 id="いっぱい描画したときの-fps-の比較" data-v-6f1598ec><a href="#%E3%81%84%E3%81%A3%E3%81%B1%E3%81%84%E6%8F%8F%E7%94%BB%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE-fps-%E3%81%AE%E6%AF%94%E8%BC%83" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>いっぱい描画したときの FPS の比較</h3>
<p data-v-6f1598ec>この比較は FPreviewScene と TinyRenderer のみを対象に行いました。
SceneCapture2D は描画したい数だけレベル上に Actor を配置する必要があるので、そもそも個別にメッシュを大量にレンダリングするのが大変すぎて検証からはずしました。</p>
<p data-v-6f1598ec>画面は以下のように、10x10 で 100 個の StaticMesh を個別に描画し、毎フレーム描画するようにしました。</p>
<p data-v-6f1598ec><img alt="" src="/article-assets/unrealengine/lets-implement-a-single-mesh-renderer-3//10x10.png" data-v-6f1598ec></p>
<p data-v-6f1598ec>以下が FPS の比較結果です。</p>





















<table data-v-6f1598ec><thead data-v-6f1598ec><tr data-v-6f1598ec><th data-v-6f1598ec>描画手法</th><th data-v-6f1598ec>平均 FPS</th></tr></thead><tbody data-v-6f1598ec><tr data-v-6f1598ec><td data-v-6f1598ec>TinyRenderer</td><td data-v-6f1598ec>43.0 FPS</td></tr><tr data-v-6f1598ec><td data-v-6f1598ec>FPreviewScene</td><td data-v-6f1598ec>2.2 FPS</td></tr><tr data-v-6f1598ec><td data-v-6f1598ec>SceneCapture2D</td><td data-v-6f1598ec>100 個配置してRenderTarget設定するやつ作るの面倒すぎて検証してない</td></tr></tbody></table>
<p data-v-6f1598ec>やはり、 FPS にも大きな差が出ました。TinyRenderer は 2万ポリゴン近いメッシュを 100 個描画しても 40 FPS 程度で安定しているので、軽量なメッシュをインベントリで並べて表示するくらいの用途では十分な速度が得られると思われます。
いっぽう、 <a href="https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer/#%E7%8B%AC%E8%87%AA%E3%81%AE%E5%B0%82%E7%94%A8%E3%82%B7%E3%83%BC%E3%83%B3%E3%82%92%E7%94%A8%E6%84%8F%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%8B" rel="nofollow noopener noreferrer" target="_blank" data-v-6f1598ec>FPreviewScene</a> は設定によって SceneCapture2D よりは軽量であるはずですが、実用的な速度にはなりませんでした。</p>
<h1 id="さらなる改善可能性" data-v-6f1598ec><a href="#%E3%81%95%E3%82%89%E3%81%AA%E3%82%8B%E6%94%B9%E5%96%84%E5%8F%AF%E8%83%BD%E6%80%A7" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>さらなる改善可能性</h1>
<h2 id="opaque-以外の-blendmode-の対応" data-v-6f1598ec><a href="#opaque-%E4%BB%A5%E5%A4%96%E3%81%AE-blendmode-%E3%81%AE%E5%AF%BE%E5%BF%9C" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>Opaque 以外の BlendMode の対応</h2>
<p data-v-6f1598ec>現在、TinyRenderer は Opaque な BlendMode のマテリアルのみをサポートしています。半透明等の BlendMode もサポートするためには、ピクセルシェーダーの実装を変更する必要があります。</p>
<h2 id="ライティングの拡張" data-v-6f1598ec><a href="#%E3%83%A9%E3%82%A4%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E6%8B%A1%E5%BC%B5" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>ライティングの拡張</h2>
<p data-v-6f1598ec>現在は一つの DirectionalLight のみをサポートしています。また、パラメータも固定されています。ピクセルシェーダーの変更によって、複数のライトやポイントライト、スポットライトなどのライトのサポートを追加することができます。</p>
<h2 id="shader-permutaion-の最適化" data-v-6f1598ec><a href="#shader-permutaion-%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>Shader Permutaion の最適化</h2>
<p data-v-6f1598ec>TinyRenderer のための MeshMaterialShader は、TinyRenderer で描画を行わないマテリアルなどに対しても組み合わせが作成されてしまいます。</p>
<p data-v-6f1598ec>何らかの方法で、TinyRenderer で利用したいマテリアルのみを設定できれば、TinyRenderer のためにシェーダーコンパイル時間が伸びる懸念を解消できますし、レンダラのシェーダーを変更したときの作業のイテレーションも早くなります。</p>
<h2 id="パフォーマンスの改善" data-v-6f1598ec><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E6%94%B9%E5%96%84" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>パフォーマンスの改善</h2>
<p data-v-6f1598ec>すでに十分に高速ではありますが、主に CPU 側での描画コマンドの発行についてはまだ最適化の余地があります。というのも、現在の実装では毎フレーム MeshBatch や MeshDrawCommand の作成を1から行っています。
これらについては、フレームをまたいで再利用を行う実装を考えることは十分に可能であり、(実際にエンジンの StaticMesh を使ったシーン描画はそのようになっており)、さらなるパフォーマンスの向上が期待できます。</p>
<h1 id="まとめ" data-v-6f1598ec><a href="#%E3%81%BE%E3%81%A8%E3%82%81" aria-hidden="true" tabindex="-1" data-v-6f1598ec><span class="icon icon-link" data-v-6f1598ec></span></a>まとめ</h1>
<p data-v-6f1598ec>今回の記事では、シンプルな StaticMesh レンダラである TinyRenderer の紹介と、その実装方法について解説しました。TinyRenderer は目的のために必要なこと以外を何もしないことで高速に動作します。
UE の RHI や RDG、マテリアルといったグラフィックス機能は、エディタの背後で動くだけでなく、プラグイン実装のために柔軟に利用することができます。TinyRenderer の実装も、それらのお陰でかなりシンプルに実現されています。</p>
<p data-v-6f1598ec>記事内でも触れましたが、TinyRenderer はあくまで単一メッシュの描画に特化したものであり、複数のメッシュやライト、半透明などの複雑な描画を行う場合には、通常の UE の描画パスを利用することが望ましいです。また、見た目に関しても通常の UE の描画パスとは完全に一致するわけではないため、その点も注意が必要です。
単純に BP から制御してメッシュ描画を行いたい場合には、 FPreviewScene などの手法を取るのが適切と言えます。いくつかの個数のメッシュを少し表示したいだけであれば、 SceneCapture2D で頑張るのでも十分でしょう。</p>
<p data-v-6f1598ec>現時点では、技術的には可能でも実装していないことも多数あるため、今後気が向いたら改善していくかもしれません。よければ改造して遊んでみたり、Issue や PR を投げてもらえると楽しいので助かります。</p></div></div></div></article> <section data-v-6bc0f40a data-v-2f2c1355><h2 data-v-6bc0f40a>share</h2> <ul class="share-list" data-v-6bc0f40a><li data-v-6bc0f40a><a href="https://twitter.com/share?
url=https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-3&
text=単一Static Meshレンダラを独自メッシュパスで実装する&
via=strvert" rel="nofollow" target="_blank" data-v-6bc0f40a><span class="im icon" data-v-6bc0f40a></span></a></li> <li data-v-6bc0f40a><a href="http://www.facebook.com/share.php?u=https://strv.dev/blog/unrealengine--lets-implement-a-single-mesh-renderer-3" rel="nofollow" target="_blank" data-v-6bc0f40a><span class="im icon" data-v-6bc0f40a></span></a></li></ul></section> <div class="surround-menu" data-v-6f1598ec data-v-2f2c1355><section data-fetch-key="data-v-08b63208:0" class="wrapper" data-v-08b63208 data-v-2f2c1355><div class="prev button" data-v-08b63208><!----></div> <div class="seriesname button" data-v-08b63208><a href="/blog/series/undefined" data-v-08b63208>
      
    </a></div> <div class="next button" data-v-08b63208><!----></div></section></div> <article class="giscus-wrapper" data-v-6f1598ec data-v-2f2c1355><div data-v-2f2c1355><div class="giscus"></div></div></article></div></div></div></div></main> <div class="footer-wrapper" data-v-194ed6b2 data-v-32d9e426><footer class="footer-main" data-v-194ed6b2><section class="contact" data-v-b716246c data-v-194ed6b2><h2 data-v-b716246c>コンタクト</h2> <address data-v-b716246c><p data-v-b716246c><span class="im icon" data-v-b716246c></span> <span data-v-b716246c><a href="https://github.com/strvert" class="display" data-v-b716246c>strvert</a></span></p><p data-v-b716246c><span class="im icon" data-v-b716246c></span> <span data-v-b716246c><a href="https://twitter.com/strvert" class="display" data-v-b716246c>@strvert</a></span></p><p data-v-b716246c><span class="im icon" data-v-b716246c></span> <span class="display" data-v-b716246c><div class="container msgbox" data-v-e0d516b2 data-v-753eb174 data-v-4e732b52 data-v-b716246c><div class="msgbox hide" data-v-e0d516b2><span data-v-e0d516b2>コピー完了！</span></div> <div data-v-e0d516b2><div class="content" data-v-e0d516b2 data-v-753eb174><span data-v-e0d516b2 data-v-4e732b52><span class="head" data-v-e0d516b2 data-v-4e732b52>strv</span><span class="tail" data-v-e0d516b2 data-v-4e732b52>strv.dev</span></span></div></div></div></span></p></address></section> <div class="infos" data-v-194ed6b2><p data-v-194ed6b2><span class="copyright" data-v-194ed6b2>© 2021 stonriver (Riku Ishikawa).</span></p></div></footer></div></div></div></div><script defer src="/_nuxt/static/1712758369/blog/unrealengine--lets-implement-a-single-mesh-renderer-3/state.js"></script><script src="/_nuxt/runtime.451661d.js" defer></script><script src="/_nuxt/pages/blog/_blogpost.970c9d9.js" defer></script><script src="/_nuxt/components/atoms-blogpost-frame.b3ab725.js" defer></script><script src="/_nuxt/commons/app.98a0816.js" defer></script><script src="/_nuxt/vendors/app.070d0bc.js" defer></script><script src="/_nuxt/app.541b271.js" defer></script>
  </body>
</html>
